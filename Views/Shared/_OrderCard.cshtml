@model MonAmour.ViewModels.OrderSummaryUserViewModel

@functions {
    string StatusBadgeClass(string status)
    {
        switch ((status ?? "").ToLowerInvariant())
        {
            case "confirmed": return "bg-blue-50 text-blue-700 border-blue-200";
            case "shipping": return "bg-amber-50 text-amber-700 border-amber-200";
            case "completed": return "bg-emerald-50 text-emerald-700 border-emerald-200";
            case "canceled": return "bg-rose-50 text-rose-700 border-rose-200";
            default: return "bg-muted text-foreground border-border";
        }
    }
}

<div class="bg-card border border-border rounded-lg p-5 flex flex-col gap-4">
    <div class="flex items-center justify-between gap-4">
        <div>
            <div class="text-sm text-muted-foreground">@Model.OrderDate.ToString("dd/MM/yyyy")</div>
            <div class="text-base font-semibold">@Model.OrderNumber</div>
        </div>
        <div class="text-xs px-3 py-1 rounded-full border font-medium @StatusBadgeClass(Model.Status)">
            @Model.Status
        </div>
    </div>

    <div class="divide-y divide-border rounded-md border border-border overflow-hidden">
        @foreach (var item in Model.Items)
        {
            <div class="flex items-center justify-between p-4">
                <div>
                    <div class="text-sm font-medium">@item.Name</div>
                    <div class="text-xs text-muted-foreground">@item.ItemType • SL: @item.Quantity</div>
                </div>
                <div class="text-sm font-semibold">@String.Format("{0:#,##0}₫", item.TotalPrice)</div>
            </div>
        }
    </div>

    <div class="flex items-center justify-between text-sm">
        <div class="text-muted-foreground">Tổng cộng</div>
        <div class="font-semibold">@String.Format("{0:#,##0}₫", Model.TotalAmount)</div>
    </div>

    @if (Model.CanReview)
    {
        <div class="flex justify-end">
            <button type="button"
                    class="px-4 py-2 bg-primary text-primary-foreground rounded text-sm"
                    onclick="document.getElementById('reviewModal-@Model.OrderNumber').classList.remove('hidden')">
                @(Model.HasReview ? "Chỉnh sửa đánh giá" : "Viết đánh giá")
            </button>
        </div>
    }
</div>

@if (Model.CanReview)
{
    <!-- Modal -->
    <div id="reviewModal-@Model.OrderNumber"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
            <h3 class="text-lg font-semibold mb-4">@(Model.HasReview ? "Chỉnh sửa đánh giá" : "Đánh giá sản phẩm")</h3>
            <form asp-action="@(Model.HasReview ? "UpdateReview" : "SubmitReview")" asp-controller="Profile" method="post" class="space-y-3">
                @Html.AntiForgeryToken()
                @if (Model.HasReview)
                {
                    <input type="hidden" name="reviewId" value="@Model.ReviewId" />
                }
                else
                {
                    <input type="hidden" name="targetType" value="@(Model.Items.Any() ? Model.Items.First().ItemType : "Product")" />
                    <input type="hidden" name="targetId" value="@(Model.Items.Any() ? Model.Items.First().TargetId : 0)" />
                }

                <div class="flex items-center gap-2">
                    <label class="text-sm">Đánh giá:</label>
                    <select name="rating" class="border border-border rounded px-2 py-1 text-sm" required>
                        <option value="">Chọn</option>
                        <option value="1">1 ⭐</option>
                        <option value="2">2 ⭐⭐</option>
                        <option value="3">3 ⭐⭐⭐</option>
                        <option value="4">4 ⭐⭐⭐⭐</option>
                        <option value="5">5 ⭐⭐⭐⭐⭐</option>
                    </select>
                </div>

                <div>
                    <textarea name="comment" rows="3" class="w-full border border-border rounded px-3 py-2 text-sm" placeholder="Viết cảm nhận của bạn (không bắt buộc)"></textarea>
                </div>

                <div class="flex justify-end gap-2">
                    <button type="button"
                            class="px-4 py-2 border rounded text-sm"
                            onclick="document.getElementById('reviewModal-@Model.OrderNumber').classList.add('hidden')">
                        Hủy
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary text-primary-foreground rounded text-sm">
                        Gửi
                    </button>
                </div>
            </form>
        </div>
    </div>
}
