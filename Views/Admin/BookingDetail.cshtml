@model MonAmour.ViewModels.BookingDetailViewModel

@{
    ViewData["Title"] = "Chi tiết đặt chỗ";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-calendar-check me-2"></i>
                        Chi tiết đặt chỗ #@Model.BookingId
                    </h4>
                    <div class="d-flex gap-2">
                        <a href="@Url.Action("Bookings", "Admin")" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>
                            Quay lại
                        </a>
                        <a href="@Url.Action("EditBooking", "Admin", new { id = Model.BookingId })" class="btn btn-primary">
                            <i class="fas fa-edit me-1"></i>
                            Chỉnh sửa
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Booking Information -->
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Thông tin đặt chỗ
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">ID đặt chỗ:</label>
                                                <p class="form-control-plaintext">#@Model.BookingId</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Ngày đặt:</label>
                                                <p class="form-control-plaintext">@(Model.BookingDate?.ToString("dd/MM/yyyy") ?? "N/A")</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Giờ đặt:</label>
                                                <p class="form-control-plaintext">@(Model.BookingTime?.ToString("HH:mm") ?? "N/A")</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Tổng tiền:</label>
                                                <p class="form-control-plaintext text-success fw-bold">
                                                    @if (Model.TotalPrice.HasValue)
                                                    {
                                                        <text>@(Model.TotalPrice.Value.ToString("N0")) VNĐ</text>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">N/A</span>
                                                    }
                                                </p>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Trạng thái:</label>
                                                <p class="form-control-plaintext">
                                                    @{
                                                        var statusClass = Model.Status switch
                                                        {
                                                            "pending" => "badge-warning",
                                                            "confirmed" => "badge-success",
                                                            "cancelled" => "badge-danger",
                                                            "completed" => "badge-info",
                                                            _ => "badge-secondary"
                                                        };
                                                        var statusText = Model.Status switch
                                                        {
                                                            "pending" => "Chờ xác nhận",
                                                            "confirmed" => "Đã xác nhận",
                                                            "cancelled" => "Đã hủy",
                                                            "completed" => "Hoàn thành",
                                                            _ => Model.Status ?? "N/A"
                                                        };
                                                    }
                                                    <span class="badge @statusClass fs-6">@statusText</span>
                                                </p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Trạng thái thanh toán:</label>
                                                <p class="form-control-plaintext">
                                                    @{
                                                        var paymentClass = Model.PaymentStatus switch
                                                        {
                                                            "pending" => "badge-warning",
                                                            "paid" => "badge-success",
                                                            "failed" => "badge-danger",
                                                            _ => "badge-secondary"
                                                        };
                                                        var paymentText = Model.PaymentStatus switch
                                                        {
                                                            "pending" => "Chờ thanh toán",
                                                            "paid" => "Đã thanh toán",
                                                            "failed" => "Thất bại",
                                                            _ => Model.PaymentStatus ?? "N/A"
                                                        };
                                                    }
                                                    <span class="badge @paymentClass fs-6">@paymentText</span>
                                                </p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Ngày tạo:</label>
                                                <p class="form-control-plaintext">@(Model.CreatedAt?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</p>
                                            </div>
                                            <!-- Temporarily disabled UpdatedAt field -->
                                            <!-- Temporarily disabled UpdatedAt field -->
                                            <!-- <div class="mb-3">
                                                <label class="form-label fw-bold">Cập nhật cuối:</label>
                                                <p class="form-control-plaintext">N/A</p>
                                            </div> -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Customer Information -->
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-user me-2"></i>
                                        Thông tin khách hàng
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Tên khách hàng:</label>
                                                <p class="form-control-plaintext">@(Model.UserName ?? "N/A")</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Email:</label>
                                                <p class="form-control-plaintext">@(Model.UserEmail ?? "N/A")</p>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Số điện thoại:</label>
                                                <p class="form-control-plaintext">@(Model.UserPhone ?? "N/A")</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Concept Information -->
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-lightbulb me-2"></i>
                                        Thông tin Concept
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Tên concept:</label>
                                                <p class="form-control-plaintext">@(Model.ConceptName ?? "N/A")</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Mô tả:</label>
                                                <p class="form-control-plaintext">@(Model.ConceptDescription ?? "N/A")</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Giá:</label>
                                                <p class="form-control-plaintext text-success fw-bold">
                                                    @if (Model.ConceptPrice.HasValue)
                                                    {
                                                        <text>@(Model.ConceptPrice.Value.ToString("N0")) VNĐ</text>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">N/A</span>
                                                    }
                                                </p>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Địa điểm:</label>
                                                <p class="form-control-plaintext">@(Model.LocationName ?? "N/A")</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Địa chỉ:</label>
                                                <p class="form-control-plaintext">@(Model.LocationAddress ?? "N/A")</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Quận/Huyện:</label>
                                                <p class="form-control-plaintext">@(Model.LocationDistrict ?? "N/A")</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Thành phố:</label>
                                                <p class="form-control-plaintext">@(Model.LocationCity ?? "N/A")</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Trạng thái địa điểm:</label>
                                                <p class="form-control-plaintext">
                                                    @{
                                                        var locationStatusClass = Model.LocationStatus switch
                                                        {
                                                            "active" => "badge-success",
                                                            "inactive" => "badge-warning",
                                                            "maintenance" => "badge-info",
                                                            _ => "badge-secondary"
                                                        };
                                                        var locationStatusText = Model.LocationStatus switch
                                                        {
                                                            "active" => "Hoạt động",
                                                            "inactive" => "Không hoạt động",
                                                            "maintenance" => "Bảo trì",
                                                            _ => Model.LocationStatus ?? "N/A"
                                                        };
                                                    }
                                                    <span class="badge @locationStatusClass fs-6">@locationStatusText</span>
                                                </p>
                                            </div>
                                            @if (!string.IsNullOrEmpty(Model.LocationGgmapLink))
                                            {
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Google Maps:</label>
                                                    <p class="form-control-plaintext">
                                                        <a href="@Model.LocationGgmapLink" target="_blank" class="text-primary">
                                                            <i class="fas fa-map-marker-alt me-1"></i>
                                                            Xem trên bản đồ
                                                        </a>
                                                    </p>
                                                </div>
                                            }
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Danh mục:</label>
                                                <p class="form-control-plaintext">@(Model.CategoryName ?? "N/A")</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Màu sắc:</label>
                                                <p class="form-control-plaintext">@(Model.ColorName ?? "N/A")</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Không gian:</label>
                                                <p class="form-control-plaintext">@(Model.AmbienceName ?? "N/A")</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Thời gian chuẩn bị:</label>
                                                <p class="form-control-plaintext">
                                                    @if (Model.PreparationTime.HasValue)
                                                    {
                                                        <text>@(Model.PreparationTime.Value) phút</text>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">N/A</span>
                                                    }
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Status Actions & Timeline -->
                        <div class="col-md-4">
                            <!-- Quick Actions -->
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-bolt me-2"></i>
                                        Thao tác nhanh
                                    </h5>
                                </div>
                                <div class="card-body">
                                    @if (Model.Status == "pending")
                                    {
                                        <button class="btn btn-success w-100 mb-2" onclick="confirmBooking(@Model.BookingId)">
                                            <i class="fas fa-check me-1"></i>
                                            Xác nhận đặt chỗ
                                        </button>
                                        <button class="btn btn-danger w-100 mb-2" onclick="cancelBooking(@Model.BookingId)">
                                            <i class="fas fa-times me-1"></i>
                                            Hủy đặt chỗ
                                        </button>
                                    }
                                    <button class="btn btn-primary w-100 mb-2" onclick="updateStatus(@Model.BookingId)">
                                        <i class="fas fa-edit me-1"></i>
                                        Thay đổi trạng thái
                                    </button>
                                    <button class="btn btn-warning w-100 mb-2" onclick="updatePaymentStatus(@Model.BookingId)">
                                        <i class="fas fa-credit-card me-1"></i>
                                        Thay đổi thanh toán
                                    </button>
                                    <a href="@Url.Action("EditBooking", "Admin", new { id = Model.BookingId })" class="btn btn-outline-primary w-100 mb-2">
                                        <i class="fas fa-edit me-1"></i>
                                        Chỉnh sửa chi tiết
                                    </a>
                                </div>
                            </div>

                            <!-- Timeline -->
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-clock me-2"></i>
                                        Lịch sử
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="timeline">
                                        <div class="timeline-item">
                                            <div class="timeline-marker bg-primary"></div>
                                            <div class="timeline-content">
                                                <h6 class="timeline-title">Đặt chỗ được tạo</h6>
                                                <p class="timeline-text">@(Model.CreatedAt?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</p>
                                            </div>
                                        </div>
                                        @if (Model.ConfirmedAt.HasValue)
                                        {
                                            <div class="timeline-item">
                                                <div class="timeline-marker bg-success"></div>
                                                <div class="timeline-content">
                                                    <h6 class="timeline-title">Đặt chỗ được xác nhận</h6>
                                                    <p class="timeline-text">@Model.ConfirmedAt.Value.ToString("dd/MM/yyyy HH:mm")</p>
                                                </div>
                                            </div>
                                        }
                                        @if (Model.CancelledAt.HasValue)
                                        {
                                            <div class="timeline-item">
                                                <div class="timeline-marker bg-danger"></div>
                                                <div class="timeline-content">
                                                    <h6 class="timeline-title">Đặt chỗ bị hủy</h6>
                                                    <p class="timeline-text">@Model.CancelledAt.Value.ToString("dd/MM/yyyy HH:mm")</p>
                                                </div>
                                            </div>
                                        }
                                        <!-- Temporarily disabled UpdatedAt timeline -->
                                        <!-- @if (false)
                                        {
                                            <div class="timeline-item">
                                                <div class="timeline-marker bg-info"></div>
                                                <div class="timeline-content">
                                                    <h6 class="timeline-title">Cập nhật cuối</h6>
                                                    <p class="timeline-text">N/A</p>
                                                </div>
                                            </div>
                                        } -->
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Details -->
                            @if (Model.PaymentDetails.Any())
                            {
                                <div class="card mt-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-credit-card me-2"></i>
                                            Chi tiết thanh toán
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        @foreach (var payment in Model.PaymentDetails)
                                        {
                                            <div class="border-bottom pb-2 mb-2">
                                                <div class="d-flex justify-content-between">
                                                    <span class="fw-bold">@(payment.PaymentMethodName ?? "N/A")</span>
                                                    <span class="text-success fw-bold">@(payment.Amount?.ToString("N0") ?? "N/A") VNĐ</span>
                                                </div>
                                                <small class="text-muted">
                                                    @(payment.CreatedAt?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")
                                                </small>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cập nhật trạng thái</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Trạng thái mới</label>
                    <select class="form-select" id="newStatus">
                        <option value="pending">Chờ xác nhận</option>
                        <option value="confirmed">Đã xác nhận</option>
                        <option value="cancelled">Đã hủy</option>
                        <option value="completed">Hoàn thành</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="confirmStatusBtn">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Status Update Modal -->
<div class="modal fade" id="paymentStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cập nhật trạng thái thanh toán</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Trạng thái thanh toán mới</label>
                    <select class="form-select" id="newPaymentStatus">
                        <option value="pending">Chờ thanh toán</option>
                        <option value="paid">Đã thanh toán</option>
                        <option value="failed">Thanh toán thất bại</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-warning" id="confirmPaymentStatusBtn">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentBookingId = @Model.BookingId;

        function confirmBooking(bookingId) {
            if (confirm('Bạn có chắc chắn muốn xác nhận đặt chỗ này không?')) {
                $.post('@Url.Action("ConfirmBooking", "Admin")', { id: bookingId })
                    .done(function(response) {
                        if (response.success) {
                            showAlert('success', response.message);
                            location.reload();
                        } else {
                            showAlert('error', response.message);
                        }
                    })
                    .fail(function() {
                        showAlert('error', 'Có lỗi xảy ra khi xác nhận đặt chỗ');
                    });
            }
        }

        function cancelBooking(bookingId) {
            if (confirm('Bạn có chắc chắn muốn hủy đặt chỗ này không?')) {
                $.post('@Url.Action("CancelBooking", "Admin")', { id: bookingId })
                    .done(function(response) {
                        if (response.success) {
                            showAlert('success', response.message);
                            location.reload();
                        } else {
                            showAlert('error', response.message);
                        }
                    })
                    .fail(function() {
                        showAlert('error', 'Có lỗi xảy ra khi hủy đặt chỗ');
                    });
            }
        }

        function updateStatus(bookingId) {
            currentBookingId = bookingId;
            $('#statusModal').modal('show');
        }

        function updatePaymentStatus(bookingId) {
            currentBookingId = bookingId;
            $('#paymentStatusModal').modal('show');
        }


        $('#confirmStatusBtn').click(function() {
            if (currentBookingId) {
                var newStatus = $('#newStatus').val();
                $.post('@Url.Action("UpdateBookingStatus", "Admin")', { 
                    id: currentBookingId, 
                    status: newStatus 
                })
                .done(function(response) {
                    if (response.success) {
                        showAlert('success', response.message);
                        location.reload();
                    } else {
                        showAlert('error', response.message);
                    }
                })
                .fail(function() {
                    showAlert('error', 'Có lỗi xảy ra khi cập nhật trạng thái');
                });
            }
            $('#statusModal').modal('hide');
        });

        $('#confirmPaymentStatusBtn').click(function() {
            if (currentBookingId) {
                var newPaymentStatus = $('#newPaymentStatus').val();
                $.post('@Url.Action("UpdateBookingPaymentStatus", "Admin")', { 
                    id: currentBookingId, 
                    paymentStatus: newPaymentStatus 
                })
                .done(function(response) {
                    if (response.success) {
                        showAlert('success', response.message);
                        location.reload();
                    } else {
                        showAlert('error', response.message);
                    }
                })
                .fail(function() {
                    showAlert('error', 'Có lỗi xảy ra khi cập nhật trạng thái thanh toán');
                });
            }
            $('#paymentStatusModal').modal('hide');
        });

        function showAlert(type, message) {
            var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                message +
                '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                '</div>';
            
            $('.container-fluid').prepend(alertHtml);
            
            setTimeout(function() {
                $('.alert').fadeOut();
            }, 5000);
        }
    </script>
}

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -25px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #dee2e6;
}

.timeline-content {
    background: #f8f9fa;
    padding: 10px 15px;
    border-radius: 5px;
    border-left: 3px solid #007bff;
}

.timeline-title {
    margin: 0 0 5px 0;
    font-size: 14px;
    font-weight: 600;
}

.timeline-text {
    margin: 0;
    font-size: 12px;
    color: #6c757d;
}
</style>
