@model MonAmour.ViewModels.AdminUserViewModel.UserChangePasswordViewModel
@{
    ViewData["Title"] = "Đổi mật khẩu người dùng";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid px-4">
    <h1 class="mt-4">Đổi mật khẩu người dùng</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a asp-controller="Admin" asp-action="Dashboard">Dashboard</a></li>
        <li class="breadcrumb-item"><a asp-controller="Admin" asp-action="Users">Quản lý người dùng</a></li>
        <li class="breadcrumb-item active">Đổi mật khẩu người dùng</li>
    </ol>

    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-key me-1"></i>
                    Đổi mật khẩu
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Lưu ý:</strong> Mật khẩu mới sẽ được áp dụng ngay lập tức. Người dùng sẽ cần sử dụng mật khẩu mới này để đăng nhập lần tiếp theo.
                    </div>

                    <form asp-action="ChangeUserPassword" method="post">
                        @Html.AntiForgeryToken()
                        <input asp-for="UserId" type="hidden" />

                        <div class="form-group mb-3">
                            <label asp-for="NewPassword" class="form-label">Mật khẩu mới <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input asp-for="NewPassword" type="password" class="form-control" id="newPassword" 
                                       placeholder="Nhập mật khẩu mới" />
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('newPassword')">
                                    <i class="fas fa-eye" id="newPassword-icon"></i>
                                </button>
                            </div>
                            <span asp-validation-for="NewPassword" class="text-danger"></span>
                            <small class="form-text text-muted">
                                Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường và số
                            </small>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="ConfirmPassword" class="form-label">Xác nhận mật khẩu <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input asp-for="ConfirmPassword" type="password" class="form-control" id="confirmPassword" 
                                       placeholder="Nhập lại mật khẩu mới" />
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirmPassword')">
                                    <i class="fas fa-eye" id="confirmPassword-icon"></i>
                                </button>
                            </div>
                            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                        </div>

                        <!-- Password Strength Indicator -->
                        <div class="mb-3">
                            <label class="form-label">Độ mạnh mật khẩu:</label>
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="passwordStrengthText">Chưa nhập mật khẩu</small>
                        </div>

                        <!-- Password Requirements -->
                        <div class="mb-4">
                            <label class="form-label">Yêu cầu mật khẩu:</label>
                            <ul class="list-unstyled small">
                                <li id="lengthCheck">
                                    <i class="fas fa-times text-danger me-2"></i>
                                    Ít nhất 8 ký tự
                                </li>
                                <li id="uppercaseCheck">
                                    <i class="fas fa-times text-danger me-2"></i>
                                    Có chữ hoa
                                </li>
                                <li id="lowercaseCheck">
                                    <i class="fas fa-times text-danger me-2"></i>
                                    Có chữ thường
                                </li>
                                <li id="numberCheck">
                                    <i class="fas fa-times text-danger me-2"></i>
                                    Có số
                                </li>
                            </ul>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a asp-action="Users" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Quay lại
                            </a>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save"></i> Đổi mật khẩu
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Security Notice -->
            <div class="card mt-4">
                <div class="card-header">
                    <i class="fas fa-shield-alt me-1"></i>
                    Thông báo bảo mật
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-check-circle text-success me-2"></i>Điều nên làm:</h6>
                            <ul class="small">
                                <li>Sử dụng mật khẩu mạnh</li>
                                <li>Thông báo cho người dùng</li>
                                <li>Ghi log thao tác</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-exclamation-triangle text-warning me-2"></i>Lưu ý:</h6>
                            <ul class="small">
                                <li>Mật khẩu cũ sẽ không còn hiệu lực</li>
                                <li>Người dùng có thể reset lại</li>
                                <li>Kiểm tra email thông báo</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = document.getElementById(fieldId + '-icon');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Password strength checker
        document.getElementById('newPassword').addEventListener('input', function() {
            const password = this.value;
            const strengthBar = document.getElementById('passwordStrength');
            const strengthText = document.getElementById('passwordStrengthText');
            
            // Check requirements
            const lengthCheck = document.getElementById('lengthCheck');
            const uppercaseCheck = document.getElementById('uppercaseCheck');
            const lowercaseCheck = document.getElementById('lowercaseCheck');
            const numberCheck = document.getElementById('numberCheck');
            
            // Update requirement checks
            lengthCheck.innerHTML = (password.length >= 8) ? 
                '<i class="fas fa-check text-success me-2"></i>Ít nhất 8 ký tự' : 
                '<i class="fas fa-times text-danger me-2"></i>Ít nhất 8 ký tự';
                
            uppercaseCheck.innerHTML = /[A-Z]/.test(password) ? 
                '<i class="fas fa-check text-success me-2"></i>Có chữ hoa' : 
                '<i class="fas fa-times text-danger me-2"></i>Có chữ hoa';
                
            lowercaseCheck.innerHTML = /[a-z]/.test(password) ? 
                '<i class="fas fa-check text-success me-2"></i>Có chữ thường' : 
                '<i class="fas fa-times text-danger me-2"></i>Có chữ thường';
                
            numberCheck.innerHTML = /\d/.test(password) ? 
                '<i class="fas fa-check text-success me-2"></i>Có số' : 
                '<i class="fas fa-times text-danger me-2"></i>Có số';
            
            // Calculate strength
            let strength = 0;
            if (password.length >= 8) strength += 25;
            if (/[A-Z]/.test(password)) strength += 25;
            if (/[a-z]/.test(password)) strength += 25;
            if (/\d/.test(password)) strength += 25;
            
            // Update strength bar
            strengthBar.style.width = strength + '%';
            
            if (strength === 0) {
                strengthBar.className = 'progress-bar';
                strengthText.textContent = 'Chưa nhập mật khẩu';
            } else if (strength <= 25) {
                strengthBar.className = 'progress-bar bg-danger';
                strengthText.textContent = 'Rất yếu';
            } else if (strength <= 50) {
                strengthBar.className = 'progress-bar bg-warning';
                strengthText.textContent = 'Yếu';
            } else if (strength <= 75) {
                strengthBar.className = 'progress-bar bg-info';
                strengthText.textContent = 'Trung bình';
            } else {
                strengthBar.className = 'progress-bar bg-success';
                strengthText.textContent = 'Mạnh';
            }
        });

        // Confirm password match
        document.getElementById('confirmPassword').addEventListener('input', function() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = this.value;
            
            if (confirmPassword && newPassword !== confirmPassword) {
                this.setCustomValidity('Mật khẩu xác nhận không khớp');
            } else {
                this.setCustomValidity('');
            }
        });
    </script>
}
