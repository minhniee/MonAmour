@model MonAmour.ViewModels.BookingEditViewModel

@{
    ViewData["Title"] = "Chỉnh sửa đặt chỗ";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-edit me-2"></i>
                        Chỉnh sửa đặt chỗ #@Model.BookingId
                    </h4>
                    <div class="d-flex gap-2">
                        <a href="@Url.Action("Bookings", "Admin")" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>
                            Quay lại
                        </a>
                        <a href="@Url.Action("BookingDetail", "Admin", new { id = Model.BookingId })" class="btn btn-outline-info">
                            <i class="fas fa-eye me-1"></i>
                            Xem chi tiết
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <form asp-action="EditBooking" method="post" id="editBookingForm">
                        <input asp-for="BookingId" type="hidden" />
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-user me-2"></i>
                                            Thông tin khách hàng
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label asp-for="UserId" class="form-label">Khách hàng <span class="text-danger">*</span></label>
                                            <select asp-for="UserId" class="form-select" id="userIdSelect" required>
                                                <option value="">-- Chọn khách hàng --</option>
                                            </select>
                                            <span asp-validation-for="UserId" class="text-danger"></span>
                                        </div>
                                        <div id="userInfo" class="alert alert-info" style="display: none;">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <strong>Tên:</strong> <span id="userName"></span><br>
                                                    <strong>Email:</strong> <span id="userEmail"></span>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>Số điện thoại:</strong> <span id="userPhone"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-lightbulb me-2"></i>
                                            Thông tin Concept
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label asp-for="ConceptId" class="form-label">Concept <span class="text-danger">*</span></label>
                                            <select asp-for="ConceptId" class="form-select" id="conceptIdSelect" required>
                                                <option value="">-- Chọn concept --</option>
                                            </select>
                                            <span asp-validation-for="ConceptId" class="text-danger"></span>
                                        </div>
                                        <div id="conceptInfo" class="alert alert-info" style="display: none;">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <strong>Tên:</strong> <span id="conceptName"></span><br>
                                                    <strong>Giá:</strong> <span id="conceptPrice"></span>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>Địa điểm:</strong> <span id="conceptLocation"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-calendar me-2"></i>
                                            Thông tin đặt chỗ
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label asp-for="BookingDate" class="form-label">Ngày đặt <span class="text-danger">*</span></label>
                                            <input asp-for="BookingDate" type="date" class="form-control" required />
                                            <span asp-validation-for="BookingDate" class="text-danger"></span>
                                        </div>
                                        <div class="mb-3">
                                            <label asp-for="BookingTime" class="form-label">Giờ đặt <span class="text-danger">*</span></label>
                                            <input asp-for="BookingTime" type="time" class="form-control" required />
                                            <span asp-validation-for="BookingTime" class="text-danger"></span>
                                        </div>
                                        <div class="mb-3">
                                            <label asp-for="TotalPrice" class="form-label">Tổng tiền</label>
                                            <div class="input-group">
                                                <input asp-for="TotalPrice" type="number" class="form-control" step="1000" min="0" />
                                                <span class="input-group-text">VNĐ</span>
                                            </div>
                                            <span asp-validation-for="TotalPrice" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-cog me-2"></i>
                                            Trạng thái
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label asp-for="Status" class="form-label">Trạng thái đặt chỗ <span class="text-danger">*</span></label>
                                            <select asp-for="Status" class="form-select" required>
                                                <option value="pending">Chờ xác nhận</option>
                                                <option value="confirmed">Đã xác nhận</option>
                                                <option value="cancelled">Đã hủy</option>
                                                <option value="completed">Hoàn thành</option>
                                            </select>
                                            <span asp-validation-for="Status" class="text-danger"></span>
                                        </div>
                                        <div class="mb-3">
                                            <label asp-for="PaymentStatus" class="form-label">Trạng thái thanh toán <span class="text-danger">*</span></label>
                                            <select asp-for="PaymentStatus" class="form-select" required>
                                                <option value="pending">Chờ thanh toán</option>
                                                <option value="paid">Đã thanh toán</option>
                                                <option value="failed">Thanh toán thất bại</option>
                                            </select>
                                            <span asp-validation-for="PaymentStatus" class="text-danger"></span>
                                        </div>
                                        @if (Model.ConfirmedAt.HasValue)
                                        {
                                            <div class="mb-3">
                                                <label class="form-label">Ngày xác nhận</label>
                                                <p class="form-control-plaintext">@Model.ConfirmedAt.Value.ToString("dd/MM/yyyy HH:mm")</p>
                                            </div>
                                        }
                                        @if (Model.CancelledAt.HasValue)
                                        {
                                            <div class="mb-3">
                                                <label class="form-label">Ngày hủy</label>
                                                <p class="form-control-plaintext">@Model.CancelledAt.Value.ToString("dd/MM/yyyy HH:mm")</p>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-end gap-2">
                                    <a href="@Url.Action("Bookings", "Admin")" class="btn btn-secondary">
                                        <i class="fas fa-times me-1"></i>
                                        Hủy
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i>
                                        Cập nhật đặt chỗ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Load users for dropdown
            loadUsers();
            
            // Load concepts for dropdown
            loadConcepts();
            
            // Set minimum date to today
            var today = new Date().toISOString().split('T')[0];
            $('#BookingDate').attr('min', today);
            
            // Trigger change events to show info
            $('#userIdSelect').trigger('change');
            $('#conceptIdSelect').trigger('change');
        });

        function loadUsers() {
            $.get('@Url.Action("GetUsersForBookingDropdown", "Admin")')
                .done(function(users) {
                    var select = $('#userIdSelect');
                    select.empty();
                    select.append('<option value="">-- Chọn khách hàng --</option>');
                    
                    users.forEach(function(user) {
                        var selected = user.userId == @Model.UserId ? 'selected' : '';
                        select.append('<option value="' + user.userId + '" ' + selected + '>' + user.name + ' (' + user.email + ')</option>');
                    });
                })
                .fail(function() {
                    console.error('Error loading users');
                });
        }

        function loadConcepts() {
            $.get('@Url.Action("GetConceptsForBookingDropdown", "Admin")')
                .done(function(concepts) {
                    var select = $('#conceptIdSelect');
                    select.empty();
                    select.append('<option value="">-- Chọn concept --</option>');
                    
                    concepts.forEach(function(concept) {
                        var priceText = concept.price ? concept.price.toLocaleString() + ' VNĐ' : 'N/A';
                        var locationText = concept.locationName ? ' - ' + concept.locationName : '';
                        var selected = concept.conceptId == @Model.ConceptId ? 'selected' : '';
                        select.append('<option value="' + concept.conceptId + '" data-price="' + (concept.price || 0) + '" data-location="' + (concept.locationName || '') + '" ' + selected + '>' + concept.name + ' (' + priceText + ')' + locationText + '</option>');
                    });
                })
                .fail(function() {
                    console.error('Error loading concepts');
                });
        }

        // Handle user selection
        $('#userIdSelect').change(function() {
            var userId = $(this).val();
            if (userId) {
                // In a real application, you would fetch user details via AJAX
                // For now, we'll just show a placeholder
                $('#userInfo').show();
                $('#userName').text('Loading...');
                $('#userEmail').text('Loading...');
                $('#userPhone').text('Loading...');
            } else {
                $('#userInfo').hide();
            }
        });

        // Handle concept selection
        $('#conceptIdSelect').change(function() {
            var conceptId = $(this).val();
            if (conceptId) {
                var selectedOption = $(this).find('option:selected');
                var price = selectedOption.data('price');
                var location = selectedOption.data('location');
                
                $('#conceptInfo').show();
                $('#conceptName').text(selectedOption.text().split(' (')[0]);
                $('#conceptPrice').text(price ? price.toLocaleString() + ' VNĐ' : 'N/A');
                $('#conceptLocation').text(location || 'N/A');
            } else {
                $('#conceptInfo').hide();
            }
        });

        // Form validation
        $('#editBookingForm').submit(function(e) {
            var isValid = true;
            
            // Check required fields
            if (!$('#userIdSelect').val()) {
                $('#userIdSelect').addClass('is-invalid');
                isValid = false;
            } else {
                $('#userIdSelect').removeClass('is-invalid');
            }
            
            if (!$('#conceptIdSelect').val()) {
                $('#conceptIdSelect').addClass('is-invalid');
                isValid = false;
            } else {
                $('#conceptIdSelect').removeClass('is-invalid');
            }
            
            if (!$('#BookingDate').val()) {
                $('#BookingDate').addClass('is-invalid');
                isValid = false;
            } else {
                $('#BookingDate').removeClass('is-invalid');
            }
            
            if (!$('#BookingTime').val()) {
                $('#BookingTime').addClass('is-invalid');
                isValid = false;
            } else {
                $('#BookingTime').removeClass('is-invalid');
            }
            
            if (!$('#Status').val()) {
                $('#Status').addClass('is-invalid');
                isValid = false;
            } else {
                $('#Status').removeClass('is-invalid');
            }
            
            if (!$('#PaymentStatus').val()) {
                $('#PaymentStatus').addClass('is-invalid');
                isValid = false;
            } else {
                $('#PaymentStatus').removeClass('is-invalid');
            }
            
            if (!isValid) {
                e.preventDefault();
                showAlert('error', 'Vui lòng điền đầy đủ thông tin bắt buộc');
            }
        });

        function showAlert(type, message) {
            var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                message +
                '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                '</div>';
            
            $('.container-fluid').prepend(alertHtml);
            
            setTimeout(function() {
                $('.alert').fadeOut();
            }, 5000);
        }
    </script>
}
