@model List<object>
@{
    ViewData["Title"] = "Quản lý Hình ảnh Concept";
    Layout = "_AdminLayout";
}

<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Quản lý Hình ảnh Concept</h1>
        <div>
            <a href="@Url.Action("Concepts", "Admin")" class="btn btn-secondary shadow-sm ml-2">
                <i class="fas fa-arrow-left fa-sm text-white-50"></i> Quay lại
            </a>
        </div>
    </div>

    <!-- Concept Search and Filter -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-search mr-2"></i>Tìm kiếm và Lọc Concept
            </h6>
        </div>
        <div class="card-body">
            <form method="get" class="row align-items-end">
                <div class="col-md-4">
                    <label for="searchTerm" class="form-label">Tìm kiếm theo tên:</label>
                    <input type="text" id="searchTerm" name="searchTerm" class="form-control" 
                           placeholder="Nhập tên concept..." value="@ViewBag.SearchTerm">
                </div>
                <div class="col-md-4">
                    <label for="conceptId" class="form-label">Chọn Concept:</label>
                    <select id="conceptId" name="conceptId" class="form-control">
                        <option value="">-- Tất cả concept --</option>
                        @if (ViewBag.Concepts != null)
                        {
                            foreach (var concept in ViewBag.Concepts)
                            {
                                var isSelected = ViewBag.SelectedConceptId != null && ViewBag.SelectedConceptId.ToString() == concept.Value.ToString();
                                if (isSelected)
                                {
                                    <option value="@concept.Value" selected>@concept.Text</option>
                                }
                                else
                                {
                                    <option value="@concept.Value">@concept.Text</option>
                                }
                            }
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search mr-2"></i>Tìm kiếm
                    </button>
                    <a href="@Url.Action("ConceptImages", "Admin")" class="btn btn-outline-secondary ml-2">
                        <i class="fas fa-times mr-2"></i>Xóa bộ lọc
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Images Display -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-images mr-2"></i>Hình ảnh Concept
                @if (ViewBag.SelectedConceptId != null)
                {
                    <span class="badge badge-info ml-2">Đã lọc</span>
                }
            </h6>
            <div>
                @{
                    int totalPrimaryImages = 0;
                    int totalBannerImages = 0;
                    int totalDescriptionImages = 0;
                    int totalConcepts = Model.Count();
                    
                    foreach (dynamic conceptGroup in Model)
                    {
                        var images = (List<MonAmour.ViewModels.ConceptImgViewModel>)conceptGroup.Images;
                        totalPrimaryImages += images.Count(i => i.DisplayOrder == 1);
                        totalBannerImages += images.Count(i => i.DisplayOrder >= 2 && i.DisplayOrder <= 3);
                        totalDescriptionImages += images.Count(i => i.DisplayOrder >= 4 && i.DisplayOrder <= 6);
                    }
                }
                <span class="badge badge-success">@totalPrimaryImages Ảnh chính</span>
                <span class="badge badge-info ml-2">@totalBannerImages Banner</span>
                <span class="badge badge-primary ml-2">@totalDescriptionImages Ảnh mô tả</span>
                <span class="badge badge-secondary ml-2">@totalConcepts Concept</span>
            </div>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                @foreach (dynamic conceptGroup in Model)
                {
                    <div class="concept-group mb-5">
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="fas fa-lightbulb mr-2"></i>
                                                <strong>@conceptGroup.ConceptName</strong>
                                                <span class="badge badge-light ml-2">ID: @conceptGroup.ConceptId</span>
                                            </h5>
                                            <div class="image-count-info">
                                                @{
                                                    var imageCount = ((List<MonAmour.ViewModels.ConceptImgViewModel>)conceptGroup.Images).Count;
                                                    var canAddMore = imageCount < 6;
                                                }
                                                @if (canAddMore)
                                                {
                                                    <span class="badge badge-success">
                                                        <i class="fas fa-image mr-1"></i>
                                                        @imageCount/6 hình ảnh
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-warning">
                                                        <i class="fas fa-exclamation-triangle mr-1"></i> Đã đạt giới hạn
                                                    </span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            @{
                                                var images = (List<MonAmour.ViewModels.ConceptImgViewModel>)conceptGroup.Images;
                                                var imageDict = new Dictionary<int, MonAmour.ViewModels.ConceptImgViewModel>();
                                                
                                                // Group by DisplayOrder and take the first one for each position
                                                foreach (var image in images.OrderBy(x => x.ImgId))
                                                {
                                                    if (!imageDict.ContainsKey(image.DisplayOrder))
                                                    {
                                                        imageDict[image.DisplayOrder] = image;
                                                    }
                                                }
                                            }
                                            
                                            @for (int i = 1; i <= 6; i++)
                                            {
                                                var hasImage = imageDict.ContainsKey(i);
                                                var image = hasImage ? imageDict[i] : null;
                                                
                                                <div class="col-lg-4 col-md-6 mb-4">
                                                    <div class="card h-100 @(hasImage ? (image.IsPrimary == true ? "border-success" : "border-primary") : "border-light") image-card">
                                                        @if (hasImage)
                                                        {
                                                            <div class="card-img-top-container">
                                                                <img src="@image.ImgUrl" class="card-img-top" alt="@image.AltText" 
                                                                     onclick="openImageModal('@image.ImgUrl', '@image.ImgName', '@image.AltText', @image.IsPrimary.ToString().ToLower(), @image.DisplayOrder)">
                                                                <div class="image-overlay">
                                                                    <div class="btn-group-vertical">
                                                                        <button type="button" class="btn btn-sm btn-outline-light" onclick="editImage(@image.ImgId)">
                                                                            <i class="fas fa-edit"></i>
                                                                        </button>
                                                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteImage(@image.ImgId)">
                                                                            <i class="fas fa-trash"></i>
                                                                        </button>
                                                                        <button type="button" class="btn btn-sm btn-outline-info" onclick="viewFullImage('@image.ImgUrl', '@image.ImgName')">
                                                                            <i class="fas fa-eye"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="card-img-top-container bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                                                <div class="text-center">
                                                                    <i class="fas fa-image fa-3x text-muted mb-2"></i>
                                                                    <p class="text-muted small mb-0">Chưa có ảnh</p>
                                                                </div>
                                                            </div>
                                                        }
                                                        
                                                        <div class="card-body">
                                                            <h6 class="card-title">
                                                                @if (i == 1)
                                                                {
                                                                    <span class="badge badge-success badge-sm mr-2">
                                                                        <i class="fas fa-star mr-1"></i>Ảnh chính
                                                                    </span>
                                                                }
                                                                else if (i >= 2 && i <= 3)
                                                                {
                                                                    <span class="badge badge-info badge-sm mr-2">
                                                                        <i class="fas fa-image mr-1"></i>Banner
                                                                    </span>
                                                                }
                                                                else
                                                                {
                                                                    <span class="badge badge-primary badge-sm mr-2">
                                                                        <i class="fas fa-image mr-1"></i>Ảnh mô tả
                                                                    </span>
                                                                }
                                                                @if (hasImage)
                                                                {
                                                                    @(image.ImgName ?? "Hình ảnh concept")
                                                                }
                                                                else
                                                                {
                                                                    <span class="text-muted">Vị trí @i</span>
                                                                }
                                                            </h6>
                                                            <p class="card-text small text-muted">
                                                                @if (hasImage)
                                                                {
                                                                    @if (image.DisplayOrder == 1)
                                                                    {
                                                                        <span class="text-success"><i class="fas fa-star mr-1"></i>Ảnh chính của concept</span>
                                                                    }
                                                                    else if (image.DisplayOrder >= 2 && image.DisplayOrder <= 3)
                                                                    {
                                                                        <span class="text-info"><i class="fas fa-image mr-1"></i>Banner concept</span>
                                                                    }
                                                                    else
                                                                    {
                                                                        @(image.AltText ?? "Mô tả chi tiết về concept")
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    @if (i == 1)
                                                                    {
                                                                        <span class="text-muted"><i class="fas fa-star mr-1"></i>Ảnh chính của concept</span>
                                                                    }
                                                                    else if (i >= 2 && i <= 3)
                                                                    {
                                                                        <span class="text-muted"><i class="fas fa-image mr-1"></i>Banner concept</span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="text-muted"><i class="fas fa-image mr-1"></i>Mô tả chi tiết về concept</span>
                                                                    }
                                                                }
                                                            </p>
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <small class="text-muted">Thứ tự: @i</small>
                                                                @if (hasImage)
                                                                {
                                                                    <small class="text-muted">ID: @image.ImgId</small>
                                                                }
                                                                else
                                                                {
                                                                    <button type="button" class="btn btn-sm btn-outline-primary" 
                                                                            onclick="addImageForPosition(@conceptGroup.ConceptId, '@conceptGroup.ConceptName', @i)">
                                                                        <i class="fas fa-plus mr-1"></i>Thêm ảnh
                                                                    </button>
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-image fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">
                        @if (ViewBag.SelectedConceptId != null)
                        {
                            <span>Chưa có hình ảnh nào cho concept này</span>
                        }
                        else
                        {
                            <span>Chưa có concept nào có hình ảnh trong hệ thống</span>
                        }
                    </h6>
                                                                            <p class="text-muted small">Hãy thêm hình ảnh cho các concept! Mỗi concept có 6 vị trí cố định: 1 ảnh chính + 2 banner + 3 ảnh mô tả</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Add Image Modal -->
<div class="modal fade" id="addImageModal" tabindex="-1" role="dialog" aria-labelledby="addImageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addImageModalLabel">
                    <i class="fas fa-plus mr-2"></i>Thêm Hình ảnh Mới
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addImageForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addConceptId">Concept <span class="text-danger">*</span></label>
                                <select id="addConceptId" name="ConceptId" class="form-control" required>
                                    <option value="">-- Chọn concept --</option>
                                    @if (ViewBag.Concepts != null)
                                    {
                                        foreach (var concept in ViewBag.Concepts)
                                        {
                                            var isSelected = ViewBag.SelectedConceptId != null && ViewBag.SelectedConceptId.ToString() == concept.Value.ToString();
                                            if (isSelected)
                                            {
                                                <option value="@concept.Value" selected>@concept.Text</option>
                                            }
                                            else
                                            {
                                                <option value="@concept.Value">@concept.Text</option>
                                            }
                                        }
                                    }
                                </select>
                                <div class="invalid-feedback">Vui lòng chọn concept</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addDisplayOrder">Thứ tự hiển thị</label>
                                <select id="addDisplayOrder" name="DisplayOrder" class="form-control" required>
                                    <option value="">-- Chọn vị trí --</option>
                                    <option value="1">1 - Ảnh chính (IsPrimary = true)</option>
                                    <option value="2">2 - Banner concept</option>
                                    <option value="3">3 - Banner concept</option>
                                    <option value="4">4 - Ảnh mô tả</option>
                                    <option value="5">5 - Ảnh mô tả</option>
                                    <option value="6">6 - Ảnh mô tả</option>
                                </select>
                                <small class="form-text text-muted">
                                    <strong>Lưu ý:</strong> Thứ tự 1 sẽ tự động là ảnh chính, thứ tự 2-3 là banner, thứ tự 4-6 là ảnh mô tả
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="addImageFile">Chọn hình ảnh từ máy tính <span class="text-danger">*</span></label>
                        <input type="file" id="addImageFile" name="imageFile" class="form-control" accept="image/*" onchange="previewImage(this)" required>
                        <small class="form-text text-muted">Hỗ trợ: JPG, PNG, GIF. Kích thước tối đa: 5MB. Tối đa 6 ảnh: 1 ảnh chính + 2 banner + 3 ảnh mô tả</small>
                        <div id="imagePreview" class="mt-2" style="display: none;">
                            <img id="previewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="addImgName">Tên hình ảnh</label>
                        <input type="text" id="addImgName" name="ImgName" class="form-control" placeholder="Tên mô tả cho hình ảnh">
                    </div>
                    <div class="form-group">
                        <label for="addAltText">Alt Text (chỉ cho ảnh mô tả)</label>
                        <input type="text" id="addAltText" name="AltText" class="form-control" placeholder="Mô tả chi tiết về concept (chỉ áp dụng cho ảnh mô tả)">
                        <small class="form-text text-muted">Chỉ cần nhập cho ảnh mô tả (thứ tự 4-6). Ảnh chính và banner sẽ tự động có alt text.</small>
                    </div>
                    <div class="form-group">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Thông tin:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Thứ tự 1: Tự động là ảnh chính (IsPrimary = true)</li>
                                <li>Thứ tự 2-3: Banner concept (AltText = "Banner concept")</li>
                                <li>Thứ tự 4-6: Ảnh mô tả (AltText do bạn nhập)</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times mr-2"></i>Hủy
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus mr-2"></i>Thêm Hình ảnh
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Image Modal -->
<div class="modal fade" id="editImageModal" tabindex="-1" role="dialog" aria-labelledby="editImageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editImageModalLabel">
                    <i class="fas fa-edit mr-2"></i>Chỉnh sửa Hình ảnh
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editImageForm">
                <input type="hidden" id="editImgId" name="ImgId">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editConceptId">Concept <span class="text-danger">*</span></label>
                                <select id="editConceptId" name="ConceptId" class="form-control" required>
                                    <option value="">-- Chọn concept --</option>
                                    @if (ViewBag.Concepts != null)
                                    {
                                        foreach (var concept in ViewBag.Concepts)
                                        {
                                            <option value="@concept.Value">@concept.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editDisplayOrder">Thứ tự hiển thị</label>
                                <select id="editDisplayOrder" name="DisplayOrder" class="form-control" required>
                                    <option value="">-- Chọn vị trí --</option>
                                    <option value="1">1 - Ảnh chính (IsPrimary = true)</option>
                                    <option value="2">2 - Banner concept</option>
                                    <option value="3">3 - Banner concept</option>
                                    <option value="4">4 - Ảnh mô tả</option>
                                    <option value="5">5 - Ảnh mô tả</option>
                                    <option value="6">6 - Ảnh mô tả</option>
                                </select>
                                <small class="form-text text-muted">
                                    <strong>Lưu ý:</strong> Thứ tự 1 sẽ tự động là ảnh chính, thứ tự 2-3 là banner, thứ tự 4-6 là ảnh mô tả
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editImageFile">Chọn hình ảnh mới từ máy tính</label>
                        <input type="file" id="editImageFile" name="imageFile" class="form-control" accept="image/*" onchange="previewEditImage(this)">
                        <small class="form-text text-muted">Hỗ trợ: JPG, PNG, GIF. Kích thước tối đa: 5MB. Để trống nếu không muốn thay đổi hình ảnh. Tối đa 6 ảnh: 1 ảnh chính + 2 banner + 3 ảnh mô tả</small>
                        <div id="editImagePreview" class="mt-2" style="display: none;">
                            <img id="editPreviewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editImgName">Tên hình ảnh</label>
                        <input type="text" id="editImgName" name="ImgName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="editAltText">Alt Text (chỉ cho ảnh mô tả)</label>
                        <input type="text" id="editAltText" name="AltText" class="form-control" placeholder="Mô tả chi tiết về concept (chỉ áp dụng cho ảnh mô tả)">
                        <small class="form-text text-muted">Chỉ cần nhập cho ảnh mô tả (thứ tự 4-6). Ảnh chính và banner sẽ tự động có alt text.</small>
                    </div>
                    <div class="form-group">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Thông tin:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Thứ tự 1: Tự động là ảnh chính (IsPrimary = true)</li>
                                <li>Thứ tự 2-3: Banner concept (AltText = "Banner concept")</li>
                                <li>Thứ tự 4-6: Ảnh mô tả (AltText do bạn nhập)</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times mr-2"></i>Hủy
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save mr-2"></i>Cập nhật
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" role="dialog" aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imagePreviewModalLabel">
                    <i class="fas fa-image mr-2"></i>Xem Hình ảnh
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <img id="previewImage" src="" alt="" class="img-fluid">
                <div class="mt-3">
                    <h6 id="previewImageName" class="font-weight-bold text-primary"></h6>
                    <p id="previewImageAlt" class="text-muted"></p>
                    <div id="previewImageType" class="mb-2"></div>
                    <div id="previewImageOrder" class="text-muted small"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times mr-2"></i>Đóng
                </button>
                <a id="previewImageLink" href="" target="_blank" class="btn btn-primary">
                    <i class="fas fa-external-link-alt mr-2"></i>Mở trong tab mới
                </a>
                <button type="button" class="btn btn-info" onclick="downloadPreviewImage()">
                    <i class="fas fa-download mr-2"></i>Tải xuống
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Full Image View Modal -->
<div class="modal fade" id="fullImageModal" tabindex="-1" role="dialog" aria-labelledby="fullImageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fullImageModalLabel">
                    <i class="fas fa-eye mr-2"></i>Xem Hình ảnh Đầy đủ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center p-0">
                <img id="fullImage" src="" alt="" class="img-fluid w-100" style="max-height: 80vh; object-fit: contain;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times mr-2"></i>Đóng
                </button>
                <a id="fullImageLink" href="" target="_blank" class="btn btn-primary">
                    <i class="fas fa-external-link-alt mr-2"></i>Mở trong tab mới
                </a>
                <button type="button" class="btn btn-info" onclick="downloadFullImage()">
                    <i class="fas fa-download mr-2"></i>Tải xuống
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteImageModal" tabindex="-1" role="dialog" aria-labelledby="deleteImageModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteImageModalLabel">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa hình ảnh này?</p>
                <p class="text-danger"><strong>Lưu ý:</strong> Hành động này không thể hoàn tác!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteImage()">
                    <i class="fas fa-trash mr-2"></i>Xóa Hình ảnh
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentImageId = null;

        // Add Image
        $('#addImageForm').on('submit', function(e) {
            e.preventDefault();
            
            const conceptId = $('#addConceptId').val();
            if (!conceptId) {
                showAlert('danger', 'Vui lòng chọn concept!');
                return;
            }
            
            // Kiểm tra vị trí cụ thể trước khi thêm
            const displayOrder = $('#addDisplayOrder').val();
            if (!displayOrder) {
                showAlert('danger', 'Vui lòng chọn vị trí hiển thị!');
                return;
            }
            
            $.get('@Url.Action("GetConceptImageCount", "Admin")', { conceptId: conceptId }, function(result) {
                if (result.success) {
                    if (result.occupiedPositions.includes(parseInt(displayOrder))) {
                        showAlert('danger', `Vị trí ${displayOrder} đã có hình ảnh! Vui lòng chọn vị trí khác hoặc sử dụng chức năng chỉnh sửa.`);
                    } else {
                        submitAddImageForm();
                    }
                } else {
                    showAlert('danger', result.message || 'Có lỗi xảy ra khi kiểm tra vị trí!');
                }
            });
        });
        
        function submitAddImageForm() {
            const conceptId = $('#addConceptId').val();
            const imageFile = $('#addImageFile')[0].files[0];
            
            // Kiểm tra concept
            if (!conceptId) {
                showAlert('danger', 'Vui lòng chọn concept!');
                $('#addConceptId').focus();
                return;
            }
            
            // Kiểm tra xem có file không
            if (!imageFile) {
                showAlert('danger', 'Vui lòng chọn file hình ảnh!');
                $('#addImageFile').focus();
                return;
            }
           
            // Tạo FormData để upload file
            const formData = new FormData();
            formData.append('ConceptId', conceptId);
            formData.append('ImgName', $('#addImgName').val() || 'Hình ảnh concept');
            formData.append('AltText', $('#addAltText').val() || '');
            formData.append('DisplayOrder', $('#addDisplayOrder').val() || '1');
            formData.append('imageFile', imageFile);
           
            $.ajax({
                url: '@Url.Action("AddConceptImage", "Admin")',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(result) {
                    if (result.success) {
                        showAlert('success', result.message);
                        var addModal = bootstrap.Modal.getInstance(document.getElementById('addImageModal'));
                        if (addModal) addModal.hide();
                        $('#addImageForm')[0].reset();
                        $('#imagePreview').hide();
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showAlert('danger', result.message);
                    }
                },
                error: function() {
                    showAlert('danger', 'Có lỗi xảy ra khi thêm hình ảnh!');
                }
            });
        }

        // Edit Image
        function editImage(imageId) {
            // Tìm hình ảnh trong danh sách hiện tại
            let foundImage = null;
            @foreach (dynamic conceptGroup in Model)
            {
                <text>
                var images = @Html.Raw(Json.Serialize(((List<MonAmour.ViewModels.ConceptImgViewModel>)conceptGroup.Images)));
                var image = images.find(img => img.imgId === imageId);
                if (image) {
                    foundImage = image;
                }
                </text>
            }
            
            if (foundImage) {
                $('#editImgId').val(foundImage.imgId);
                $('#editConceptId').val(foundImage.conceptId);
                $('#editImgName').val(foundImage.imgName || '');
                $('#editAltText').val(foundImage.altText || '');
                $('#editDisplayOrder').val(foundImage.displayOrder || 1);
                
                var editModal = new bootstrap.Modal(document.getElementById('editImageModal'));
                editModal.show();
            } else {
                showAlert('danger', 'Không tìm thấy thông tin hình ảnh!');
            }
        }

        // Update Image
        $('#editImageForm').on('submit', function(e) {
            e.preventDefault();
            
            const imageFile = $('#editImageFile')[0].files[0];
            const formData = new FormData();
            formData.append('ImgId', $('#editImgId').val());
            formData.append('ConceptId', $('#editConceptId').val());
            formData.append('ImgName', $('#editImgName').val());
            formData.append('AltText', $('#editAltText').val());
            formData.append('DisplayOrder', $('#editDisplayOrder').val());
            
            // Nếu có file mới, thêm vào formData
            if (imageFile) {
                formData.append('imageFile', imageFile);
            }
            
            $.ajax({
                url: '@Url.Action("UpdateConceptImage", "Admin")',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(result) {
                    if (result.success) {
                        showAlert('success', result.message);
                        var editModal = bootstrap.Modal.getInstance(document.getElementById('editImageModal'));
                        if (editModal) editModal.hide();
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showAlert('danger', result.message);
                    }
                },
                error: function() {
                    showAlert('danger', 'Có lỗi xảy ra khi cập nhật hình ảnh!');
                }
            });
        });


        // Delete Image
        function deleteImage(imageId) {
            currentImageId = imageId;
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteImageModal'));
            deleteModal.show();
        }

        function confirmDeleteImage() {
            if (currentImageId) {
                $.ajax({
                    url: '@Url.Action("DeleteConceptImage", "Admin")',
                    type: 'POST',
                    data: { imageId: currentImageId },
                    success: function(result) {
                        if (result.success) {
                            showAlert('success', result.message);
                            var deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteImageModal'));
                            if (deleteModal) deleteModal.hide();
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            showAlert('danger', result.message);
                        }
                    },
                    error: function() {
                        showAlert('danger', 'Có lỗi xảy ra khi xóa hình ảnh!');
                    }
                });
            }
        }

        // Preview Image
        function openImageModal(imageUrl, imageName, altText, isPrimary, displayOrder) {
            $('#previewImage').attr('src', imageUrl);
            $('#previewImageName').text(imageName || 'Hình ảnh concept');
            $('#previewImageAlt').text(altText || 'Không có mô tả');
            $('#previewImageLink').attr('href', imageUrl);
            
            if (isPrimary === 'true') {
                $('#previewImageType').html('<span class="badge badge-success badge-lg"><i class="fas fa-star mr-1"></i>Ảnh chính</span>');
            } else {
                $('#previewImageType').html('<span class="badge badge-primary badge-lg"><i class="fas fa-image mr-1"></i>Ảnh phụ</span>');
            }
            
            $('#previewImageOrder').text('Thứ tự hiển thị: ' + displayOrder);
            
            var previewModal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
            previewModal.show();
        }

        function downloadPreviewImage() {
            const imageUrl = $('#previewImage').attr('src');
            const imageName = $('#previewImageName').text();
            
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = imageName + '.jpg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // View Full Image
        function viewFullImage(imageUrl, imageName) {
            $('#fullImage').attr('src', imageUrl);
            $('#fullImage').attr('alt', imageName || 'Hình ảnh concept');
            $('#fullImageLink').attr('href', imageUrl);
            
            var fullModal = new bootstrap.Modal(document.getElementById('fullImageModal'));
            fullModal.show();
        }

        function downloadFullImage() {
            const imageUrl = $('#fullImage').attr('src');
            const imageName = $('#fullImage').attr('alt') || 'Hình ảnh concept';
            
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = imageName + '.jpg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add Image for specific concept
        function addImageForConcept(conceptId, conceptName) {
            // Kiểm tra vị trí có sẵn
            $.get('@Url.Action("GetConceptImageCount", "Admin")', { conceptId: conceptId }, function(result) {
                if (result.success && result.canAddMore) {
                    // Pre-fill form với concept đã chọn
                    $('#addConceptId').val(conceptId);
                    $('#addConceptId').prop('disabled', true);
                    $('#addImageModalLabel').html('<i class="fas fa-plus mr-2"></i>Thêm Hình ảnh cho "' + conceptName + '" (' + result.availablePositions.length + ' vị trí còn trống)');
                    
                    // Update available positions in dropdown
                    const displayOrderSelect = $('#addDisplayOrder');
                    displayOrderSelect.find('option').each(function() {
                        const value = parseInt($(this).val());
                        if (value && !result.availablePositions.includes(value)) {
                            $(this).prop('disabled', true).text($(this).text() + ' (Đã có ảnh)');
                        } else {
                            $(this).prop('disabled', false);
                        }
                    });
                    
                    var addModal = new bootstrap.Modal(document.getElementById('addImageModal'));
                    addModal.show();
                } else {
                    showAlert('warning', result.message || 'Tất cả 6 vị trí đã có hình ảnh!');
                }
            });
        }

        // Add Image for specific position
        function addImageForPosition(conceptId, conceptName, position) {
            // Kiểm tra vị trí cụ thể
            $.get('@Url.Action("GetConceptImageCount", "Admin")', { conceptId: conceptId }, function(result) {
                if (result.success) {
                    if (result.occupiedPositions.includes(parseInt(position))) {
                        showAlert('warning', `Vị trí ${position} đã có hình ảnh! Vui lòng sử dụng chức năng chỉnh sửa để thay thế.`);
                        return;
                    }
                    
                    // Pre-fill form với concept và vị trí đã chọn
                    $('#addConceptId').val(conceptId);
                    $('#addConceptId').prop('disabled', true);
                    $('#addDisplayOrder').val(position);
                    $('#addDisplayOrder').prop('disabled', true);
                    
                    // Set title based on position
                    let positionText = '';
                    if (position == 1) {
                        positionText = 'Ảnh chính';
                    } else if (position >= 2 && position <= 3) {
                        positionText = 'Banner concept';
                    } else {
                        positionText = 'Ảnh mô tả';
                    }
                    
                    $('#addImageModalLabel').html('<i class="fas fa-plus mr-2"></i>Thêm ' + positionText + ' cho "' + conceptName + '"');
                    var addModal = new bootstrap.Modal(document.getElementById('addImageModal'));
                    addModal.show();
                } else {
                    showAlert('danger', result.message || 'Có lỗi xảy ra khi kiểm tra vị trí!');
                }
            });
        }
        
        // Reset form khi đóng modal
        document.getElementById('addImageModal').addEventListener('hidden.bs.modal', function() {
            $('#addConceptId').prop('disabled', false);
            $('#addDisplayOrder').prop('disabled', false);
            $('#addImageModalLabel').html('<i class="fas fa-plus mr-2"></i>Thêm Hình ảnh Mới');
            $('#imagePreview').hide();
            
            // Reset dropdown options text
            $('#addDisplayOrder option').each(function() {
                $(this).prop('disabled', false);
                const value = $(this).val();
                if (value) {
                    const originalTexts = {
                        '1': '1 - Ảnh chính (IsPrimary = true)',
                        '2': '2 - Banner concept',
                        '3': '3 - Banner concept', 
                        '4': '4 - Ảnh mô tả',
                        '5': '5 - Ảnh mô tả',
                        '6': '6 - Ảnh mô tả'
                    };
                    if (originalTexts[value]) {
                        $(this).text(originalTexts[value]);
                    }
                }
            });
        });

        // Preview hình ảnh khi chọn file
        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }
        
        // Preview hình ảnh khi chọn file trong edit form
        function previewEditImage(input) {
            const preview = document.getElementById('editImagePreview');
            const previewImg = document.getElementById('editPreviewImg');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }
        
        // Alert helper
        function showAlert(type, message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
            
            // Remove existing alerts
            $('.alert').remove();
            
            // Add new alert
            $('.container-fluid').prepend(alertHtml);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                $('.alert').fadeOut();
            }, 5000);
        }
    </script>
}

<style>
    .image-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }
    
    .image-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .card-img-top-container {
        position: relative;
        overflow: hidden;
    }
    
    .card-img-top {
        height: 200px;
        object-fit: cover;
        transition: transform 0.3s;
    }
    
    .image-card:hover .card-img-top {
        transform: scale(1.05);
    }
    
    .image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .image-card:hover .image-overlay {
        opacity: 1;
    }
    
    .image-overlay .btn-group-vertical {
        gap: 5px;
    }
    
    .image-overlay .btn {
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .badge-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
</style>
