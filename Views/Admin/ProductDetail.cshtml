@model MonAmour.ViewModels.ProductDetailViewModel
@{
    ViewData["Title"] = "Chi tiết Sản phẩm";
    Layout = "_AdminLayout";
}

<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Chi tiết Sản phẩm</h1>
        <div>
            <a href="@Url.Action("EditProduct", "Admin", new { id = Model.ProductId })" class="d-none d-sm-inline-block btn btn-warning shadow-sm mr-2">
                <i class="fas fa-edit fa-sm text-white-50"></i> Chỉnh sửa
            </a>
            <a href="@Url.Action("Products", "Admin")" class="d-none d-sm-inline-block btn btn-secondary shadow-sm">
                <i class="fas fa-arrow-left fa-sm text-white-50"></i> Quay lại
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Product Images Gallery -->
            <div class="card shadow mb-4 product-image-gallery">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-images mr-2"></i>Hình ảnh Sản phẩm
                    </h6>
                </div>
                <div class="card-body">
                    @if (Model.Images.Any())
                    {
                        <!-- Primary Image Section -->
                        @foreach (var primaryImage in Model.Images.Where(i => i.IsPrimary == true))
                        {
                            <div class="primary-image-section">
                                <h6 class="font-weight-bold text-success mb-3">
                                    <i class="fas fa-star mr-2"></i>Ảnh chính của sản phẩm
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card border-success primary-image-card">
                                            <img src="@primaryImage.ImgUrl" class="card-img-top" alt="@primaryImage.AltText" 
                                                 onclick="openImageModal('@primaryImage.ImgUrl', '@primaryImage.ImgName', '@primaryImage.AltText', true, @primaryImage.DisplayOrder)">
                                            <div class="card-body">
                                                <h6 class="card-title text-success font-weight-bold">
                                                    <i class="fas fa-star mr-2"></i>@(primaryImage.ImgName ?? "Ảnh chính")
                                                </h6>
                                                <p class="card-text small text-muted">@(primaryImage.AltText ?? "Không có mô tả")</p>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="badge badge-success badge-lg">
                                                        <i class="fas fa-star mr-1"></i>Ảnh chính
                                                    </span>
                                                    <small class="text-muted">Thứ tự: @primaryImage.DisplayOrder</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        
                        <!-- Secondary Images Section -->
                        @if (Model.Images.Any(i => i.IsPrimary != true))
                        {
                            <div class="secondary-images-section">
                                <h6 class="font-weight-bold text-primary mb-3">
                                    <i class="fas fa-images mr-2"></i>Ảnh phụ (@Model.Images.Count(i => i.IsPrimary != true) ảnh)
                                </h6>
                                <div class="row">
                                    @foreach (var image in Model.Images.Where(i => i.IsPrimary != true).OrderBy(i => i.DisplayOrder))
                                    {
                                        <div class="col-md-4 mb-3">
                                            <div class="card h-100 border-primary secondary-image-card">
                                                <img src="@image.ImgUrl" class="card-img-top" alt="@image.AltText" 
                                                     onclick="openImageModal('@image.ImgUrl', '@image.ImgName', '@image.AltText', false, @image.DisplayOrder)">
                                                <div class="card-body p-3">
                                                    <h6 class="card-title small mb-2">@(image.ImgName ?? "Hình ảnh")</h6>
                                                    <p class="card-text small text-muted mb-2">@(image.AltText ?? "Không có mô tả")</p>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="badge badge-primary">
                                                            <i class="fas fa-image mr-1"></i>Ảnh phụ
                                                        </span>
                                                        <small class="text-muted">Thứ tự: @image.DisplayOrder</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        
                        <!-- Image Summary -->
                        <div class="image-summary">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="border-right">
                                        <h4 class="text-success font-weight-bold">@Model.Images.Count</h4>
                                        <small class="text-muted">Tổng số ảnh</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border-right">
                                        <h4 class="text-success font-weight-bold">@(Model.Images.Count(i => i.IsPrimary == true))</h4>
                                        <small class="text-muted">Ảnh chính</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border-right">
                                        <h4 class="text-primary font-weight-bold">@(Model.Images.Count(i => i.IsPrimary != true))</h4>
                                        <small class="text-muted">Ảnh phụ</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <h4 class="text-info font-weight-bold">@Model.Images.Max(i => i.DisplayOrder)</h4>
                                    <small class="text-muted">Thứ tự cao nhất</small>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-image fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">Chưa có hình ảnh nào</h6>
                            <p class="text-muted small">Hãy thêm hình ảnh cho sản phẩm</p>
                                            <a href="@Url.Action("ProductImages", "Admin")" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus mr-2"></i>Thêm hình ảnh
                </a>
                        </div>
                    }
                </div>
            </div>

            <!-- Product Description -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-align-left mr-2"></i>Mô tả chi tiết
                    </h6>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <div class="product-description">
                            @Html.Raw(Model.Description.Replace("\n", "<br>"))
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-3">
                            <i class="fas fa-file-alt fa-2x text-muted mb-2"></i>
                            <p class="text-muted">Chưa có mô tả chi tiết</p>
                            <a href="@Url.Action("EditProduct", "Admin", new { id = Model.ProductId })" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-edit mr-2"></i>Thêm mô tả
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Product Basic Info -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-info-circle mr-2"></i>Thông tin cơ bản
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="font-weight-bold text-primary">Tên sản phẩm:</h6>
                        <p class="mb-0">@Model.Name</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="font-weight-bold text-primary">Danh mục:</h6>
                        <p class="mb-0">@Model.CategoryName</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="font-weight-bold text-primary">Giá:</h6>
                        <h5 class="text-success mb-0">@Model.Price.ToString("N0") ₫</h5>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="font-weight-bold text-primary">Tồn kho:</h6>
                        @if (Model.StockQuantity <= 0)
                        {
                            <span class="badge badge-danger badge-lg">Hết hàng</span>
                        }
                        else if (Model.StockQuantity <= 10)
                        {
                            <span class="badge badge-warning badge-lg">@Model.StockQuantity (Sắp hết)</span>
                        }
                        else
                        {
                            <span class="badge badge-success badge-lg">@Model.StockQuantity</span>
                        }
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="font-weight-bold text-primary">Trạng thái:</h6>
                        @if (Model.Status == "active")
                        {
                            <span class="badge badge-success badge-lg">Hoạt động</span>
                        }
                        else if (Model.Status == "inactive")
                        {
                            <span class="badge badge-secondary badge-lg">Không hoạt động</span>
                        }
                        else
                        {
                            <span class="badge badge-warning badge-lg">Bản nháp</span>
                        }
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="font-weight-bold text-primary">Ngày tạo:</h6>
                        <p class="mb-0">@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
                    </div>
                </div>
            </div>

            <!-- Product Additional Info -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-tags mr-2"></i>Thông tin bổ sung
                    </h6>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.Material))
                    {
                        <div class="mb-3">
                            <h6 class="font-weight-bold text-primary">Chất liệu:</h6>
                            <p class="mb-0">@Model.Material</p>
                        </div>
                    }
                    
                    @if (!string.IsNullOrEmpty(Model.TargetAudience))
                    {
                        <div class="mb-3">
                            <h6 class="font-weight-bold text-primary">Đối tượng khách hàng:</h6>
                            <p class="mb-0">@Model.TargetAudience</p>
                        </div>
                    }
                    
                    @if (string.IsNullOrEmpty(Model.Material) && string.IsNullOrEmpty(Model.TargetAudience))
                    {
                        <div class="text-center py-3">
                            <i class="fas fa-tags fa-2x text-muted mb-2"></i>
                            <p class="text-muted small">Chưa có thông tin bổ sung</p>
                            <a href="@Url.Action("EditProduct", "Admin", new { id = Model.ProductId })" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-edit mr-2"></i>Cập nhật
                            </a>
                        </div>
                    }
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-bolt mr-2"></i>Thao tác nhanh
                    </h6>
                </div>
                <div class="card-body">
                                         <div class="list-group list-group-flush">
                         <a href="@Url.Action("EditProduct", "Admin", new { id = Model.ProductId })" class="list-group-item list-group-item-action">
                             <i class="fas fa-edit mr-2 text-warning"></i>Chỉnh sửa sản phẩm
                         </a>
                         <a href="@Url.Action("Products", "Admin")" class="list-group-item list-group-item-action">
                             <i class="fas fa-list mr-2 text-primary"></i>Danh sách sản phẩm
                         </a>
                         <button type="button" class="list-group-item list-group-item-action text-danger" onclick="deleteProduct()">
                             <i class="fas fa-trash mr-2"></i>Xóa sản phẩm
                         </button>
                     </div>
                </div>
            </div>

            <!-- Status Management -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-toggle-on mr-2"></i>Quản lý trạng thái
                    </h6>
                </div>
                <div class="card-body">
                    <div class="btn-group-vertical w-100" role="group">
                        @if (Model.Status != "active")
                        {
                            <form method="post" action="@Url.Action("ToggleProductStatus", "Admin")" style="display: inline;">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@Model.ProductId" />
                                <input type="hidden" name="status" value="active" />
                                <button type="submit" class="btn btn-success btn-block mb-2">
                                    <i class="fas fa-check mr-2"></i>Kích hoạt
                                </button>
                            </form>
                        }
                        
                        @if (Model.Status != "inactive")
                        {
                            <form method="post" action="@Url.Action("ToggleProductStatus", "Admin")" style="display: inline;">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@Model.ProductId" />
                                <input type="hidden" name="status" value="inactive" />
                                <button type="submit" class="btn btn-secondary btn-block mb-2">
                                    <i class="fas fa-pause mr-2"></i>Tạm dừng
                                </button>
                            </form>
                        }
                        
                        @if (Model.Status != "draft")
                        {
                            <form method="post" action="@Url.Action("ToggleProductStatus", "Admin")" style="display: inline;">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@Model.ProductId" />
                                <input type="hidden" name="status" value="draft" />
                                <button type="submit" class="btn btn-warning btn-block">
                                    <i class="fas fa-edit mr-2"></i>Chuyển thành bản nháp
                                </button>
                            </form>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">
                    <i class="fas fa-image mr-2"></i>Xem hình ảnh sản phẩm
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" alt="" class="img-fluid modal-image">
                <div class="modal-image-info">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 id="modalImageName" class="font-weight-bold text-primary mb-2"></h6>
                            <p id="modalImageAlt" class="text-muted mb-0"></p>
                        </div>
                        <div class="col-md-6 text-right">
                            <div id="modalImageType" class="mb-2"></div>
                            <div id="modalImageOrder" class="text-muted small"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-2"></i>Đóng
                </button>
                <a id="modalImageLink" href="" target="_blank" class="btn btn-primary">
                    <i class="fas fa-external-link-alt mr-2"></i>Mở trong tab mới
                </a>
                <button type="button" class="btn btn-info" onclick="downloadImage()">
                    <i class="fas fa-download mr-2"></i>Tải xuống
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Xác nhận xóa</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn xóa sản phẩm "<strong>@Model.Name</strong>"?
                <br><br>
                <strong>Lưu ý:</strong> 
                <ul class="text-danger">
                    <li>Hành động này không thể hoàn tác!</li>
                    <li>Tất cả hình ảnh của sản phẩm sẽ bị xóa</li>
                    <li>Sản phẩm sẽ bị xóa khỏi tất cả đơn hàng</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <form method="post" action="@Url.Action("DeleteProduct", "Admin")" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.ProductId" />
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash mr-2"></i>Xóa sản phẩm
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openImageModal(imageUrl, imageName, altText, isPrimary, displayOrder) {
            $('#modalImage').attr('src', imageUrl);
            $('#modalImageName').text(imageName || 'Hình ảnh sản phẩm');
            $('#modalImageAlt').text(altText || 'Không có mô tả');
            $('#modalImageLink').attr('href', imageUrl);
            
            // Hiển thị loại ảnh và thứ tự
            if (isPrimary) {
                $('#modalImageType').html('<span class="badge badge-success badge-lg"><i class="fas fa-star mr-1"></i>Ảnh chính</span>');
            } else {
                $('#modalImageType').html('<span class="badge badge-primary badge-lg"><i class="fas fa-image mr-1"></i>Ảnh phụ</span>');
            }
            
            $('#modalImageOrder').text('Thứ tự hiển thị: ' + displayOrder);
            
            $('#imageModal').modal('show');
        }
        
        function downloadImage() {
            const imageUrl = $('#modalImage').attr('src');
            const imageName = $('#modalImageName').text();
            
            // Tạo link tải xuống
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = imageName + '.jpg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
                 function deleteProduct() {
            $('#deleteModal').modal('show');
        }
        
        
    </script>
}
