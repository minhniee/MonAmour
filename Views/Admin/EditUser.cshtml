@model MonAmour.ViewModels.AdminUserViewModel.UserEditViewModel
@{
    ViewData["Title"] = "Chỉnh sửa người dùng";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="page-header">
    <div>
        <h1>Chỉnh sửa người dùng</h1>
        <p class="subtitle">Cập nhật thông tin người dùng</p>
    </div>
    <div class="header-actions">
        <a asp-action="Users" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left"></i> Quay lại
        </a>
    </div>
</div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-user-edit me-1"></i>
                    Thông tin người dùng
                </div>
                <div class="card-body">
                    <form asp-action="EditUser" method="post" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        <input asp-for="UserId" type="hidden" />
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Email" class="form-label">Email <span class="text-danger">*</span></label>
                                    <input asp-for="Email" class="form-control" placeholder="example@email.com" />
                                    <span asp-validation-for="Email" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Name" class="form-label">Họ và tên <span class="text-danger">*</span></label>
                                    <input asp-for="Name" class="form-control" placeholder="Nguyễn Văn A" />
                                    <span asp-validation-for="Name" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Phone" class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                                    <input asp-for="Phone" class="form-control" placeholder="0123456789" />
                                    <span asp-validation-for="Phone" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="BirthDate" class="form-label">Ngày sinh <span class="text-danger">*</span></label>
                                    <input asp-for="BirthDate" type="date" class="form-control" />
                                    <span asp-validation-for="BirthDate" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Gender" class="form-label">Giới tính <span class="text-danger">*</span></label>
                                    <select asp-for="Gender" class="form-control">
                                        <option value="">Chọn giới tính</option>
                                        <option value="male">Nam</option>
                                        <option value="female">Nữ</option>
                                        <option value="other">Khác</option>
                                    </select>
                                    <span asp-validation-for="Gender" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Status" class="form-label">Trạng thái <span class="text-danger">*</span></label>
                                    <select asp-for="Status" class="form-control">
                                        <option value="">Chọn trạng thái</option>
                                        <option value="active">Hoạt động</option>
                                        <option value="inactive">Không hoạt động</option>
                                        <option value="suspended">Tạm khóa</option>
                                    </select>
                                    <span asp-validation-for="Status" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label for="avatarFile" class="form-label">Avatar</label>
                            <input type="file" id="avatarFile" name="AvatarFile" class="form-control" accept="image/*" onchange="previewAvatar(this)">
                            <span asp-validation-for="Avatar" class="text-danger"></span>
                            <small class="form-text text-muted">Hỗ trợ: JPG, PNG, GIF. Kích thước tối đa: 5MB. Để trống nếu không muốn thay đổi avatar.</small>
                            <div id="avatarPreview" class="mt-2" style="display: none;">
                                <img id="previewAvatarImg" src="" alt="Avatar Preview" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                            </div>
                            @if (!string.IsNullOrEmpty(Model.Avatar))
                            {
                                <div class="mt-2">
                                    <small class="text-muted">Avatar hiện tại:</small>
                                    <img src="@Model.Avatar" alt="Current Avatar" class="img-thumbnail ms-2" style="max-width: 100px; max-height: 100px;">
                                </div>
                            }
                        </div>

                        <div class="form-group mb-3">
                            <div class="form-check">
                                <input asp-for="Verified" class="form-check-input" type="checkbox" />
                                <label asp-for="Verified" class="form-check-label">
                                    Đã xác thực email
                                </label>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label class="form-label">Vai trò <span class="text-danger">*</span></label>
                            <div class="row">
                                                                 @foreach (var role in ViewBag.Roles ?? new List<MonAmour.ViewModels.AdminUserViewModel.RoleViewModel>())
                                {
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="RoleIds" value="@role.RoleId" 
                                                   id="role_@role.RoleId" @(Model.RoleIds.Contains(role.RoleId) ? "checked" : "") />
                                            <label class="form-check-label" for="role_@role.RoleId">
                                                @role.RoleName
                                            </label>
                                        </div>
                                    </div>
                                }
                            </div>
                            <span class="text-danger field-validation-error" id="roleIds-error"></span>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a asp-action="Users" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Quay lại
                            </a>
                            <div>
                                <a asp-action="ChangeUserPassword" asp-route-id="@Model.UserId" class="btn btn-warning me-2">
                                    <i class="fas fa-key"></i> Đổi mật khẩu
                                </a>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> Cập nhật
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-info-circle me-1"></i>
                    Thông tin bổ sung
                </div>
                <div class="card-body">
                    <h6>ID người dùng:</h6>
                    <p class="text-muted">@Model.UserId</p>
                    
                    <hr>
                    
                    <h6>Lưu ý khi chỉnh sửa:</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>Email phải là duy nhất</li>
                        <li><i class="fas fa-check text-success me-2"></i>Chọn ít nhất một vai trò</li>
                        <li><i class="fas fa-check text-success me-2"></i>Thay đổi sẽ được ghi log</li>
                        <li><i class="fas fa-check text-success me-2"></i>Không thể xóa vai trò admin</li>
                    </ul>
                    
                    <hr>
                    
                    <h6>Thao tác nhanh:</h6>
                    <div class="d-grid gap-2">
                        <a asp-action="UserDetail" asp-route-id="@Model.UserId" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-eye"></i> Xem chi tiết
                        </a>
                        <a asp-action="ChangeUserPassword" asp-route-id="@Model.UserId" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-key"></i> Đổi mật khẩu
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Custom validation for role selection
        document.querySelector('form').addEventListener('submit', function(e) {
            const roleCheckboxes = document.querySelectorAll('input[name="RoleIds"]:checked');
            const roleError = document.getElementById('roleIds-error');
            
            if (roleCheckboxes.length === 0) {
                roleError.textContent = 'Vui lòng chọn ít nhất một vai trò';
                e.preventDefault();
            } else {
                roleError.textContent = '';
            }
        });

        // Preview avatar function
        function previewAvatar(input) {
            const preview = document.getElementById('avatarPreview');
            const previewImg = document.getElementById('previewAvatarImg');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }
    </script>
}
