@model List<MonAmour.ViewModels.PartnerViewModel>
@{
    ViewData["Title"] = "Quản lý Đối tác";
    Layout = "_AdminLayout";
}

<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Quản lý Đối tác</h1>
        <div>
            <a href="@Url.Action("CreatePartner", "Admin")" class="btn btn-primary shadow-sm mr-2">
                <i class="fas fa-plus fa-sm text-white-50"></i> Thêm Đối tác
            </a>
            <a href="@Url.Action("Locations", "Admin")" class="d-none d-sm-inline-block btn btn-secondary shadow-sm">
                <i class="fas fa-map-marker-alt fa-sm text-white-50"></i> Quản lý Địa điểm
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Tổng đối tác</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.Count</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-handshake fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Đối tác hoạt động</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.Count(p => p.Status == "Active")</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Đối tác có địa điểm</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.Count(p => p.LocationCount > 0)</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-map-marker-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Tổng địa điểm</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.Sum(p => p.LocationCount)</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-building fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-search mr-2"></i>Tìm kiếm và Lọc
            </h6>
        </div>
        <div class="card-body">
            <form method="get" class="row">
                <div class="col-md-4">
                    <label for="searchTerm" class="form-label">Từ khóa tìm kiếm</label>
                    <input type="text" id="searchTerm" name="searchTerm" class="form-control" 
                           value="@ViewBag.SearchModel?.SearchTerm" placeholder="Tên đối tác, email, điện thoại...">
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">Trạng thái</label>
                    <select id="status" name="status" class="form-control">
                        <option value="">-- Tất cả --</option>
                        <option value="Active" selected="@(ViewBag.SearchModel?.Status == "Active")">Hoạt động</option>
                        <option value="Inactive" selected="@(ViewBag.SearchModel?.Status == "Inactive")">Không hoạt động</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="sortBy" class="form-label">Sắp xếp theo</label>
                    <select id="sortBy" name="sortBy" class="form-control">
                        <option value="name" selected="@(ViewBag.SearchModel?.SortBy == "name")">Tên đối tác</option>
                        <option value="locationCount" selected="@(ViewBag.SearchModel?.SortBy == "locationCount")">Số địa điểm</option>
                        <option value="id" selected="@(ViewBag.SearchModel?.SortBy == "id")">ID</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Tìm kiếm
                        </button>
                        <a href="@Url.Action("Partners", "Admin")" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Xóa bộ lọc
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Partners Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">
                Danh sách Đối tác
                @if (ViewBag.SearchModel?.SearchTerm != null || ViewBag.SearchModel?.Status != null)
                {
                    <small class="text-muted">(@Model.Count kết quả)</small>
                }
            </h6>
            <div class="dropdown no-arrow">
                <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                   data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                </a>
                <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
                     aria-labelledby="dropdownMenuLink">
                    <div class="dropdown-header">Tùy chọn:</div>
                    <a class="dropdown-item" href="@Url.Action("Locations", "Admin")">
                        <i class="fas fa-map-marker-alt fa-sm fa-fw mr-2 text-gray-400"></i>Quản lý Địa điểm
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#" onclick="exportPartners()">
                        <i class="fas fa-download fa-sm fa-fw mr-2 text-gray-400"></i>Xuất Excel
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#" onclick="testDatabaseConnection()">
                        <i class="fas fa-database fa-sm fa-fw mr-2 text-gray-400"></i>Test Database
                    </a>
                    <a class="dropdown-item" href="#" onclick="testCreatePartner()">
                        <i class="fas fa-flask fa-sm fa-fw mr-2 text-gray-400"></i>Test Create Partner
                    </a>
                    <a class="dropdown-item" href="#" onclick="testCreatePartnerWithoutUser()">
                        <i class="fas fa-user-slash fa-sm fa-fw mr-2 text-gray-400"></i>Test Create Partner (No User)
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-bordered" id="partnersTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tên đối tác</th>
                                <th>Email</th>
                                <th>Điện thoại</th>
                                <th>Số địa điểm</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var partner in Model)
                            {
                                <tr>
                                    <td>@partner.PartnerId</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            @if (!string.IsNullOrEmpty(partner.Avatar))
                                            {
                                                <div class="avatar-container avatar-status-indicator has-avatar mr-2" title="Có avatar">
                                                    <img class="rounded-circle current-avatar" src="@partner.Avatar" alt="Avatar" width="32" height="32" 
                                                         style="object-fit: cover;" 
                                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="rounded-circle avatar-status-indicator no-avatar mr-2 bg-light text-muted d-flex align-items-center justify-content-center" 
                                                     style="width: 32px; height: 32px; border: 1px dashed #dee2e6;" title="Chưa có avatar">
                                                    <i class="fas fa-user fa-sm"></i>
                                                </div>
                                            }
                                            <div class="ml-2">
                                                <strong>@partner.Name</strong>
                                                @if (!string.IsNullOrEmpty(partner.ContactInfo))
                                                {
                                                    <br><small class="text-muted">@partner.ContactInfo</small>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(partner.Email))
                                        {
                                            <a href="mailto:@partner.Email" class="text-decoration-none">
                                                <i class="fas fa-envelope mr-1"></i>@partner.Email
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(partner.Phone))
                                        {
                                            <a href="tel:@partner.Phone" class="text-decoration-none">
                                                <i class="fas fa-phone mr-1"></i>@partner.Phone
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (partner.LocationCount > 0)
                                        {
                                            <span class="badge badge-success">@partner.LocationCount</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-secondary">0</span>
                                        }
                                    </td>
                                    <td>
                                        @if (partner.Status == "Active")
                                        {
                                            <span class="badge badge-success">Hoạt động</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-warning">Tạm dừng</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="@Url.Action("PartnerDetail", "Admin", new { id = partner.PartnerId })" 
                                               class="btn btn-info btn-sm" title="Xem chi tiết">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button type="button" class="btn btn-warning btn-sm" title="Chỉnh sửa"
                                                    onclick="editPartner(@partner.PartnerId, '@Html.Raw(partner.Name.Replace("'", "\\'"))')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            @if (partner.Status == "Active")
                                            {
                                                <button type="button" class="btn btn-secondary btn-sm" title="Tạm dừng"
                                                        onclick="togglePartnerStatus(@partner.PartnerId, 'Inactive')">
                                                    <i class="fas fa-pause"></i>
                                                </button>
                                            }
                                            else
                                            {
                                                <button type="button" class="btn btn-success btn-sm" title="Kích hoạt"
                                                        onclick="togglePartnerStatus(@partner.PartnerId, 'Active')">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                            }
                                            <button type="button" class="btn btn-outline-danger btn-sm" title="Xóa"
                                                    onclick="deletePartner(@partner.PartnerId, '@Html.Raw(partner.Name.Replace("'", "\\'"))', @partner.LocationCount)">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    @if (ViewBag.SearchModel?.SearchTerm != null || ViewBag.SearchModel?.Status != null)
                    {
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Không tìm thấy đối tác nào</h5>
                        <p class="text-muted">Thử thay đổi từ khóa tìm kiếm hoặc bộ lọc</p>
                        <a href="@Url.Action("Partners", "Admin")" class="btn btn-outline-secondary">
                            <i class="fas fa-times mr-2"></i>Xóa bộ lọc
                        </a>
                    }
                    else
                    {
                        <i class="fas fa-handshake fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Chưa có đối tác nào</h5>
                        <p class="text-muted">Hãy tạo đối tác đầu tiên để bắt đầu</p>
                        <a href="@Url.Action("CreatePartner", "Admin")" class="btn btn-primary">
                            <i class="fas fa-plus mr-2"></i>Thêm Đối tác
                        </a>
                    }
                </div>
            }
        </div>
    </div>
</div>

<!-- Edit Partner Modal -->
<div class="modal fade" id="editPartnerModal" tabindex="-1" role="dialog" aria-labelledby="editPartnerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPartnerModalLabel">Chỉnh sửa Đối tác</h5>
                <button type="button" class="close" onclick="closeEditPartnerModal()" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editPartnerForm" method="post" action="@Url.Action("EditPartner", "Admin")" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <input type="hidden" id="editPartnerId" name="PartnerId" />
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editPartnerName" class="form-label">Tên đối tác <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editPartnerName" name="Name" required 
                                       placeholder="Nhập tên đối tác..." maxlength="100">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editPartnerStatus" class="form-label">Trạng thái <span class="text-danger">*</span></label>
                                <select class="form-control" id="editPartnerStatus" name="Status" required>
                                    <option value="Active">Hoạt động</option>
                                    <option value="Inactive">Tạm dừng</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editPartnerEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editPartnerEmail" name="Email" 
                                       placeholder="Nhập email..." maxlength="100">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editPartnerPhone" class="form-label">Điện thoại</label>
                                <input type="tel" class="form-control" id="editPartnerPhone" name="Phone" 
                                       placeholder="Nhập số điện thoại..." maxlength="20">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editPartnerContactInfo" class="form-label">Thông tin liên hệ</label>
                        <textarea class="form-control" id="editPartnerContactInfo" name="ContactInfo" rows="3" 
                                  placeholder="Nhập thông tin liên hệ..." maxlength="500"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editPartnerAvatarFile" class="form-label">Avatar</label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="editPartnerAvatarFile" name="AvatarFile" accept="image/*">
                            <label class="custom-file-label" for="editPartnerAvatarFile">Chọn ảnh avatar...</label>
                        </div>
                        <small class="form-text text-muted">Chọn ảnh đại diện cho đối tác (JPG, PNG, GIF)</small>
                        
                        <!-- Current Avatar Display -->
                        <div id="currentAvatarPreview" class="mt-3" style="display: none;">
                            <div class="d-flex align-items-center">
                                <div class="avatar-container">
                                    <img id="currentAvatarImg" src="" alt="Avatar hiện tại" 
                                         class="img-thumbnail rounded-circle current-avatar" 
                                         style="width: 80px; height: 80px; object-fit: cover;">
                                </div>
                                <div class="ml-3">
                                    <h6 class="mb-1">Ảnh hiện tại</h6>
                                    <small class="text-muted">Chọn ảnh mới để thay thế</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- No Avatar Message - Only show when no avatar exists -->
                        <div id="noAvatarMessage" class="mt-3" style="display: none;">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle bg-light text-muted d-flex align-items-center justify-content-center" 
                                     style="width: 80px; height: 80px; border: 2px dashed #dee2e6;">
                                    <i class="fas fa-user fa-2x"></i>
                                </div>
                                <div class="ml-3">
                                    <h6 class="mb-1 text-muted">Chưa có avatar</h6>
                                    <small class="text-muted">Chọn ảnh để thêm avatar</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Avatar Info Message - Show when avatar exists -->
                        <div id="avatarInfoMessage" class="mt-3" style="display: none;">
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="fas fa-info-circle mr-2"></i>
                                <div>
                                    <strong>Avatar hiện tại:</strong> Đối tác đã có ảnh đại diện. Chọn ảnh mới để thay thế.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editPartnerUserId" class="form-label">Người dùng liên kết</label>
                        <select class="form-control" id="editPartnerUserId" name="UserId">
                            <option value="">-- Chọn người dùng (tùy chọn) --</option>
                            <!-- Options sẽ được load bằng JavaScript -->
                        </select>
                        <small class="form-text text-muted">Liên kết với tài khoản người dùng (không bắt buộc)</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditPartnerModal()">Hủy</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save mr-2"></i>Cập nhật
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deletePartnerModal" tabindex="-1" role="dialog" aria-labelledby="deletePartnerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deletePartnerModalLabel">Xác nhận xóa đối tác</h5>
                <button type="button" class="close" onclick="closeDeletePartnerModal()" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="deletePartnerInfo">
                    <p>Bạn có chắc chắn muốn xóa đối tác "<span id="partnerNameToDelete"></span>"?</p>
                    <div id="locationCountWarning" class="alert alert-warning" style="display: none;">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <strong>Cảnh báo:</strong> Đối tác này có <span id="locationCount"></span> địa điểm. 
                        Bạn cần xóa hoặc chuyển các địa điểm này trước khi xóa đối tác.
                    </div>
                </div>
                
                <div class="alert alert-danger mt-3">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Lưu ý:</strong> Hành động này không thể hoàn tác!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeletePartnerModal()">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeletePartner" onclick="confirmDeletePartner()">
                    <i class="fas fa-trash mr-2"></i>Xóa đối tác
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        .avatar-container {
            position: relative;
            display: inline-block;
        }
        
        .avatar-container img {
            transition: all 0.3s ease;
        }
        
        .avatar-container:hover img {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .avatar-preview img {
            transition: all 0.3s ease;
        }
        
        .avatar-preview:hover img {
            transform: scale(1.05);
        }
        
        .current-avatar {
            border: 2px solid #e3e6f0;
            transition: border-color 0.3s ease;
        }
        
        .current-avatar:hover {
            border-color: #007bff;
        }
        
        .avatar-status-indicator {
            position: relative;
        }
        
        .avatar-status-indicator::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .avatar-status-indicator.has-avatar::after {
            background-color: #28a745;
        }
        
        .avatar-status-indicator.no-avatar::after {
            background-color: #6c757d;
        }
    </style>
    <script>
        function editPartner(partnerId, partnerName) {
            // Load partner data via AJAX
            $.ajax({
                url: '@Url.Action("GetPartnerForEdit", "Admin")',
                type: 'GET',
                data: { id: partnerId },
                success: function(data) {
                    if (data.success) {
                        var partner = data.partner;
                        
                        // Fill form fields
                        $('#editPartnerId').val(partner.partnerId);
                        $('#editPartnerName').val(partner.name);
                        $('#editPartnerStatus').val(partner.status);
                        $('#editPartnerEmail').val(partner.email || '');
                        $('#editPartnerPhone').val(partner.phone || '');
                        $('#editPartnerContactInfo').val(partner.contactInfo || '');
                        
                        // Load users and set selected user
                        loadUsersForEditModal(partner.userId);
                        
                        // Show current avatar if exists
                        if (partner.avatar && partner.avatar.trim() !== '') {
                            $('#currentAvatarImg').attr('src', partner.avatar);
                            $('#currentAvatarPreview').show();
                            $('#noAvatarMessage').hide();
                            $('#avatarInfoMessage').show();
                        } else {
                            $('#currentAvatarPreview').hide();
                            $('#noAvatarMessage').show();
                            $('#avatarInfoMessage').hide();
                        }
                        
                        // Reset file input
                        $('#editPartnerAvatarFile').val('');
                        $('#editPartnerAvatarFile').next('.custom-file-label').html('Chọn ảnh avatar...');
                        $('.avatar-preview').remove();
                        
                        $('#editPartnerModal').modal('show');
                    } else {
                        alert('Không thể tải thông tin đối tác');
                    }
                },
                error: function() {
                    alert('Có lỗi xảy ra khi tải thông tin đối tác');
                }
            });
        }
        
        function closeEditPartnerModal() {
            $('#editPartnerModal').modal('hide');
        }
        
        function loadUsersForEditModal(selectedUserId) {
            $.ajax({
                url: '@Url.Action("GetUsersForDropdown", "Admin")',
                type: 'GET',
                success: function(data) {
                    if (data.success) {
                        var dropdown = $('#editPartnerUserId');
                        dropdown.empty();
                        dropdown.append('<option value="">-- Chọn người dùng (tùy chọn) --</option>');
                        
                        data.users.forEach(function(user) {
                            var selected = user.id == selectedUserId ? 'selected' : '';
                            dropdown.append('<option value="' + user.id + '" ' + selected + '>' + user.name + ' (' + user.email + ')</option>');
                        });
                    } else {
                        console.error('Error loading users:', data.message);
                    }
                },
                error: function() {
                    console.error('Error loading users for dropdown');
                }
            });
        }
        
        function deletePartner(partnerId, partnerName, locationCount) {
            console.log('deletePartner called:', partnerId, partnerName, locationCount);
            
            $('#partnerNameToDelete').text(partnerName);
            
            if (locationCount > 0) {
                $('#locationCount').text(locationCount);
                $('#locationCountWarning').show();
                $('#confirmDeletePartner').prop('disabled', true);
            } else {
                $('#locationCountWarning').hide();
                $('#confirmDeletePartner').prop('disabled', false);
            }
            
            $('#deletePartnerModal').data('partnerId', partnerId);
            $('#deletePartnerModal').modal('show');
        }
        
        function closeDeletePartnerModal() {
            console.log('closeDeletePartnerModal called');
            $('#deletePartnerModal').modal('hide');
        }
        
        function confirmDeletePartner() {
            console.log('confirmDeletePartner called');
            
            var partnerId = $('#deletePartnerModal').data('partnerId');
            
            $('#confirmDeletePartner').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>Đang xóa...');
            
            var form = $('<form>', {
                'method': 'POST',
                'action': '@Url.Action("DeletePartner", "Admin")'
            });
            
            var token = $('input[name="__RequestVerificationToken"]').val();
            if (!token) {
                token = $('meta[name="__RequestVerificationToken"]').attr('content');
            }
            
            form.append($('<input>', {
                'type': 'hidden',
                'name': '__RequestVerificationToken',
                'value': token
            }));
            
            form.append($('<input>', {
                'type': 'hidden',
                'name': 'id',
                'value': partnerId
            }));
            
            $('body').append(form);
            form.submit();
            
            return false;
        }
        
        function togglePartnerStatus(partnerId, status) {
            var form = $('<form>', {
                'method': 'POST',
                'action': '@Url.Action("TogglePartnerStatus", "Admin")'
            });
            
            var token = $('input[name="__RequestVerificationToken"]').val();
            if (!token) {
                token = $('meta[name="__RequestVerificationToken"]').attr('content');
            }
            
            form.append($('<input>', {
                'type': 'hidden',
                'name': '__RequestVerificationToken',
                'value': token
            }));
            
            form.append($('<input>', {
                'type': 'hidden',
                'name': 'id',
                'value': partnerId
            }));
            
            form.append($('<input>', {
                'type': 'hidden',
                'name': 'status',
                'value': status
            }));
            
            $('body').append(form);
            form.submit();
        }
        
        function exportPartners() {
            alert('Tính năng xuất Excel sẽ được phát triển sau');
        }
        
        function testDatabaseConnection() {
            $.ajax({
                url: '@Url.Action("TestDatabaseConnection", "Admin")',
                type: 'GET',
                success: function(data) {
                    if (data.success) {
                        alert('Database OK!\nPartners: ' + data.partnerCount + '\nUsers: ' + data.userCount);
                    } else {
                        alert('Database Error: ' + data.message);
                    }
                },
                error: function() {
                    alert('AJAX Error: Cannot connect to server');
                }
            });
        }
        
        function testCreatePartner() {
            if (confirm('Tạo partner test?')) {
                $.ajax({
                    url: '@Url.Action("TestCreatePartner", "Admin")',
                    type: 'POST',
                    success: function(data) {
                        if (data.success) {
                            alert('Test Success: ' + data.message);
                            location.reload(); // Reload to see new partner
                        } else {
                            alert('Test Failed: ' + data.message);
                        }
                    },
                    error: function() {
                        alert('AJAX Error: Cannot connect to server');
                    }
                });
            }
        }
        
        function testCreatePartnerWithoutUser() {
            if (confirm('Tạo partner test không có user?')) {
                $.ajax({
                    url: '@Url.Action("TestCreatePartnerWithoutUser", "Admin")',
                    type: 'POST',
                    success: function(data) {
                        if (data.success) {
                            alert('Test Success: ' + data.message);
                            location.reload(); // Reload to see new partner
                        } else {
                            alert('Test Failed: ' + data.message);
                        }
                    },
                    error: function() {
                        alert('AJAX Error: Cannot connect to server');
                    }
                });
            }
        }
        
        // Form validation
        $(document).ready(function() {
            // Handle file input change for edit modal
            $('#editPartnerAvatarFile').on('change', function() {
                var fileName = $(this).val().split('\\').pop();
                $(this).next('.custom-file-label').html(fileName || 'Chọn ảnh avatar...');
                
                // Preview image
                if (this.files && this.files[0]) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        // Remove existing preview
                        $('.avatar-preview').remove();
                        
                        // Add new preview
                        $('#editPartnerAvatarFile').closest('.form-group').append(
                            '<div class="mt-3 avatar-preview">' +
                            '<div class="d-flex align-items-center">' +
                            '<div class="avatar-container">' +
                            '<img src="' + e.target.result + '" alt="Preview" class="img-thumbnail rounded-circle" style="width: 80px; height: 80px; object-fit: cover; border: 2px solid #28a745;">' +
                            '</div>' +
                            '<div class="ml-3">' +
                            '<h6 class="mb-1 text-success">Ảnh mới</h6>' +
                            '<small class="text-muted">Ảnh sẽ được cập nhật khi lưu</small>' +
                            '</div>' +
                            '</div>' +
                            '</div>'
                        );
                    };
                    reader.readAsDataURL(this.files[0]);
                } else {
                    // Remove preview if no file selected
                    $('.avatar-preview').remove();
                }
            });
            
            $('#editPartnerForm').validate({
                rules: {
                    Name: {
                        required: true,
                        minlength: 2,
                        maxlength: 100
                    },
                    Status: {
                        required: true
                    },
                    Email: {
                        email: true,
                        maxlength: 100
                    },
                    Phone: {
                        maxlength: 20
                    },
                    ContactInfo: {
                        maxlength: 500
                    },
                    AvatarFile: {
                        accept: "image/*"
                    }
                },
                messages: {
                    Name: {
                        required: "Vui lòng nhập tên đối tác",
                        minlength: "Tên đối tác phải có ít nhất 2 ký tự",
                        maxlength: "Tên đối tác không được vượt quá 100 ký tự"
                    },
                    Status: {
                        required: "Vui lòng chọn trạng thái"
                    },
                    Email: {
                        email: "Email không hợp lệ",
                        maxlength: "Email không được vượt quá 100 ký tự"
                    },
                    Phone: {
                        maxlength: "Số điện thoại không được vượt quá 20 ký tự"
                    },
                    ContactInfo: {
                        maxlength: "Thông tin liên hệ không được vượt quá 500 ký tự"
                    },
                    AvatarFile: {
                        accept: "Vui lòng chọn file ảnh hợp lệ (JPG, PNG, GIF)"
                    }
                }
            });
            
            // Initialize DataTable
            $('#partnersTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json"
                },
                "pageLength": 25,
                "order": [[0, "asc"]], // Sort by ID asc
                "searching": false, // Disable DataTable search since we have custom search
                "info": false, // Hide "Showing X to Y of Z entries" since we have custom search
                "columnDefs": [
                    { "orderable": false, "targets": [6] } // Disable sorting for action column
                ]
            });
        });
    </script>
}
