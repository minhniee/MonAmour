@model MonAmour.AuthViewModel.UpdateReviewViewModel
@{
    ViewData["Title"] = "Cập Nhật Đánh Giá";
    Layout = "_Layout";
    string targetType = ViewBag.TargetType ?? "";
    int targetId = ViewBag.TargetId ?? 0;
    string targetName = ViewBag.TargetName ?? "";
}

<div class="min-h-screen bg-beige">
    <div class="max-w-2xl mx-auto px-4 py-8">
        <div class="mb-6">
            <nav aria-label="breadcrumb">
                <ol class="flex items-center space-x-2 text-sm text-gray-600">
                    <li><a href="@Url.Action("Index", new { targetType = targetType, targetId = targetId })" class="hover:text-wine-red">Danh Sách Đánh Giá</a></li>
                    <li class="before:content-['/'] before:mx-2">Cập Nhật Đánh Giá</li>
                </ol>
            </nav>
            <h1 class="text-3xl font-serif font-bold text-wine-red mt-4">Cập Nhật Đánh Giá</h1>
        </div>

        <div class="bg-white rounded-lg shadow-sm border p-6">
            @if (!string.IsNullOrEmpty(targetName))
            {
                <div class="bg-gray-50 rounded-md p-4 mb-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-@(targetType == "Product" ? "box" : "lightbulb") text-wine-red"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-gray-900">Đang đánh giá: @(targetType == "Product" ? "Sản phẩm" : "Ý tưởng")</h3>
                            <p class="text-sm text-gray-600">@targetName (ID: @targetId)</p>
                        </div>
                    </div>
                </div>
            }

            <form asp-action="Update" method="post">
                @Html.AntiForgeryToken()
                <input asp-for="ReviewId" type="hidden" />
                <input type="hidden" name="targetType" value="@targetType" />
                <input type="hidden" name="targetId" value="@targetId" />
                
                <div asp-validation-summary="ModelOnly" class="mb-4 p-4 bg-red-50 border border-red-200 rounded-md text-red-700" role="alert"></div>

                <div class="mb-6">
                    <label asp-for="Rating" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-star text-wine-red mr-2"></i>Đánh Giá
                    </label>
                    <div class="flex items-center space-x-2">
                        <div class="flex space-x-1" id="rating-stars">
                            @for (int i = 1; i <= 5; i++)
                            {
                                <button type="button" class="star-button text-2xl text-gray-300 hover:text-yellow-400 focus:outline-none" 
                                        data-rating="@i" onclick="setRating(@i)">
                                    <i class="fas fa-star"></i>
                                </button>
                            }
                        </div>
                        <span id="rating-text" class="text-sm text-gray-600 ml-3">Chưa chọn</span>
                    </div>
                    <input asp-for="Rating" type="hidden" id="rating-input" />
                    <span asp-validation-for="Rating" class="text-sm text-red-600 mt-1 block"></span>
                </div>

                <div class="mb-6">
                    <label asp-for="Comment" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-comment text-wine-red mr-2"></i>Nhận Xét (Tùy chọn)
                    </label>
                    <textarea asp-for="Comment" rows="5" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-wine-red focus:border-wine-red" 
                              placeholder="Chia sẻ trải nghiệm của bạn về sản phẩm/ý tưởng này..."></textarea>
                    <span asp-validation-for="Comment" class="text-sm text-red-600 mt-1 block"></span>
                    <div class="flex justify-between items-center mt-1">
                        <p class="text-sm text-gray-500">Tối đa 1000 ký tự</p>
                        <span id="comment-count" class="text-sm text-gray-500">0/1000</span>
                    </div>
                </div>

                <div class="flex items-center justify-between pt-6 border-t border-gray-200">
                    <a href="@Url.Action("Index", new { targetType = targetType, targetId = targetId })" 
                       class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        <i class="fas fa-arrow-left mr-2"></i>Quay Lại
                    </a>
                    <div class="space-x-3">
                        <form asp-action="Delete" method="post" style="display: inline;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.ReviewId" />
                            <input type="hidden" name="targetType" value="@targetType" />
                            <input type="hidden" name="targetId" value="@targetId" />
                            <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" 
                                    onclick="return confirm('Bạn có chắc chắn muốn xóa đánh giá này?')">
                                <i class="fas fa-trash mr-2"></i>Xóa Đánh Giá
                            </button>
                        </form>
                        <button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-wine-red border border-transparent rounded-md hover:bg-wine-red/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-wine-red">
                            <i class="fas fa-save mr-2"></i>Cập Nhật Đánh Giá
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-md p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-yellow-800">Lưu ý khi cập nhật</h3>
                    <div class="mt-2 text-sm text-yellow-700">
                        <ul class="list-disc list-inside space-y-1">
                            <li>Thay đổi đánh giá sẽ được lưu lại và hiển thị với người dùng khác</li>
                            <li>Thời gian cập nhật sẽ được ghi nhận</li>
                            <li>Bạn có thể xóa đánh giá này nếu không còn muốn chia sẻ</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentRating = @(Model.Rating);
    
    function setRating(rating) {
        currentRating = rating;
        document.getElementById('rating-input').value = rating;
        updateStarDisplay();
        updateRatingText();
    }
    
    function updateStarDisplay() {
        const stars = document.querySelectorAll('.star-button');
        stars.forEach((star, index) => {
            const starIcon = star.querySelector('i');
            if (index < currentRating) {
                starIcon.className = 'fas fa-star text-yellow-400';
            } else {
                starIcon.className = 'fas fa-star text-gray-300';
            }
        });
    }
    
    function updateRatingText() {
        const textElement = document.getElementById('rating-text');
        const ratingTexts = {
            1: '1 sao - Rất tệ',
            2: '2 sao - Tệ',
            3: '3 sao - Bình thường',
            4: '4 sao - Tốt',
            5: '5 sao - Rất tốt'
        };
        
        if (currentRating > 0) {
            textElement.textContent = ratingTexts[currentRating];
            textElement.className = 'text-sm text-wine-red ml-3 font-medium';
        } else {
            textElement.textContent = 'Chưa chọn';
            textElement.className = 'text-sm text-gray-600 ml-3';
        }
    }

    // Comment character counter
    function updateCommentCount() {
        const textarea = document.querySelector('textarea[name="Comment"]');
        const counter = document.getElementById('comment-count');
        const currentLength = textarea.value.length;
        counter.textContent = `${currentLength}/1000`;
        
        if (currentLength > 1000) {
            counter.className = 'text-sm text-red-500';
        } else if (currentLength > 900) {
            counter.className = 'text-sm text-yellow-600';
        } else {
            counter.className = 'text-sm text-gray-500';
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Set the rating input value
        document.getElementById('rating-input').value = currentRating;
        updateStarDisplay();
        updateRatingText();
        
        const textarea = document.querySelector('textarea[name="Comment"]');
        textarea.addEventListener('input', updateCommentCount);
        updateCommentCount();

        // Add hover effects to stars
        const stars = document.querySelectorAll('.star-button');
        stars.forEach((star, index) => {
            star.addEventListener('mouseenter', function() {
                const hoverRating = index + 1;
                stars.forEach((s, i) => {
                    const starIcon = s.querySelector('i');
                    if (i < hoverRating) {
                        starIcon.className = 'fas fa-star text-yellow-400';
                    } else {
                        starIcon.className = 'fas fa-star text-gray-300';
                    }
                });
            });
            
            star.addEventListener('mouseleave', function() {
                updateStarDisplay();
            });
        });
    });
</script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
