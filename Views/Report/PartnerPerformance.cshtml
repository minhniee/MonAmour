@{
    ViewData["Title"] = "Hiệu suất Đối tác";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-handshake mr-2"></i>Hiệu suất Đối tác
        </h1>
        <div class="d-flex">
            <div class="input-group mr-3" style="width: 300px;">
                <input type="date" id="startDate" class="form-control" placeholder="Từ ngày">
                <input type="date" id="endDate" class="form-control" placeholder="Đến ngày">
                <div class="input-group-append">
                    <button class="btn btn-primary" type="button" onclick="filterData()">
                        <i class="fas fa-filter"></i> Lọc
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Partner Performance Summary -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Tổng đối tác
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalPartners">
                                @(ViewBag.PerformanceData?.Count ?? 0)
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-handshake fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Tổng doanh thu
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalRevenue">
                                @{
                                    var totalRevenue = ViewBag.PerformanceData != null ? 
                                        ((List<MonAmour.ViewModels.PartnerPerformanceViewModel>)ViewBag.PerformanceData).Sum(p => p.TotalRevenue) : 0;
                                }
                                @totalRevenue.ToString("N0") VNĐ
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Tổng đặt chỗ
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalBookings">
                                @{
                                    var totalBookings = ViewBag.PerformanceData != null ? 
                                        ((List<MonAmour.ViewModels.PartnerPerformanceViewModel>)ViewBag.PerformanceData).Sum(p => p.BookingCount) : 0;
                                }
                                @totalBookings
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Đối tác hoạt động
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="activePartners">
                                @{
                                    var activePartners = ViewBag.PerformanceData != null ? 
                                        ((List<MonAmour.ViewModels.PartnerPerformanceViewModel>)ViewBag.PerformanceData).Count(p => p.Status == "active") : 0;
                                }
                                @activePartners
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Charts Row -->
    <div class="row">
        <!-- Partner Revenue Chart -->
        <div class="col-xl-6 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Doanh thu theo đối tác</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="partnerRevenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Partner Booking Chart -->
        <div class="col-xl-6 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Số đặt chỗ theo đối tác</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="partnerBookingChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Partner Performance Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Bảng hiệu suất đối tác</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Đối tác</th>
                                    <th>Doanh thu</th>
                                    <th>Số đặt chỗ</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (ViewBag.PerformanceData != null)
                                {
                                    @foreach (var partner in ViewBag.PerformanceData)
                                    {
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    @if (!string.IsNullOrEmpty(partner.Avatar))
                                                    {
                                                        <img src="@partner.Avatar" class="img-thumbnail mr-2" style="width: 40px; height: 40px; object-fit: cover;">
                                                    }
                                                    <div>
                                                        <div class="font-weight-bold">@partner.PartnerName</div>
                                                        <small class="text-muted">@partner.Email</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>@partner.TotalRevenue.ToString("N0") VNĐ</td>
                                            <td>@partner.BookingCount</td>
                                            <td>
                                                <span class="badge @(partner.Status == "active" ? "badge-success" : "badge-secondary")">
                                                    @(partner.Status == "active" ? "Hoạt động" : "Không hoạt động")
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let partnerRevenueChart, partnerBookingChart;

        // Prepare data
        let performanceData = [];
        
        try {
            performanceData = @Html.Raw(Json.Serialize(ViewBag.PerformanceData ?? new List<MonAmour.ViewModels.PartnerPerformanceViewModel>()));
            console.log('Performance data loaded from server:', performanceData);
            console.log('Performance data count:', performanceData.length);
            
            // Log first few items for debugging
            if (performanceData && performanceData.length > 0) {
                console.log('First partner data:', performanceData[0]);
                console.log('All partner data:', performanceData);
                console.log('Total revenue from first 3 partners:', performanceData.slice(0, 3).reduce((sum, p) => sum + (p.TotalRevenue || 0), 0));
                console.log('Total bookings from first 3 partners:', performanceData.slice(0, 3).reduce((sum, p) => sum + (p.BookingCount || 0), 0));
                
                // Check property names
                if (performanceData[0]) {
                    console.log('Available properties:', Object.keys(performanceData[0]));
                    console.log('TotalRevenue property:', performanceData[0].TotalRevenue);
                    console.log('totalRevenue property:', performanceData[0].totalRevenue);
                    console.log('BookingCount property:', performanceData[0].BookingCount);
                    console.log('bookingCount property:', performanceData[0].bookingCount);
                }
            }
        } catch (e) {
            console.error('Error serializing performance data:', e);
            performanceData = [];
        }
        
        // Only create test data if no real data AND no data from server
        if ((performanceData || []).length === 0) {
            console.log('No performance data found, creating test data');
            performanceData = [
                {
                    PartnerId: 1,
                    PartnerName: "Test Partner 1",
                    Email: "test1@example.com",
                    Avatar: "",
                    LocationCount: 2,
                    ConceptCount: 5,
                    BookingCount: 10,
                    TotalRevenue: 5000000,
                    Status: "active"
                },
                {
                    PartnerId: 2,
                    PartnerName: "Test Partner 2",
                    Email: "test2@example.com",
                    Avatar: "",
                    LocationCount: 1,
                    ConceptCount: 3,
                    BookingCount: 7,
                    TotalRevenue: 3000000,
                    Status: "active"
                }
            ];
        } else {
            console.log('Using real data from server:', performanceData.length, 'partners');
        }

        const partnerLabels = (performanceData || []).map(p => p.PartnerName || p.partnerName || '');
        const partnerRevenueData = (performanceData || []).map(p => p.TotalRevenue || p.totalRevenue || 0);
        const partnerBookingData = (performanceData || []).map(p => p.BookingCount || p.bookingCount || 0);

        $(document).ready(function() {
            try {
                updateSummaryCards();
                initializeCharts();
                setupEventHandlers();
                hideLoading();
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                hideLoading();
            }
        });

        function updateSummaryCards() {
            console.log('Updating summary cards with data:', performanceData);
            
            const totalRevenue = (performanceData || []).reduce((sum, p) => sum + (p.TotalRevenue || p.totalRevenue || 0), 0);
            const totalBookings = (performanceData || []).reduce((sum, p) => sum + (p.BookingCount || p.bookingCount || 0), 0);
            const activePartners = (performanceData || []).filter(p => (p.Status || p.status) === "active").length;
            
            console.log('Calculated totals:', { totalRevenue, totalBookings, activePartners });
            
            // Only update if we have data
            if ((performanceData || []).length > 0) {
                // Update summary cards with JavaScript calculations
                document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString() + ' VNĐ';
                document.getElementById('totalBookings').textContent = totalBookings.toString();
                document.getElementById('activePartners').textContent = activePartners.toString();
                
                // Update total partners count
                document.getElementById('totalPartners').textContent = (performanceData || []).length.toString();
                
                console.log('Summary cards updated with JavaScript data');
            } else {
                console.warn('No performance data found for JavaScript update');
            }
        }

        function initializeCharts() {
            // Destroy existing charts if they exist
            if (partnerRevenueChart) {
                partnerRevenueChart.destroy();
            }
            if (partnerBookingChart) {
                partnerBookingChart.destroy();
            }

            // Partner Revenue Chart
            const revenueCtx = document.getElementById('partnerRevenueChart').getContext('2d');
            partnerRevenueChart = new Chart(revenueCtx, {
                type: 'bar',
                data: {
                    labels: partnerLabels,
                    datasets: [{
                        label: 'Doanh thu (VNĐ)',
                        data: partnerRevenueData,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' VNĐ';
                                }
                            }
                        }
                    }
                }
            });

            // Partner Booking Chart
            const bookingCtx = document.getElementById('partnerBookingChart').getContext('2d');
            partnerBookingChart = new Chart(bookingCtx, {
                type: 'bar',
                data: {
                    labels: partnerLabels,
                    datasets: [{
                        label: 'Số đặt chỗ',
                        data: partnerBookingData,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function setupEventHandlers() {
            // Set default date range (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        }

        function filterData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('Vui lòng chọn khoảng thời gian');
                return;
            }
            
            // Show loading indicator
            showLoading();
            
            // Reload page with date parameters
            const url = new URL(window.location);
            url.searchParams.set('startDate', startDate);
            url.searchParams.set('endDate', endDate);
            window.location.href = url.toString();
        }

        function showLoading() {
            // Add loading class to charts
            document.getElementById('partnerRevenueChart').style.opacity = '0.5';
            document.getElementById('partnerBookingChart').style.opacity = '0.5';
        }

        function hideLoading() {
            // Remove loading class from charts
            document.getElementById('partnerRevenueChart').style.opacity = '1';
            document.getElementById('partnerBookingChart').style.opacity = '1';
        }

        function exportData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let url = '@Url.Action("ExportPartnerPerformance", "Report")';
            if (startDate && endDate) {
                url += `?startDate=${startDate}&endDate=${endDate}`;
            }
            
            window.open(url, '_blank');
        }

        function refreshCharts() {
            try {
                initializeCharts();
                updateSummaryCards();
            } catch (error) {
                console.error('Error refreshing charts:', error);
            }
        }

        // Handle window resize
        $(window).on('resize', function() {
            if (partnerRevenueChart || partnerBookingChart) {
                setTimeout(refreshCharts, 100);
            }
        });

    </script>
}