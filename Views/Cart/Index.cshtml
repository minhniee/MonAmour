@model MonAmour.Models.Order
@{
    ViewData["Title"] = "Gi·ªè h√†ng";
    var paidFlag = Context.Request.Query["paid"].ToString();
    var paid = !string.IsNullOrEmpty(paidFlag) && paidFlag.ToLower() == "true";
}

<div class="min-h-screen bg-beige">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <h1 class="font-prata text-3xl md:text-4xl text-wine-red mb-8">Gi·ªè h√†ng c·ªßa b·∫°n</h1>

        @if (Model == null || Model.OrderItems == null || !Model.OrderItems.Any())
        {
            <div class="bg-white border border-wine-red/20 rounded-xl p-8 text-center text-wine-red/80">
                Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong gi·ªè h√†ng.
            </div>
        }
        else
        {
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-4">
                    @foreach (var item in Model.OrderItems)
                    {
                        <div class="bg-white border border-wine-red/20 rounded-xl p-4 flex items-center justify-between">
                            <div>
                                <div class="font-prata text-wine-red text-lg">@item.Product?.Name</div>
                                <div class="text-wine-red/70">@String.Format("{0:N0}‚Ç´", item.UnitPrice) √ó @item.Quantity</div>
                            </div>
                            <div class="flex items-center gap-3">
                                <form asp-controller="Cart" asp-action="Update" method="post" class="flex items-center gap-2 auto-update-form">
                                    <input type="hidden" name="itemId" value="@item.OrderItemId" />
                                    <input type="number" name="quantity" value="@item.Quantity" min="1" class="w-20 border border-wine-red/30 rounded px-2 py-1 text-center cart-qty-input" />
                                </form>
                                <form asp-controller="Cart" asp-action="Remove" method="post">
                                    <input type="hidden" name="itemId" value="@item.OrderItemId" />
                                    <button type="submit" class="px-3 py-2 border border-wine-red text-wine-red rounded">X√≥a</button>
                                </form>
                            </div>
                        </div>
                    }
                </div>

                <div>
                    <div class="bg-white border border-wine-red/20 rounded-xl p-6">
                        <div class="flex items-center justify-between font-prata text-lg text-wine-red">
                            <span>T·ªïng c·ªông</span>
                            <span id="cart-total" data-total="@Model.TotalPrice">@String.Format("{0:N0}‚Ç´", Model.TotalPrice)</span>
                        </div>
                        <div class="mt-4">
                            <label for="shipping-phone" class="block font-prata text-wine-red mb-2">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input id="shipping-phone" class="w-full border border-wine-red/30 rounded-lg p-3 mb-3" placeholder="V√≠ d·ª•: 0912345678" value="@((Model.ShippingAddress!=null && Model.ShippingAddress.Contains("Phone:")) ? Model.ShippingAddress.Split('|').FirstOrDefault()?.Replace("Phone:", "").Trim() : "")" />
                            <label for="shipping-address" class="block font-prata text-wine-red mb-2">ƒê·ªãa ch·ªâ giao h√†ng</label>
                            <textarea id="shipping-address" class="w-full border border-wine-red/30 rounded-lg p-3" rows="3" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß">@Model.ShippingAddress</textarea>
                            <div class="text-sm text-wine-red/60 mt-1" id="address-status"></div>
                        </div>
                        <!-- Removed general checkout button; we use VietQR only -->
                        <button id="vietqr-btn" class="w-full mt-3 border border-wine-red text-wine-red px-4 py-3 rounded-lg">Thanh to√°n VietQR</button>
                        <div id="vietqr-wrap" class="mt-4 hidden text-center">
                            <div class="inline-block bg-white border border-wine-red/20 rounded-xl p-4">
                                <img id="vietqr-img" alt="VietQR" class="mx-auto w-64 h-64 object-contain" />
                                <div class="mt-2 text-sm text-wine-red/70 font-noto-serif" id="vietqr-note"></div>
                            </div>
                        </div>
                        
                        <div id="casso-wrap" class="mt-4 hidden">
                            <div class="bg-white border border-wine-red/20 rounded-xl p-4">
                                <div class="text-center mb-4">
                                    <h3 class="font-prata text-wine-red text-lg mb-2">H∆∞·ªõng d·∫´n thanh to√°n</h3>
                                    <div id="casso-qr-code" class="mb-4"></div>
                                    <div id="casso-instructions" class="text-sm text-wine-red/70 font-noto-serif space-y-1"></div>
                                </div>
                                <div class="flex gap-2">
                                    <button id="casso-check-btn" class="flex-1 bg-wine-red text-beige px-4 py-2 rounded-lg text-sm">Ki·ªÉm tra thanh to√°n</button>
                                    <button id="casso-refresh-btn" class="px-4 py-2 border border-wine-red text-wine-red rounded-lg text-sm">L√†m m·ªõi</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<script>
(function(){
    // Show toast when redirected back after payment
    const paid = @paid.ToString().ToLower();
    const cartSuccess = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(TempData["CartSuccess"] as string ?? ""));
    if (paid || cartSuccess) {
        const toast = document.createElement('div');
        toast.textContent = cartSuccess || 'Thanh to√°n th√†nh c√¥ng';
        toast.className = 'fixed bottom-6 right-6 bg-wine-red text-beige px-4 py-3 rounded-lg shadow-lg';
        toast.style.zIndex = '9999';
        toast.style.fontFamily = 'Noto Serif, serif';
        document.body.appendChild(toast);
        setTimeout(()=>{ toast.style.transition='opacity .5s'; toast.style.opacity='0'; setTimeout(()=>toast.remove(), 500); }, 2500);
    }

    const form = document.getElementById('checkout-form');
    if(form){
        form.addEventListener('submit', async function(e){
            e.preventDefault();
            try {
                const formData = new FormData(form);
                const res = await fetch(form.action, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    credentials: 'same-origin',
                    body: formData
                });
                const data = await res.json();
                if (data && data.success) {
                    const toast = document.createElement('div');
                    toast.textContent = data.message || 'Thanh to√°n th√†nh c√¥ng';
                    toast.className = 'fixed bottom-6 right-6 bg-wine-red text-beige px-4 py-3 rounded-lg shadow-lg';
                    toast.style.zIndex = '9999';
                    toast.style.fontFamily = 'Noto Serif, serif';
                    document.body.appendChild(toast);
                    setTimeout(()=>{ toast.style.transition='opacity .5s'; toast.style.opacity='0'; setTimeout(()=>toast.remove(), 500); }, 2000);
                    setTimeout(()=>{ window.location.reload(); }, 2200);
                } else if (res.status === 401) {
                    window.location.href = '@Url.Action("Login","Auth")';
                } else {
                    const errorData = await res.json().catch(()=>({message:'Thanh to√°n th·∫•t b·∫°i'}));
                    alert(errorData.message || 'Thanh to√°n th·∫•t b·∫°i');
                }
            } catch (err) {
                alert('ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        });
    }

    // Auto submit quantity change
    document.querySelectorAll('.cart-qty-input').forEach(function(input){
        input.addEventListener('change', function(){
            const form = this.closest('.auto-update-form');
            if (!form) return;
            form.submit();
        });
        input.addEventListener('input', function(){
            const form = this.closest('.auto-update-form');
            if (!form) return;
            // Debounce minor typing by delaying submit
            clearTimeout(this._debounceTimer);
            this._debounceTimer = setTimeout(()=>form.submit(), 600);
        });
    });

    // ZaloPay removed

    // Save shipping address on change (debounced)
    const addressInput = document.getElementById('shipping-address');
    const phoneInput = document.getElementById('shipping-phone');
    const addressStatus = document.getElementById('address-status');
    let addressTimer;
    if (addressInput) {
        const saveAddress = async () => {
            const addr = addressInput.value.trim();
            const phone = (phoneInput ? phoneInput.value.trim() : '');
            if (!addr) { addressStatus.textContent = 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng'; return; }
            if (!/^0[0-9]{9,10}$/.test(phone)) { addressStatus.textContent = 'Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá'; return; }
            addressStatus.textContent = 'ƒêang l∆∞u...';
            const fd = new FormData();
            fd.append('address', addr);
            fd.append('phone', phone);
            const res = await fetch('/Cart/SaveAddress', { method: 'POST', body: fd, credentials: 'same-origin' });
            const data = await res.json().catch(()=>({success:false,message:'L·ªói kh√¥ng x√°c ƒë·ªãnh'}));
            addressStatus.textContent = data.message || (data.success ? 'ƒê√£ l∆∞u' : 'Kh√¥ng th·ªÉ l∆∞u ƒë·ªãa ch·ªâ');
        };
        addressInput.addEventListener('input', function(){
            clearTimeout(addressTimer);
            addressTimer = setTimeout(saveAddress, 700);
        });
        if (phoneInput) {
            phoneInput.addEventListener('input', function(){
                clearTimeout(addressTimer);
                addressTimer = setTimeout(saveAddress, 700);
            });
            phoneInput.addEventListener('blur', saveAddress);
        }
        addressInput.addEventListener('blur', saveAddress);
    }

    // VietQR
    const vietqrBtn = document.getElementById('vietqr-btn');
    const vietqrWrap = document.getElementById('vietqr-wrap');
    const vietqrImg = document.getElementById('vietqr-img');
    const vietqrNote = document.getElementById('vietqr-note');
    const totalEl = document.getElementById('cart-total');
    if (vietqrBtn && totalEl) {
        vietqrBtn.addEventListener('click', async function(){
            try{
                // require phone and address before payment
                const addr = addressInput ? addressInput.value.trim() : '';
                const phone = phoneInput ? phoneInput.value.trim() : '';
                if (!addr) {
                    alert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng tr∆∞·ªõc khi thanh to√°n');
                    addressInput.focus();
                    return;
                }
                if (!/^0[0-9]{9,10}$/.test(phone)) {
                    alert('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá tr∆∞·ªõc khi thanh to√°n');
                    phoneInput && phoneInput.focus();
                    return;
                }
                const totalStr = totalEl.dataset.total || '0';
                const amount = Math.max(0, Math.round(parseFloat(totalStr)));
                // S·ª≠ d·ª•ng m√£ tham chi·∫øu theo ƒë∆°n ƒë·ªÉ ƒë·ªìng b·ªô v·ªõi ƒë·ªëi so√°t Casso
                const note = 'ORDER' + (@Model.OrderId);

                // Prefer verified API
                let res = await fetch('/Gift_box/GenerateVietQrVerified', {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: (()=>{ const fd = new FormData(); fd.append('amount', amount); fd.append('note', note); return fd; })()
                });
                let data = await res.json().catch(()=>null);
                if (data && data.success && data.response && data.response.data && data.response.data.qrDataURL) {
                    vietqrImg.src = data.response.data.qrDataURL;
                    vietqrNote.textContent = note + ' ‚Ä¢ ' + amount.toLocaleString('vi-VN') + '‚Ç´';
                    vietqrWrap.classList.remove('hidden');
                    
                    // Also show bank transfer instructions immediately
                    await showCassoInstructions();
                    return;
                }

                // Fallback to unsigned image endpoint
                const res2 = await fetch('/Gift_box/GenerateVietQr?amount=' + encodeURIComponent(amount) + '&note=' + encodeURIComponent(note));
                const data2 = await res2.json();
                if (data2 && data2.success && data2.url) {
                    vietqrImg.src = data2.url;
                    vietqrNote.textContent = note + ' ‚Ä¢ ' + amount.toLocaleString('vi-VN') + '‚Ç´';
                    vietqrWrap.classList.remove('hidden');
                    
                    // Also show bank transfer instructions immediately
                    await showCassoInstructions();
                } else {
                    alert((data && data.message) || (data2 && data2.message) || 'Kh√¥ng t·∫°o ƒë∆∞·ª£c VietQR');
                }
            } catch (err) {
                alert('L·ªói khi t·∫°o VietQR: ' + (err && err.message ? err.message : err));
            }
        });
    }

    // Casso Bank Transfer
    const cassoWrap = document.getElementById('casso-wrap');
    const cassoInstructions = document.getElementById('casso-instructions');
    const cassoQrCode = document.getElementById('casso-qr-code');
    const cassoCheckBtn = document.getElementById('casso-check-btn');
    const cassoRefreshBtn = document.getElementById('casso-refresh-btn');
    
    async function showCassoInstructions() {
        try {
            const res = await fetch('/Cart/GetPaymentInstructions', { credentials: 'same-origin' });
            const data = await res.json();
            
            if (data.success) {
                if (data.qrCodeUrl) {
                    cassoQrCode.innerHTML = `
                        <div class="bg-white rounded-lg p-3 border-2 border-dashed border-wine-red/30 mb-3">
                            <img src="${data.qrCodeUrl}" alt="QR Code" class="mx-auto max-w-full h-auto" style="max-height: 150px;">
                        </div>
                        <p class="text-xs text-wine-red/70 mb-2">Qu√©t m√£ QR b·∫±ng ·ª©ng d·ª•ng ng√¢n h√†ng</p>
                    `;
                } else {
                    cassoQrCode.innerHTML = '';
                }
                
                cassoInstructions.innerHTML = data.instructions.map(instruction => 
                    `<div>‚Ä¢ ${instruction}</div>`
                ).join('');
                cassoWrap.classList.remove('hidden');
            } else {
                alert(data.message || 'Kh√¥ng th·ªÉ l·∫•y h∆∞·ªõng d·∫´n thanh to√°n');
            }
        } catch (err) {
            alert('L·ªói khi l·∫•y h∆∞·ªõng d·∫´n thanh to√°n: ' + (err && err.message ? err.message : err));
        }
    }
   
    if (cassoCheckBtn) {
        cassoCheckBtn.addEventListener('click', async function(){
            try {
                cassoCheckBtn.disabled = true;
                cassoCheckBtn.textContent = 'ƒêang ki·ªÉm tra...';
                
                const res = await fetch('/Cart/CheckCassoPayment', { 
                    method: 'POST', 
                    credentials: 'same-origin' 
                });
                const data = await res.json();
                
                if (data.success) {
                    const toast = document.createElement('div');
                    toast.textContent = data.message || 'Thanh to√°n th√†nh c√¥ng';
                    toast.className = 'fixed bottom-6 right-6 bg-wine-red text-beige px-4 py-3 rounded-lg shadow-lg';
                    toast.style.zIndex = '9999';
                    toast.style.fontFamily = 'Noto Serif, serif';
                    document.body.appendChild(toast);
                    setTimeout(()=>{ toast.style.transition='opacity .5s'; toast.style.opacity='0'; setTimeout(()=>toast.remove(), 500); }, 3000);
                    
                    // Reload page after successful payment
                    setTimeout(() => { window.location.reload(); }, 2000);
                } else {
                    alert(data.message || 'Ch∆∞a c√≥ giao d·ªãch n√†o ph√π h·ª£p');
                }
            } catch (err) {
                alert('L·ªói khi ki·ªÉm tra thanh to√°n: ' + (err && err.message ? err.message : err));
            } finally {
                cassoCheckBtn.disabled = false;
                cassoCheckBtn.textContent = 'Ki·ªÉm tra thanh to√°n';
            }
        });
    }

    if (cassoRefreshBtn) {
        cassoRefreshBtn.addEventListener('click', function(){
            cassoWrap.classList.add('hidden');
        });
    }

    // Auto-refresh payment status every 30 seconds
    let autoRefreshInterval;
    function startAutoRefresh() {
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        
        autoRefreshInterval = setInterval(async () => {
            try {
                const res = await fetch('/Cart/GetPaymentStatus', { credentials: 'same-origin' });
                const data = await res.json();
                
                if (data.success && data.hasCart && data.isPaid) {
                    // Payment completed, stop auto-refresh and reload page
                    clearInterval(autoRefreshInterval);
                    const toast = document.createElement('div');
                    toast.textContent = 'üéâ Thanh to√°n th√†nh c√¥ng! ƒêang c·∫≠p nh·∫≠t...';
                    toast.className = 'fixed bottom-6 right-6 bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg';
                    toast.style.zIndex = '9999';
                    toast.style.fontFamily = 'Noto Serif, serif';
                    document.body.appendChild(toast);
                    setTimeout(() => { window.location.reload(); }, 2000);
                }
            } catch (err) {
                console.log('Auto-refresh error:', err);
            }
        }, 30000); // Check every 30 seconds
    }

    // Start auto-refresh when page loads
    startAutoRefresh();
})();
</script>


