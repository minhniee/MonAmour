@model MonAmour.ViewModels.BlogDetailViewModel
@{
    ViewData["Title"] = Model.Title + " - MonAmour Blog";
}

<div class="min-h-screen" style="background-color: #fbf1e6;">
    <!-- Header Navigation -->

    <!-- Breadcrumb -->
    <div class="container mx-auto px-4 py-4">
        <nav class="text-sm text-gray-600">
            <a href="/" class="hover:text-[#62000d]">Home</a>
            <span class="mx-2">/</span>
            <a href="/blog" class="hover:text-[#62000d]">Blog</a>
            <span class="mx-2">/</span>
            <span class="text-gray-800">@Model.Title</span>
        </nav>
    </div>

    <!-- Article Content -->
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Article Header -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
	            <div class="aspect-video  bg-gray-200 flex items-center justify-center">
		            <div class="carousel-container relative w-full h-full">
			            @if (!string.IsNullOrEmpty(Model.FeaturedImage))
			            {
				            <div class="carousel-slide active w-full h-full flex items-center justify-center">
					            <img src="@Model.FeaturedImage" 
					                 alt="@Model.Title" 
					                 @* class="max-w-full max-h-full object-contain" /> *@
					                 class="max-w-full max-h-full object-contain" />
				            </div>
			            }
			            else
			            {
				            <div class="carousel-slide active w-full h-full flex items-center justify-center">
					            <img src="~/images/placeholder-hero.jpg" 
					                 alt="Blog Placeholder" 
					                 class="max-w-full max-h-full object-contain" />
				            </div>
			            }
		            </div>
	            </div>

                <div class="p-8">
                    <div class="flex items-center text-sm text-gray-500 mb-4">
                        <span>@Model.CategoryName</span>
                        <span class="mx-2">•</span>
                        <span>@Model.AuthorName</span>
                        <span class="mx-2">•</span>
                        <span>@Model.PublishedDate?.ToString("dd/MM/yyyy")</span>
                        <span class="mx-2">•</span>
                        <span>@Model.ReadTime phút đọc</span>
                    </div>
                    <h1 class="text-3xl md:text-4xl font-bold mb-6 text-gray-800 leading-tight" style="font-family: 'Prata', serif;">
                        @Model.Title
                    </h1>
                    <p class="text-lg text-gray-600 leading-relaxed mb-6" style="font-family: 'Noto Serif', serif;">
                        @Model.Excerpt
                    </p>
                </div>
            </div>

            <!-- Article Body -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                <div class="blog-content prose prose-lg max-w-none" style="font-family: 'Noto Serif', serif;">
                    <style>
                        /* Headings */
                        .blog-content h1, .blog-content h2, .blog-content h3, 
                        .blog-content h4, .blog-content h5, .blog-content h6 {
                            font-family: 'Prata', serif;
                            font-weight: bold;
                            line-height: 1.2;
                            margin-top: 2em;
                            margin-bottom: 1em;
                            color: #333;
                        }
                        .blog-content h1 { font-size: 2.5em; }
                        .blog-content h2 { font-size: 2em; }
                        .blog-content h3 { font-size: 1.75em; }
                        .blog-content h4 { font-size: 1.5em; }
                        .blog-content h5 { font-size: 1.25em; }
                        .blog-content h6 { font-size: 1.1em; }

                        /* Paragraphs and text */
                        .blog-content p {
                            font-size: 1.1em;
                            line-height: 1.8;
                            margin-bottom: 1.5em;
                            color: #333;
                        }

                        /* Lists */
                        .blog-content ul, .blog-content ol {
                            margin: 1.5em 0 1.5em 2em;
                            padding-left: 1em;
                        }
                        .blog-content ul { list-style-type: disc; }
                        .blog-content ol { list-style-type: decimal; }
                        .blog-content li {
                            margin-bottom: 0.5em;
                            line-height: 1.6;
                        }
                        .blog-content ul ul, .blog-content ol ol,
                        .blog-content ul ol, .blog-content ol ul {
                            margin: 0.5em 0 0.5em 1em;
                        }

                        /* Text formatting */
                        .blog-content strong, .blog-content b { 
                            font-weight: bold;
                            color: #222;
                        }
                        .blog-content em, .blog-content i { font-style: italic; }
                        .blog-content u { text-decoration: underline; }
                        .blog-content strike, .blog-content del { text-decoration: line-through; }
                        .blog-content small { font-size: 0.875em; }

                        /* Links */
                        .blog-content a {
                            color: #62000d;
                            text-decoration: underline;
                            transition: color 0.2s ease;
                        }
                        .blog-content a:hover {
                            color: #8b0012;
                        }

                        /* Images */
                        .blog-content img {
                            max-width: 100%;
                            height: auto;
                            margin: 2em auto;
                            border-radius: 0.5rem;
                            display: block;
                        }
                        .blog-content figure {
                            margin: 2em 0;
                            text-align: center;
                        }
                        .blog-content figcaption {
                            font-size: 0.9em;
                            color: #666;
                            margin-top: 0.5em;
                            font-style: italic;
                        }

                        /* Blockquotes */
                        .blog-content blockquote {
                            border-left: 4px solid #62000d;
                            padding: 1em 2em;
                            margin: 2em 0;
                            background-color: #f8f8f8;
                            font-style: italic;
                            color: #555;
                        }
                        .blog-content blockquote p:last-child {
                            margin-bottom: 0;
                        }

                        /* Code blocks */
                        .blog-content pre {
                            background-color: #f4f4f4;
                            padding: 1em;
                            border-radius: 0.5rem;
                            overflow-x: auto;
                            margin: 1.5em 0;
                        }
                        .blog-content code {
                            font-family: monospace;
                            background-color: #f4f4f4;
                            padding: 0.2em 0.4em;
                            border-radius: 0.3rem;
                            font-size: 0.9em;
                        }

                        /* Tables */
                        .blog-content table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 2em 0;
                        }
                        .blog-content th, .blog-content td {
                            border: 1px solid #ddd;
                            padding: 0.75em;
                            text-align: left;
                        }
                        .blog-content th {
                            background-color: #f4f4f4;
                            font-weight: bold;
                        }
                        .blog-content tr:nth-child(even) {
                            background-color: #f8f8f8;
                        }

                        /* Definition Lists */
                        .blog-content dl {
                            margin: 1.5em 0;
                        }
                        .blog-content dt {
                            font-weight: bold;
                            margin-top: 1em;
                        }
                        .blog-content dd {
                            margin-left: 2em;
                            margin-top: 0.5em;
                        }

                        /* Horizontal Rule */
                        .blog-content hr {
                            border: none;
                            border-top: 2px solid #eee;
                            margin: 2em 0;
                        }

                        /* Subscript and Superscript */
                        .blog-content sub, .blog-content sup {
                            font-size: 0.75em;
                            line-height: 0;
                            position: relative;
                            vertical-align: baseline;
                        }
                        .blog-content sup { top: -0.5em; }
                        .blog-content sub { bottom: -0.25em; }
                    </style>
                    @Html.Raw(Model.Content)
                </div>
                
                <!-- Tags -->
                @if (!string.IsNullOrEmpty(Model.Tags))
                {
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Tags:</h3>
                        <div class="flex flex-wrap gap-2">
                            @foreach (var tag in Model.Tags.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Select(t => t.Trim()))
                            {
                                <a href="@Url.Action("Tag", "Blog", new { tag = tag })" 
                                   class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full hover:bg-[#62000d] hover:text-white transition-colors cursor-pointer">
                                    #@tag
                                </a>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- Comments Section -->
            <div class="bg-white rounded-lg shadow-lg p-8">
                <h3 class="text-2xl font-bold mb-6 text-gray-800" style="font-family: 'Prata', serif;">
                    Bình luận (<span id="commentCount">@Model.Comments.Count</span>)
                </h3>

                <!-- Comment Form -->
                <form id="commentForm" class="mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input type="text" id="authorName" placeholder="Tên của bạn" required
                               class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#62000d]">
                        <input type="email" id="authorEmail" placeholder="Email của bạn" required
                               class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#62000d]">
                    </div>
                    <textarea id="commentContent" placeholder="Viết bình luận của bạn..." rows="4" required
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#62000d] mb-4"></textarea>
                    <button type="submit" id="submitBtn" class="px-6 py-3 text-white rounded-lg transition-colors" style="background-color: #62000d;">
                        Gửi bình luận
                    </button>
                </form>

                <!-- Message Display -->
                <div id="messageDisplay" class="mb-4 hidden"></div>

                <!-- Comments List -->
                <div id="commentsList" class="space-y-6">
                    @foreach (var comment in Model.Comments)
                    {
                        <div class="comment-item border-b border-gray-200 pb-6" data-comment-id="@comment.CommentId">
                            <div class="flex items-start space-x-4">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold" style="background-color: #62000d;">
                                    @(comment.AuthorName?.Substring(0, 1).ToUpper() ?? "A")
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <h4 class="font-semibold text-gray-800">@comment.AuthorName</h4>
                                            <span class="text-sm text-gray-500">@comment.CreatedAt?.ToString("dd/MM/yyyy HH:mm")</span>
                                        </div>
                                        <!-- Delete button for admin or comment author -->
                                        @if (ViewBag.CurrentUserId != null && (comment.UserId == ViewBag.CurrentUserId || ViewBag.IsAdmin == true))
                                        {
                                            <button onclick="deleteComment(@comment.CommentId)" class="text-red-500 hover:text-red-700 text-sm">
                                                <i class="fas fa-trash"></i> Xóa
                                            </button>
                                        }
                                    </div>
                                    <p class="text-gray-700 leading-relaxed" style="font-family: 'Noto Serif', serif;">
                                        @comment.Content
                                    </p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Related Posts -->
            @if (Model.RelatedPosts.Any())
            {
                <div class="mt-12">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800" style="font-family: 'Prata', serif;">
                        Bài viết liên quan
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        @foreach (var post in Model.RelatedPosts)
                        {
                            <div class="bg-white rounded-lg shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition-shadow" 
                                 onclick="openBlogDetail(@post.BlogId)">
                                <div class="aspect-video bg-gray-200 flex items-center justify-center">
                                    @if (!string.IsNullOrEmpty(post.FeaturedImage))
                                    {
	                                    <img src="@post.FeaturedImage"
	                                         alt="@post.Title"
	                                         class="img-fluid d-block mx-auto"
	                                         style="object-fit: contain; width: 100%; height: 200px; " />

                                    }
                                    else
                                    {
                                        <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                                            <span class="text-gray-400 text-sm uppercase">@post.CategoryName</span>
                                        </div>
                                    }
                                </div>
                                <div class="p-4">
                                    <div class="flex items-center text-xs text-gray-500 mb-2">
                                        <span>@post.CategoryName</span>
                                        @if (post.ReadTime > 0)
                                        {
                                            <span class="mx-2">•</span>
                                            <span>@post.ReadTime phút đọc</span>
                                        }
                                    </div>
                                    <h4 class="font-semibold text-gray-800 mb-2 line-clamp-2" style="font-family: 'Prata', serif;">
                                        @post.Title
                                    </h4>
                                    <p class="text-gray-600 text-sm line-clamp-2" style="font-family: 'Noto Serif', serif;">
                                        @Html.Raw(post.Excerpt)
                                    </p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- SignalR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>

<script>
// Initialize SignalR connection
const connection = new signalR.HubConnectionBuilder()
    .withUrl("/commentHub")
    .build();

// Start the connection
connection.start().then(function () {
    console.log("SignalR Connected");
    // Join the blog group
    connection.invoke("JoinBlogGroup", "@Model.BlogId");
}).catch(function (err) {
    console.error("SignalR Connection Error: ", err.toString());
});

// Listen for new comments
connection.on("ReceiveComment", function (comment) {
    addCommentToUI(comment);
    updateCommentCount(1);
    showMessage("Bình luận mới đã được thêm!", "success");
});

// Listen for deleted comments
connection.on("CommentDeleted", function (commentId) {
    removeCommentFromUI(commentId);
    updateCommentCount(-1);
    showMessage("Bình luận đã được xóa!", "info");
});

// Handle comment form submission
document.getElementById('commentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const authorName = document.getElementById('authorName').value;
    const authorEmail = document.getElementById('authorEmail').value;
    const content = document.getElementById('commentContent').value;
    const submitBtn = document.getElementById('submitBtn');
    
    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Đang gửi...';
    
    // Send comment to server
    fetch('/Blog/AddComment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `blogId=@Model.BlogId&authorName=${encodeURIComponent(authorName)}&authorEmail=${encodeURIComponent(authorEmail)}&content=${encodeURIComponent(content)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Clear form
            document.getElementById('commentForm').reset();
            showMessage(data.message, "success");
        } else {
            showMessage(data.message, "error");
        }
    })
    .catch(error => {
        showMessage("Có lỗi xảy ra khi gửi bình luận!", "error");
        console.error('Error:', error);
    })
    .finally(() => {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Gửi bình luận';
    });
});

// Delete comment function
function deleteComment(commentId) {
    if (confirm('Bạn có chắc chắn muốn xóa bình luận này?')) {
        fetch('/Blog/DeleteComment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `commentId=${commentId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, "success");
            } else {
                showMessage(data.message, "error");
            }
        })
        .catch(error => {
            showMessage("Có lỗi xảy ra khi xóa bình luận!", "error");
            console.error('Error:', error);
        });
    }
}

// Add comment to UI
function addCommentToUI(comment) {
    const commentsList = document.getElementById('commentsList');
    const commentHtml = `
        <div class="comment-item border-b border-gray-200 pb-6" data-comment-id="${comment.CommentId}">
            <div class="flex items-start space-x-4">
                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold" style="background-color: #62000d;">
                    ${comment.AuthorName.charAt(0).toUpperCase()}
                </div>
                <div class="flex-1">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <h4 class="font-semibold text-gray-800">${comment.AuthorName}</h4>
                            <span class="text-sm text-gray-500">${comment.CreatedDate}</span>
                        </div>
                        ${comment.CanDelete ? `<button onclick="deleteComment(${comment.CommentId})" class="text-red-500 hover:text-red-700 text-sm"><i class="fas fa-trash"></i> Xóa</button>` : ''}
                    </div>
                    <p class="text-gray-700 leading-relaxed" style="font-family: 'Noto Serif', serif;">
                        ${comment.Content}
                    </p>
                </div>
            </div>
        </div>
    `;
    
    commentsList.insertAdjacentHTML('afterbegin', commentHtml);
}

// Remove comment from UI
function removeCommentFromUI(commentId) {
    const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
    if (commentElement) {
        commentElement.remove();
    }
}

// Update comment count
function updateCommentCount(change) {
    const countElement = document.getElementById('commentCount');
    const currentCount = parseInt(countElement.textContent);
    countElement.textContent = currentCount + change;
}

// Show message
function showMessage(message, type) {
    const messageDisplay = document.getElementById('messageDisplay');
    messageDisplay.className = `mb-4 p-4 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-700' : type === 'error' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`;
    messageDisplay.textContent = message;
    messageDisplay.classList.remove('hidden');
    
    setTimeout(() => {
        messageDisplay.classList.add('hidden');
    }, 5000);
}

// Other functions
function openBlogDetail(id) {
    window.location.href = '/Blog/Detail/' + id;
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (connection) {
        connection.invoke("LeaveBlogGroup", "@Model.BlogId");
    }
});
</script>
