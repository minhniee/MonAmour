@model MonAmour.Models.Product
@{
    ViewData["Title"] = Model.Name + " - MonAmour";
}

<div class="min-h-screen bg-beige">
    <!-- Breadcrumb -->
    <div class="bg-beige/40 py-4">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <nav class="flex" aria-label="Breadcrumb">
                <ol class="flex items-center space-x-2">
                    <li>
                        <a href="@Url.Action("ListGiftbox", "Gift_box")" class="text-wine-red hover:text-wine-red/80 font-noto-serif">
                            Gift Box Collection
                        </a>
                    </li>
                    <li>
                        <span class="text-wine-red/40 mx-2">/</span>
                    </li>
                    <li>
                        <span class="text-wine-red font-noto-serif">@Model.Name</span>
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Product Detail Section -->
    <div class="py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                <!-- Product Images -->
                <div class="flex gap-4">
                    <!-- Thumbnail Images (Left Side) -->
                    <div class="flex flex-col gap-2">
                        @{
                            var images = Model.ProductImgs?.OrderBy(pi => pi.DisplayOrder).ToList() ?? new List<MonAmour.Models.ProductImg>();
                            var mainImage = images.FirstOrDefault()?.ImgUrl ?? "https://via.placeholder.com/600x600?text=No+Image";
                        }
                        @for (int i = 0; i < Math.Min(3, images.Count); i++)
                        {
                            var isFirst = i == 0;
                            <div class="thumb w-20 h-20 rounded-lg overflow-hidden bg-beige cursor-pointer transition-all @(isFirst ? "ring-2 ring-wine-red" : "hover:ring-2 hover:ring-wine-red/50")" onclick="setMainImage('@images[i].ImgUrl', this)">
                                <img src="@images[i].ImgUrl" alt="@Model.Name" class="w-full h-full object-cover">
                            </div>
                        }
                        @if (images.Count < 3)
                        {
                            @for (int i = images.Count; i < 3; i++)
                            {
                                <div class="w-20 h-20 rounded-lg bg-beige"></div>
                            }
                        }
                    </div>
                    
                    <!-- Main Image -->
                    <div class="flex-1 aspect-square rounded-2xl overflow-hidden bg-beige">
                        <img id="main-image" src="@mainImage" alt="@Model.Name" class="w-full h-full object-cover transition-opacity duration-300">
                    </div>
                </div>

                <!-- Product Info -->
                <div class="space-y-6">
                    <!-- Product Name -->
                    <h1 class="font-prata text-3xl md:text-4xl font-bold text-wine-red leading-tight">
                        @Model.Name
                    </h1>

                    <!-- Rating -->
                    @{
                        var _reviews = ViewBag.Reviews as List<MonAmour.Models.Review> ?? new List<MonAmour.Models.Review>();
                        var _ratings = _reviews.Where(r => r.Rating.HasValue).Select(r => r.Rating!.Value).ToList();
                        var _avg = _ratings.Any() ? Math.Round(_ratings.Average(), 1) : 0;
                        var _count = _ratings.Count;
                        var _filled = (int)Math.Floor(_avg);
                    }
                    <div class="flex items-center space-x-2">
                        <div class="flex items-center">
                            @for (int i = 1; i <= 5; i++)
                            {
                                if (i <= _filled)
                                {
                                    <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                }
                                else
                                {
                                    <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
                                }
                            }
                        </div>
                        <span class="font-noto-serif text-wine-red/70">@_avg.ToString("0.0") (@_count nhận xét)</span>
                    </div>

                    <!-- Price & Stock -->
                    <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
                        <div class="flex items-center space-x-4">
                            <span class="font-prata text-3xl font-bold text-wine-red">
                                @String.Format("{0:N0}₫", Model.Price)
                            </span>
                            @if (Model.Price > 150000)
                            {
                                <span class="font-prata text-xl text-gray-500 line-through">
                                    @String.Format("{0:N0}₫", Model.Price + 30000)
                                </span>
                            }
                        </div>
                        <div class="flex items-center">
                            <span class="font-noto-serif text-gray-600 mr-2">Kho:</span>
                            @if (Model.StockQuantity.HasValue)
                            {
                                var stock = Model.StockQuantity.Value;
                                if (stock > 10)
                                {
                                    <span class="font-prata text-green-600">Còn hàng (@stock)</span>
                                }
                                else if (stock > 0)
                                {
                                    <span class="font-prata text-amber-600">Sắp hết (@stock)</span>
                                }
                                else
                                {
                                    <span class="font-prata text-red-600">Hết hàng</span>
                                }
                            }
                            else
                            {
                                <span class="font-prata text-gray-500">Không rõ</span>
                            }
                        </div>
                    </div>

                    <!-- Quantity Selector -->
                    <div class="flex items-center gap-4">
                        <span class="font-noto-serif text-wine-red/80">Số lượng:</span>
                        <div class="qty-control @(Model.StockQuantity.HasValue && Model.StockQuantity.Value <= 0 ? "opacity-50 pointer-events-none" : "")">
                            <button type="button" class="qty-btn" onclick="decreaseQuantity()" aria-label="Giảm" @(Model.StockQuantity.HasValue && Model.StockQuantity.Value <= 0 ? "disabled" : "")>−</button>
                            <input type="number" id="quantity" value="1" min="1" class="qty-input" @(Model.StockQuantity.HasValue && Model.StockQuantity.Value <= 0 ? "disabled" : "") />
                            <button type="button" class="qty-btn" onclick="increaseQuantity()" aria-label="Tăng" @(Model.StockQuantity.HasValue && Model.StockQuantity.Value <= 0 ? "disabled" : "")>＋</button>
                        </div>
                    </div>
                    
                    @{
                        var currentCartQuantity = ViewBag.CurrentCartQuantity as int? ?? 0;
                    }
                    @if (currentCartQuantity > 0)
                    {
                        <div class="text-sm text-wine-red/70 mt-2">
                            <span class="inline-flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
                                </svg>
                                Bạn đã có @currentCartQuantity sản phẩm này trong giỏ hàng
                            </span>
                        </div>
                    }

                    <!-- Add to Cart Button -->
                    <div class="pt-4">
                        @if (Model.StockQuantity.HasValue && Model.StockQuantity.Value <= 0)
                        {
                            <div class="w-full bg-gray-400 text-white px-8 py-4 rounded-lg font-prata text-lg text-center cursor-not-allowed">
                                Sản phẩm đã hết hàng
                            </div>
                            <p class="text-sm text-gray-600 mt-2 text-center">Vui lòng chọn sản phẩm khác hoặc liên hệ để được thông báo khi có hàng.</p>
                        }
                        else
                        {
                            <form asp-controller="Cart" asp-action="Add" method="post" class="w-full" id="add-to-cart-form">
                                <input type="hidden" name="productId" value="@Model.ProductId" />
                                <input type="hidden" name="quantity" id="cartQuantity" value="1" />
                                <button type="submit" class="w-full bg-wine-red text-beige px-8 py-4 rounded-lg font-prata text-lg hover:bg-wine-red/90 transition-colors duration-200 shadow-lg hover:shadow-xl">
                                    Add to cart
                                </button>
                            </form>
                        }
                    </div>

                    <!-- Payment Methods -->
                    
                </div>
            </div>
        </div>
    </div>

    <!-- Product Details and Reviews Tabs -->
    <div class="py-12 bg-beige/30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Tabs -->
            <div class="border-b border-wine-red/20 mb-8">
                <nav class="-mb-px flex space-x-8">
                    <button id="details-tab" class="tab-button active py-2 px-1 border-b-2 border-wine-red font-prata text-wine-red">
                        Chi tiết sản phẩm
                    </button>
                    <button id="reviews-tab" class="tab-button py-2 px-1 border-b-2 border-transparent font-prata text-gray-500 hover:text-wine-red hover:border-gray-300">
                        Nhận xét
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="details-content" class="tab-content">
                <div class="prose max-w-none">
                    <p class="font-noto-serif text-wine-red/80 leading-relaxed mb-6">
                        @Model.Description
                    </p>
                    <ul class="space-y-2 font-noto-serif text-wine-red/80">
                        <li>• Chất liệu cao cấp, bền đẹp</li>
                        <li>• Thiết kế tinh tế, sang trọng</li>
                        <li>• Phù hợp cho mọi dịp đặc biệt</li>
                        <li>• Đóng gói cẩn thận, an toàn</li>
                        <li>• Giao hàng nhanh chóng</li>
                        <li>• Mã sản phẩm: @Model.ProductId</li>
                    </ul>
                </div>
            </div>

            <div id="reviews-content" class="tab-content hidden">
                @{
                    var reviews = ViewBag.Reviews as List<MonAmour.Models.Review> ?? new List<MonAmour.Models.Review>();
                    var verified = ViewBag.VerifiedUserIds as HashSet<int> ?? new HashSet<int>();
                }
                @if (!reviews.Any())
                {
                    <div class="text-center py-12">
                        <p class="font-noto-serif text-wine-red/70">Chưa có nhận xét nào. Hãy là người đầu tiên đánh giá sản phẩm này!</p>
                    </div>
                }
                else
                {
                    <div class="space-y-6">
                        @foreach (var r in reviews)
                        {
                            var isVerified = r.UserId.HasValue && verified.Contains(r.UserId.Value);
                            <div class="bg-white rounded-2xl border border-wine-red/20 p-4">
                                <div class="flex items-start justify-between gap-4">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <span class="font-prata text-wine-red text-lg">@((r.User?.Name) ?? "Khách")</span>
                                            @if (isVerified)
                                            {
                                                <span title="Đã mua và nhận hàng" class="inline-flex items-center text-green-600">
                                                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293A1 1 0 106.293 10.707l2 2a1 1 0 001.414 0l4-4z"/></svg>
                                                    <span class="text-xs font-semibold">Đã mua</span>
                                                </span>
                                            }
                                        </div>
                                        <div class="flex items-center gap-1 mt-1">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                if (i <= (r.Rating ?? 0))
                                                {
                                                    <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                                }
                                                else
                                                {
                                                    <svg class="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
                                                }
                                            }
                                        </div>
                                        @if (!string.IsNullOrWhiteSpace(r.Comment))
                                        {
                                            <p class="mt-2 font-noto-serif text-wine-red/80">@r.Comment</p>
                                        }
                                    </div>
                                    <div class="text-right text-sm text-wine-red/60 whitespace-nowrap">@((r.CreatedAt ?? DateTime.Now).ToString("dd/MM/yyyy"))</div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Related Products Section -->
    <div class="bg-beige/40 py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <h2 class="font-prata text-4xl md:text-5xl font-bold text-wine-red mb-4">
                    Sản phẩm liên quan
                </h2>
            </div>
            @{
                var related = ViewBag.RelatedProducts as List<MonAmour.Models.Product> ?? new List<MonAmour.Models.Product>();
                var total = related.Count;
            }
            <div class="relative">
                <div id="related-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    @for (int i = 0; i < related.Count; i++)
                    {
                        var rp = related[i];
                        var rimg = rp.ProductImgs?.OrderBy(pi => pi.DisplayOrder).FirstOrDefault()?.ImgUrl ?? "https://via.placeholder.com/600x400?text=No+Image";
                        <a data-index="@i" href="@Url.Action("ProductDetail", "Gift_box", new { id = rp.ProductId })" class="rel-card bg-white rounded-2xl border border-wine-red/20 shadow-sm p-4 block @(i < 4 ? "" : "hidden")">
                            <div class="h-48 bg-beige rounded-lg mb-4 overflow-hidden">
                                <img src="@rimg" alt="@rp.Name" class="w-full h-full object-cover" />
                            </div>
                            <h3 class="font-prata text-lg font-semibold text-wine-red mb-2">@rp.Name</h3>
                            <div class="flex items-center mb-2">
                                <div class="flex items-center">
                                    @for (int s = 1; s <= 4; s++)
                                    {
                                        <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                    }
                                </div>
                                <span class="text-sm text-wine-red/70 ml-1">4/5</span>
                            </div>
                            <p class="font-prata text-xl font-bold text-wine-red">@String.Format("{0:N0}₫", rp.Price)</p>
                        </a>
                    }
                </div>

                @if (total > 4)
                {
                    <button type="button" id="rel-prev" class="hidden lg:flex absolute -left-4 top-1/2 -translate-y-1/2 bg-wine-red text-beige w-10 h-10 rounded-full items-center justify-center shadow-md hover:bg-wine-red/90">‹</button>
                    <button type="button" id="rel-next" class="hidden lg:flex absolute -right-4 top-1/2 -translate-y-1/2 bg-wine-red text-beige w-10 h-10 rounded-full items-center justify-center shadow-md hover:bg-wine-red/90">›</button>
                }
            </div>
        </div>
    </div>

    <!-- Newsletter Section -->
    <div class="bg-wine-red py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col lg:flex-row items-center justify-between gap-8">
                <div class="text-center lg:text-left">
                    <h2 class="font-prata text-2xl md:text-3xl font-bold text-beige mb-4">
                        CẬP NHẬT THÔNG TIN VỀ ƯU ĐÃI MỚI NHẤT CỦA CHÚNG TÔI
                    </h2>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 w-full lg:w-auto">
                    <input type="email" placeholder="Nhập địa chỉ email của bạn" 
                           class="px-6 py-3 rounded-lg border-0 focus:ring-2 focus:ring-beige/50 font-noto-serif text-wine-red placeholder-gray-500 min-w-80">
                    <button class="bg-beige text-wine-red px-8 py-3 rounded-lg font-prata font-semibold hover:bg-beige/90 transition-colors duration-200 whitespace-nowrap">
                        Đăng ký ngay
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .aspect-square {
        aspect-ratio: 1 / 1;
    }
    
    .tab-button.active {
        border-bottom-color: #62000d;
        color: #62000d;
    }
    
    .tab-content {
        display: block;
    }
    
    .tab-content.hidden {
        display: none;
    }

    /* Quantity control styles */
    .qty-control {
        display: inline-flex;
        align-items: center;
        background: #fbf1e6; /* beige */
        border: 1px solid rgba(98, 0, 13, .3); /* wine red/30 */
        border-radius: 9999px; /* pill */
        overflow: hidden;
    }
    .qty-btn {
        width: 40px;
        height: 40px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #6b7280; /* gray-500 */
        background: transparent;
        transition: background-color .2s, color .2s;
    }
    .qty-btn:hover { background-color: rgba(98, 0, 13, .06); color: #62000d; }
    .qty-input {
        width: 64px;
        text-align: center;
        border: 0;
        outline: none;
        background: transparent;
        font-family: 'Noto Serif', serif;
        padding: 0 4px;
        height: 40px;
    }
</style>

<script>
    // Swap main image when clicking thumbnails
    function setMainImage(url, thumbEl) {
        const main = document.getElementById('main-image');
        if (!main) return;

        // Fade out
        main.style.opacity = '0.3';
        setTimeout(() => {
            main.src = url;
            main.onload = () => {
                main.style.opacity = '1';
            };
        }, 100);

        // Update active ring on thumbnails
        document.querySelectorAll('.thumb').forEach(t => {
            t.classList.remove('ring-2', 'ring-wine-red');
            t.classList.add('hover:ring-2', 'hover:ring-wine-red/50');
        });
        thumbEl.classList.add('ring-2', 'ring-wine-red');
        thumbEl.classList.remove('hover:ring-2', 'hover:ring-wine-red/50');
    }

    // Quantity selector functions
    function increaseQuantity() {
        const quantityInput = document.getElementById('quantity');
        const cartQuantity = document.getElementById('cartQuantity');
        const currentValue = parseInt(quantityInput.value);
        const newValue = currentValue + 1;
        
        // Check stock availability including current cart items
        const stockQuantity = @(Model.StockQuantity?.ToString() ?? "null");
        const currentCartQuantity = @(ViewBag.CurrentCartQuantity?.ToString() ?? "0");
        
        if (stockQuantity !== null) {
            const totalRequested = currentCartQuantity + newValue;
            if (totalRequested > stockQuantity) {
                if (currentCartQuantity > 0) {
                    alert(`Bạn đã có ${currentCartQuantity} sản phẩm này trong giỏ hàng và muốn thêm ${newValue} sản phẩm nữa, nhưng chỉ còn ${stockQuantity} sản phẩm trong kho. Tổng cộng bạn cần ${totalRequested} sản phẩm nhưng chỉ còn ${stockQuantity} sản phẩm. Vui lòng giảm số lượng hoặc xóa bớt sản phẩm trong giỏ hàng.`);
                } else {
                    alert(`Số lượng sản phẩm không còn đủ. Bạn muốn thêm ${newValue} sản phẩm nhưng chỉ còn ${stockQuantity} sản phẩm trong kho. Vui lòng chọn số lượng phù hợp.`);
                }
                return;
            }
        }
        
        quantityInput.value = newValue;
        cartQuantity.value = newValue;
    }
    
    function decreaseQuantity() {
        const quantityInput = document.getElementById('quantity');
        const cartQuantity = document.getElementById('cartQuantity');
        const currentValue = parseInt(quantityInput.value);
        if (currentValue > 1) {
            const newValue = currentValue - 1;
            quantityInput.value = newValue;
            cartQuantity.value = newValue;
        }
    }
    
    // Tab functionality
    document.addEventListener('DOMContentLoaded', function() {
        const detailsTab = document.getElementById('details-tab');
        const reviewsTab = document.getElementById('reviews-tab');
        const detailsContent = document.getElementById('details-content');
        const reviewsContent = document.getElementById('reviews-content');
        
        detailsTab.addEventListener('click', function() {
            // Update tab buttons
            detailsTab.classList.add('active');
            detailsTab.classList.remove('border-transparent', 'text-gray-500');
            detailsTab.classList.add('border-wine-red', 'text-wine-red');
            
            reviewsTab.classList.remove('active');
            reviewsTab.classList.remove('border-wine-red', 'text-wine-red');
            reviewsTab.classList.add('border-transparent', 'text-gray-500');
            
            // Update content
            detailsContent.classList.remove('hidden');
            reviewsContent.classList.add('hidden');
        });
        
        reviewsTab.addEventListener('click', function() {
            // Update tab buttons
            reviewsTab.classList.add('active');
            reviewsTab.classList.remove('border-transparent', 'text-gray-500');
            reviewsTab.classList.add('border-wine-red', 'text-wine-red');
            
            detailsTab.classList.remove('active');
            detailsTab.classList.remove('border-wine-red', 'text-wine-red');
            detailsTab.classList.add('border-transparent', 'text-gray-500');
            
            // Update content
            reviewsContent.classList.remove('hidden');
            detailsContent.classList.add('hidden');
        });
    });

    // Sync cart hidden quantity when user changes visible quantity
    const qtyInput = document.getElementById('quantity');
    const cartQty = document.getElementById('cartQuantity');
    if (qtyInput && cartQty) {
        qtyInput.addEventListener('input', () => {
            const newValue = Math.max(1, parseInt(qtyInput.value || '1'));
            
            // Check stock availability when user manually types quantity
            const stockQuantity = @(Model.StockQuantity?.ToString() ?? "null");
            const currentCartQuantity = @(ViewBag.CurrentCartQuantity?.ToString() ?? "0");
            
            if (stockQuantity !== null) {
                const totalRequested = currentCartQuantity + newValue;
                if (totalRequested > stockQuantity) {
                    if (currentCartQuantity > 0) {
                        alert(`Bạn đã có ${currentCartQuantity} sản phẩm này trong giỏ hàng và muốn thêm ${newValue} sản phẩm nữa, nhưng chỉ còn ${stockQuantity} sản phẩm trong kho. Tổng cộng bạn cần ${totalRequested} sản phẩm nhưng chỉ còn ${stockQuantity} sản phẩm. Vui lòng giảm số lượng hoặc xóa bớt sản phẩm trong giỏ hàng.`);
                    } else {
                        alert(`Số lượng sản phẩm không còn đủ. Bạn muốn thêm ${newValue} sản phẩm nhưng chỉ còn ${stockQuantity} sản phẩm trong kho. Vui lòng chọn số lượng phù hợp.`);
                    }
                    const maxAllowed = Math.max(1, stockQuantity - currentCartQuantity);
                    qtyInput.value = maxAllowed;
                    cartQty.value = maxAllowed;
                    return;
                }
            }
            
            cartQty.value = newValue;
        });
    }

    // Related products pagination (4 per page)
    (function() {
        const grid = document.getElementById('related-grid');
        if (!grid) return;
        const cards = Array.from(grid.querySelectorAll('.rel-card'));
        const prev = document.getElementById('rel-prev');
        const next = document.getElementById('rel-next');
        if (!cards.length || (!prev && !next)) return;

        let page = 0;
        const pageSize = 4;
        const totalPages = Math.ceil(cards.length / pageSize);

        function render() {
            cards.forEach((el, idx) => {
                const p = Math.floor(idx / pageSize);
                if (p === page) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
            if (prev) prev.disabled = page === 0;
            if (next) next.disabled = page >= totalPages - 1;
            if (prev) prev.classList.toggle('opacity-50', page === 0);
            if (next) next.classList.toggle('opacity-50', page >= totalPages - 1);
        }

        render();
        if (prev) prev.addEventListener('click', () => { if (page > 0) { page--; render(); } });
        if (next) next.addEventListener('click', () => { if (page < totalPages - 1) { page++; render(); } });
    })();

    // AJAX add-to-cart (no reload)
    (function(){
        const form = document.getElementById('add-to-cart-form');
        if(!form) return;
        form.addEventListener('submit', async function(e){
            e.preventDefault();
            
            // Pre-check stock before submitting
            const quantity = parseInt(document.getElementById('cartQuantity').value);
            const stockQuantity = @(Model.StockQuantity?.ToString() ?? "null");
            const currentCartQuantity = @(ViewBag.CurrentCartQuantity?.ToString() ?? "0");
            
            if (stockQuantity !== null) {
                const totalRequested = currentCartQuantity + quantity;
                if (totalRequested > stockQuantity) {
                    if (currentCartQuantity > 0) {
                        alert(`Bạn đã có ${currentCartQuantity} sản phẩm này trong giỏ hàng và muốn thêm ${quantity} sản phẩm nữa, nhưng chỉ còn ${stockQuantity} sản phẩm trong kho. Tổng cộng bạn cần ${totalRequested} sản phẩm nhưng chỉ còn ${stockQuantity} sản phẩm. Vui lòng giảm số lượng hoặc xóa bớt sản phẩm trong giỏ hàng.`);
                    } else {
                        alert(`Số lượng sản phẩm không còn đủ. Bạn muốn thêm ${quantity} sản phẩm nhưng chỉ còn ${stockQuantity} sản phẩm trong kho. Vui lòng giảm số lượng hoặc chọn sản phẩm khác.`);
                    }
                    return;
                }
            }
            
            try {
                const formData = new FormData(form);
                const res = await fetch(form.action, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    body: formData
                });
                const data = await res.json();
                if (data && data.success) {
                    const toast = document.createElement('div');
                    toast.textContent = data.message || 'Đã thêm sản phẩm vào giỏ hàng thành công!';
                    toast.className = 'fixed bottom-6 right-6 bg-wine-red text-beige px-4 py-3 rounded-lg shadow-lg';
                    toast.style.zIndex = '9999';
                    document.body.appendChild(toast);
                    setTimeout(()=>{ toast.style.transition='opacity .5s'; toast.style.opacity='0'; setTimeout(()=>toast.remove(), 500); }, 2000);
                } else if (res.status === 401) {
                    window.location.href = '@Url.Action("Login","Auth")';
                } else {
                    const errorData = await res.json();
                    alert(errorData.message || 'Không thể thêm sản phẩm vào giỏ hàng. Vui lòng kiểm tra lại số lượng và thử lại.');
                }
            } catch (err) {
                alert('Đã xảy ra lỗi khi thêm sản phẩm vào giỏ hàng. Vui lòng thử lại sau.');
            }
        });
    })();

    // Fallback: show toast if URL has ?added=true (client-side)
    document.addEventListener('DOMContentLoaded', function(){
        try {
            const params = new URLSearchParams(window.location.search);
            if (params.get('added') === 'true') {
                const toast = document.createElement('div');
                toast.textContent = 'Đã thêm sản phẩm vào giỏ hàng thành công!';
                toast.className = 'fixed bottom-6 right-6 bg-wine-red text-beige px-4 py-3 rounded-lg shadow-lg';
                toast.style.zIndex = '9999';
                document.body.appendChild(toast);
                setTimeout(()=>{
                    toast.style.transition = 'opacity 0.5s';
                    toast.style.opacity = '0';
                    setTimeout(()=> toast.remove(), 500);
                }, 2000);
            }
        } catch {}
    });

</script>
