@model MonAmour.Models.Concept
@{
	ViewData["Title"] = Model.Name + " - Mon Amour";
	var relatedConcepts = ViewBag.RelatedConcepts as List<MonAmour.Models.Concept>;
	var primaryImage = Model.ConceptImgs?.FirstOrDefault(img => img.IsPrimary == true)?.ImgUrl ?? Model.ConceptImgs?.FirstOrDefault()?.ImgUrl ?? "https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=800&h=600&fit=crop";
	var coverImages = Model.ConceptImgs?.Where(img => img.DisplayOrder == 2 || img.DisplayOrder == 3).OrderBy(img => img.DisplayOrder).ToList() ?? new List<MonAmour.Models.ConceptImg>();
	var detailImages = Model.ConceptImgs?.Where(img => img.DisplayOrder >= 4 && img.DisplayOrder <= 6).OrderBy(img => img.DisplayOrder).ToList() ?? new List<MonAmour.Models.ConceptImg>();
	var categories = ViewBag.Categories as List<MonAmour.Models.ConceptCategory>;
	var cities = ViewBag.Cities as List<string>;
}

<div class="min-h-screen bg-beige">

	<!-- Cover Images (Display Order 2,3) -->
	<section class="py-8">
		<div class="container mx-auto px-4">
			<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
				@if (coverImages.Count > 0)
				{
					<div class="relative cursor-pointer" onclick="openLightbox('@coverImages[0].ImgUrl', '@Model.Name')">
						<img src="@coverImages[0].ImgUrl" alt="@Model.Name" class="w-full h-96 object-cover rounded-2xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
						<div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-300 rounded-2xl flex items-center justify-center">
							<svg class="w-12 h-12 text-white opacity-0 hover:opacity-100 transition-opacity duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
							</svg>
						</div>
					</div>
				}
				@if (coverImages.Count > 1)
				{
					<div class="relative cursor-pointer" onclick="openLightbox('@coverImages[1].ImgUrl', '@Model.Name')">
						<img src="@coverImages[1].ImgUrl" alt="@Model.Name" class="w-full h-96 object-cover rounded-2xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
						<div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-300 rounded-2xl flex items-center justify-center">
							<svg class="w-12 h-12 text-white opacity-0 hover:opacity-100 transition-opacity duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
							</svg>
						</div>
					</div>
				}
			</div>
		</div>
	</section>

	<!-- Primary Image Section -->
	<section class="py-12">
		<div class="container mx-auto px-4 text-center">
			<h2 class="font-prata text-4xl md:text-5xl text-wine-red mb-6">@Model.Name</h2>
			<div class="w-full max-w-4xl mx-auto">
				<div class="relative cursor-pointer" onclick="openLightbox('@primaryImage', '@Model.Name')">
					<img src="@primaryImage" alt="@Model.Name" class="w-full h-64 md:h-80 object-cover rounded-2xl shadow-lg mb-6 hover:shadow-2xl transition-shadow duration-300">
					<div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-300 rounded-2xl flex items-center justify-center">
						<svg class="w-12 h-12 text-white opacity-0 hover:opacity-100 transition-opacity duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
						</svg>
					</div>
				</div>
				@if (!string.IsNullOrEmpty(Model.Description))
				{
					<p class="font-noto-serif text-lg text-gray-700 max-w-3xl mx-auto">@Model.Description</p>
				}
			</div>
		</div>
	</section>

	<!-- Detail Images Section (Display Order 4,5,6) -->
	@if (detailImages.Any())
	{
		<section class="py-12 bg-white/50">
			<div class="container mx-auto px-4">
				<!-- Ảnh 4 và 5 theo thiết kế -->
				@if (detailImages.Count >= 2)
				{
					<!-- Ảnh 4 với mô tả bên phải -->
					<div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center mb-12">
						<div class="relative cursor-pointer" onclick="openLightbox('@detailImages[0].ImgUrl', '@detailImages[0].AltText')">
							<img src="@detailImages[0].ImgUrl" alt="@detailImages[0].AltText" class="w-full h-80 object-cover rounded-2xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
							<div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-300 rounded-2xl flex items-center justify-center">
								<svg class="w-12 h-12 text-white opacity-0 hover:opacity-100 transition-opacity duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
								</svg>
							</div>
						</div>
						<div>
							<h3 class="font-prata text-3xl text-wine-red mb-4">Các điểm nổi bật của concept</h3>
							@if (!string.IsNullOrEmpty(detailImages[0].AltText))
							{
								<p class="font-noto-serif text-lg text-gray-700">@detailImages[0].AltText</p>
							}
						</div>
					</div>
					
					<!-- Ảnh 5 với mô tả bên trái -->
					<div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center mb-12">
						<div class="order-2 md:order-1">
							<h3 class="font-prata text-3xl text-wine-red mb-4">Các điểm nổi bật của concept</h3>
							@if (!string.IsNullOrEmpty(detailImages[1].AltText))
							{
								<p class="font-noto-serif text-lg text-gray-700">@detailImages[1].AltText</p>
							}
						</div>
						<div class="order-1 md:order-2 relative cursor-pointer" onclick="openLightbox('@detailImages[1].ImgUrl', '@detailImages[1].AltText')">
							<img src="@detailImages[1].ImgUrl" alt="@detailImages[1].AltText" class="w-full h-80 object-cover rounded-2xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
							<div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-300 rounded-2xl flex items-center justify-center">
								<svg class="w-12 h-12 text-white opacity-0 hover:opacity-100 transition-opacity duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
								</svg>
							</div>
						</div>
					</div>
				}
				
				<!-- Ảnh 6 xếp toàn bộ chiều rộng như ảnh primary -->
				@if (detailImages.Count >= 3)
				{
					<div class="text-center">
						<h3 class="font-prata text-3xl text-wine-red mb-6">Chi tiết về concept</h3>
						<div class="relative cursor-pointer inline-block" onclick="openLightbox('@detailImages[2].ImgUrl', '@detailImages[2].AltText')">
							<img src="@detailImages[2].ImgUrl" alt="@detailImages[2].AltText" class="w-full h-64 md:h-80 object-cover rounded-2xl shadow-lg mb-4 hover:shadow-2xl transition-shadow duration-300">
							<div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-300 rounded-2xl flex items-center justify-center">
								<svg class="w-12 h-12 text-white opacity-0 hover:opacity-100 transition-opacity duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
								</svg>
							</div>
						</div>
						@if (!string.IsNullOrEmpty(detailImages[2].AltText))
						{
							<p class="font-noto-serif text-gray-700 text-sm">@detailImages[2].AltText</p>
						}
					</div>
				}
			</div>
		</section>
	}

	<!-- Primary Image Information Section -->
	<section class="py-12">
		<div class="container mx-auto px-4 text-center">
			@{
				var primaryImageInfo = Model.ConceptImgs?.FirstOrDefault(img => img.IsPrimary == true);
			}
			@if (primaryImageInfo != null)
			{
				<div class="space-y-4">
					<h4 class="font-semibold text-wine-red text-xl text-center">@(primaryImageInfo.ImgName ?? "Hình ảnh chính concept")</h4>
					<p class="text-gray-700 text-lg text-justify">@(primaryImageInfo.AltText ?? "Ảnh chính của concept " + Model.Name)</p>
				</div>
			}
			else
			{
				<div class="space-y-4">
					<h4 class="font-semibold text-wine-red text-xl text-center">Hình ảnh chính concept</h4>
					<p class="text-gray-700 text-lg text-justify">Ảnh chính của concept @Model.Name</p>
				</div>
			}
		</div>
	</section>

	<!-- Contact CTA Button -->
	<section class="pb-2 -mt-6">
		<div class="container mx-auto px-4 text-center">
			<a href="#contact-section" class="inline-block px-8 py-3 bg-wine-red text-white rounded-full shadow-lg hover:shadow-xl hover:bg-wine-red/90 transition-all duration-200 font-prata text-lg">Liên hệ ngay</a>
		</div>
	</section>

	<!-- Contact Form Section -->
	<section id="contact-section" class="py-12 bg-white/50">
		<div class="container mx-auto px-4">
			<h3 class="font-prata text-3xl text-wine-red text-center mb-8">Thông tin liên hệ</h3>
			<form id="contactForm" method="post" action="@Url.Action("SubmitContact","Concept")" class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">
				@Html.AntiForgeryToken()
				<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
					<div>
						<label class="block text-sm font-medium text-wine-red mb-1">Họ tên *</label>
						<input name="fullName" type="text" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-wine-red/40 invalid:border-red-500" placeholder="Nhập họ tên">
						<div class="error-message text-red-500 text-sm mt-1 hidden"></div>
					</div>
					<div>
						<label class="block text-sm font-medium text-wine-red mb-1">Địa chỉ email *</label>
						<input name="email" type="email" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-wine-red/40 invalid:border-red-500" placeholder="you@example.com">
						<div class="error-message text-red-500 text-sm mt-1 hidden"></div>
					</div>
					<div>
						<label class="block text-sm font-medium text-wine-red mb-1">Số điện thoại *</label>
						<input name="phone" type="tel" required pattern="^0[0-9]{9}$" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-wine-red/40 invalid:border-red-500" placeholder="0xxxxxxxxx">
						<div class="error-message text-red-500 text-sm mt-1 hidden"></div>
					</div>
					<div>
						<label class="block text-sm font-medium text-wine-red mb-1">Nơi sống hiện tại</label>
						<input name="currentLocation" type="text" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-wine-red/40" placeholder="Thành phố / Tỉnh">
					</div>
				</div>

				<h4 class="font-prata text-2xl text-wine-red mt-8 mb-4">Thông tin chi tiết</h4>
				<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
					<div>
						<label class="block text-sm font-medium text-wine-red mb-1">Mục đích buổi hẹn hò *</label>
						<select id="datePurposeSelect" name="datePurpose" required class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-wine-red/40 invalid:border-red-500">
							<option value="">Chọn mục đích buổi hẹn</option>
							<option value="First date">First date</option>
							<option value="Normal date">Normal date</option>
							<option value="Anniversary/Birthday">Kỷ niệm ngày đặc biệt (Anniversary, Birthday)</option>
							<option value="Proposal">Cầu hôn/Proposal</option>
							<option value="other">Khác (ghi rõ trong phần ghi chú)</option>
						</select>
						<div class="error-message text-red-500 text-sm mt-1 hidden"></div>
					</div>
					<div>
						<label class="block text-sm font-medium text-wine-red mb-1">Ngân sách mong muốn *</label>
						<select id="budgetSelect" name="budget" required class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-wine-red/40 invalid:border-red-500">
							<option value="">Chọn ngân sách</option>
							<option value="Standard">Dưới 1.000.000đ (Standard)</option>
							<option value="Signature">1.000.000đ – 2.000.000đ (Signature)</option>
							<option value="Premium">2.000.000đ – 4.000.000đ (Premium)</option>
							<option value="Haute Amour">Trên 5.000.000đ (Haute Amour)</option>
						</select>
						<div class="error-message text-red-500 text-sm mt-1 hidden"></div>
					</div>
					<div>
						<label class="block text-sm font-medium text-wine-red mb-1">Ngày bạn muốn hẹn hò</label>
						<input id="eventDate" name="eventDate" type="text" placeholder="dd/mm/yyyy" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-wine-red/40">
						<div class="error-message text-red-500 text-sm mt-1 hidden"></div>
					</div>
					<div>
						<label class="block text-sm font-medium text-wine-red mb-1">Khoảng thời gian mong muốn</label>
						<div class="grid grid-cols-2 gap-2">
							<div class="relative">
								<input id="bookingStartTime" name="eventStartTime" type="text" readonly onclick="showTimePicker('bookingStartTime')" class="w-full border border-gray-300 rounded-md px-3 py-2 cursor-pointer focus:outline-none focus:ring-2 focus:ring-wine-red/40" placeholder="From (hh:mm)">
							</div>
							<div class="relative">
								<input id="bookingEndTime" name="eventEndTime" type="text" readonly onclick="showTimePicker('bookingEndTime')" class="w-full border border-gray-300 rounded-md px-3 py-2 cursor-pointer focus:outline-none focus:ring-2 focus:ring-wine-red/40" placeholder="To (hh:mm)">
							</div>
							<p id="durationText" class="text-sm text-gray-600 mt-1 col-span-2"></p>
							<div id="customTimePicker" class="absolute z-10 mt-2 w-64 bg-white border border-gray-200 rounded-lg shadow-lg p-3 hidden timepicker">
								<div class="grid grid-cols-2 gap-3">
									<div id="hoursColumn" class="max-h-48 overflow-y-auto border rounded-md"></div>
									<div id="minutesColumn" class="max-h-48 overflow-y-auto border rounded-md"></div>
								</div>
							</div>
						</div>
					</div>
					<div class="col-span-1 md:col-span-2">
						<label class="block text-sm font-medium text-wine-red mb-1">Không gian bạn hướng đến</label>
						<select id="spaceSelect" name="spacePreference" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-wine-red/40">
							<option value="">Chọn không gian</option>
							<option value="Private">Tại nhà/ Homestay/ Không gian riêng</option>
							<option value="Restaurant/Cafe">Nhà hàng/ Quán Café</option>
							<option value="Rooftop/Outdoor">Rooftop/ Outdoor</option>
							<option value="Beach/Lake/Garden">Bãi biển/ Hồ/ Sân vườn</option>
							<option value="other">Khác (ghi rõ)</option>
						</select>
						<div id="spaceOtherWrapper" class="mt-2 hidden">
							<input id="spaceOther" type="text" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-wine-red/40" placeholder="Nhập không gian khác">
						</div>
					</div>
				</div>

				<div class="mt-6">
					<label class="block text-sm font-medium text-wine-red mb-1">Điều bạn muốn MonAmour lưu ý * <span class="text-sm text-gray-500">(Let us know your wishes in more detail)</span></label>
					<textarea name="message" rows="4" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-wine-red/40 invalid:border-red-500" placeholder="✍️ Hãy cho chúng tôi biết chi tiết về mong muốn của bạn..."></textarea>
					<div class="error-message text-red-500 text-sm mt-1 hidden"></div>
				</div>

				<div class="mt-6">
					<label class="block text-sm font-medium text-wine-red mb-1">Bạn biết đến MonAmour qua kênh nào?</label>
					<select name="referral" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-wine-red/40">
						<option>Facebook</option>
						<option>Instagram</option>
						<option>TikTok</option>
						<option>Tìm kiếm Google</option>
						<option>Người quen giới thiệu</option>
						<option>Khác</option>
					</select>
				</div>

				<div class="mt-8 text-center">
					<button id="submitContactBtn" type="submit" class="px-8 py-3 bg-wine-red text-white rounded-full shadow-lg hover:shadow-xl hover:bg-wine-red/90 transition-all duration-200">Gửi yêu cầu</button>
				</div>
			</form>
		</div>
	</section>

	<!-- Related Concepts -->
	@if (relatedConcepts != null && relatedConcepts.Any())
	{
		<section class="py-12 bg-white/50">
			<div class="container mx-auto px-4">
				<h3 class="font-prata text-3xl text-wine-red text-center mb-8">Gói dịch vụ liên quan</h3>
				<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
					@foreach (var related in relatedConcepts)
					{
						var relatedImg = related.ConceptImgs?.FirstOrDefault(img => img.IsPrimary == true)?.ImgUrl ?? related.ConceptImgs?.FirstOrDefault()?.ImgUrl ?? "https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=400&h=300&fit=crop";
						<a href="@Url.Action("ConceptDetail", "Concept", new { id = related.ConceptId })" class="group">
							<div class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 overflow-hidden">
								<div class="relative overflow-hidden cursor-pointer" onclick="openLightbox('@relatedImg', '@related.Name')">
									<img src="@relatedImg" alt="@related.Name" class="w-full h-48 object-cover group-hover:scale-110 transition-transform duration-300">
									<div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
										<svg class="w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
										</svg>
									</div>
								</div>
								<div class="p-6">
									<h4 class="font-prata text-xl font-bold text-wine-red mb-2">@related.Name</h4>
									<p class="font-noto-serif text-gray-600 mb-4 line-clamp-2">@(related.Description?.Length > 100 ? related.Description.Substring(0, 100) + "..." : related.Description)</p>
									<div class="flex items-center justify-between">
										<span class="font-prata text-2xl font-bold text-wine-red">@String.Format("{0:N0}₫", related.Price)</span>
										<span class="text-sm text-gray-600">@related.Category?.Name</span>
									</div>
								</div>
							</div>
						</a>
					}
				</div>
			</div>
		</section>
	}
</div>

<!-- Lightbox Modal -->
<div id="lightbox" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center p-4">
	<div class="relative max-w-7xl max-h-full">
		<!-- Close Button -->
		<button onclick="closeLightbox()" class="absolute top-4 right-4 z-10 bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-full p-2 transition-all duration-200">
			<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
			</svg>
		</button>
		
		<!-- Image -->
		<img id="lightboxImage" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg">
		
		<!-- Image Info -->
		<div id="lightboxInfo" class="absolute bottom-4 left-4 right-4 bg-black bg-opacity-50 text-white p-4 rounded-lg">
			<h3 id="lightboxTitle" class="font-prata text-xl mb-2"></h3>
		</div>
	</div>
</div>

<style>
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
	
	/* Lightbox animations */
	#lightbox {
		backdrop-filter: blur(5px);
	}
	
	#lightbox.show {
		animation: fadeIn 0.3s ease-out;
	}
	
	#lightbox.hide {
		animation: fadeOut 0.3s ease-out;
	}
	
	@@keyframes fadeIn {
		from { opacity: 0; }
		to { opacity: 1; }
	}
	
	@@keyframes fadeOut {
		from { opacity: 1; }
		to { opacity: 0; }
	}

	.timepicker button { transition: background-color .15s ease, color .15s ease; }
	.timepicker button:hover { background-color: rgba(127, 29, 29, 0.08); }
	.timepicker button.active { background-color: rgba(127, 29, 29, 0.12); color: #7f1d1d; font-weight: 600; }
	
	/* Form validation styles */
	.form-field {
		transition: border-color 0.2s ease;
	}
	
	.form-field.valid {
		border-color: #10b981;
	}
	
	.form-field.invalid {
		border-color: #ef4444;
	}
	
	.error-message {
		animation: slideDown 0.3s ease-out;
	}
	
	@@keyframes slideDown {
		from { 
			opacity: 0; 
			transform: translateY(-10px); 
		}
		to { 
			opacity: 1; 
			transform: translateY(0); 
		}
	}
	
	/* Success feedback */
	.success-message {
		background-color: #dcfce7;
		border: 1px solid #10b981;
		color: #059669;
		padding: 12px 16px;
		border-radius: 8px;
		margin-bottom: 16px;
		animation: slideDown 0.3s ease-out;
	}
</style>

<script>
    let currentTimeTargetId = null;

    function showTimePicker(targetInputId) {
        currentTimeTargetId = targetInputId;
        const picker = document.getElementById('customTimePicker');
        const hoursCol = document.getElementById('hoursColumn');
        const minutesCol = document.getElementById('minutesColumn');
        const input = document.getElementById(targetInputId);

        // Populate hours and minutes if not initialized
        if (!hoursCol.dataset.initialized) {
            // Populate hours 08 - 22
            let hoursHtml = '';
            for (let h = 8; h <= 22; h++) {
                const hh = h.toString().padStart(2, '0');
                hoursHtml += `<button type="button" data-hour="${hh}" class="block w-full text-left px-4 py-2">${hh}</button>`;
            }
            hoursCol.innerHTML = hoursHtml;

            // Populate minutes 00, 15, 30, 45
            minutesCol.innerHTML = ['00','15','30','45']
                .map(m => `<button type=\"button\" data-minute=\"${m}\" class=\"block w-full text-left px-4 py-2\">${m}</button>`)
                .join('');

            // Mark as initialized
            hoursCol.dataset.initialized = 'true';
        }

        // Remove any existing event listeners
        hoursCol.replaceWith(hoursCol.cloneNode(true));
        minutesCol.replaceWith(minutesCol.cloneNode(true));
        
        // Re-get references after cloning
        const freshHoursCol = document.getElementById('hoursColumn');
        const freshMinutesCol = document.getElementById('minutesColumn');

        // Get current input's values
            let selectedHour = input.value && input.value.includes(':') ? input.value.split(':')[0] : null;
            let selectedMinute = input.value && input.value.includes(':') ? input.value.split(':')[1] : null;

            const updateActive = () => {
            freshHoursCol.querySelectorAll('button').forEach(b => {
                b.classList.toggle('active', b.getAttribute('data-hour') === selectedHour);
            });
            freshMinutesCol.querySelectorAll('button').forEach(b => {
                b.classList.toggle('active', b.getAttribute('data-minute') === selectedMinute);
            });
            };

            const scrollIntoViewSmooth = (btn, container) => {
                if (!btn) return;
                const top = btn.offsetTop - container.clientHeight / 2 + btn.clientHeight / 2;
                container.scrollTo({ top, behavior: 'smooth' });
            };

        // Add event listeners for the current session
        freshHoursCol.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-hour]');
            if (!btn) return;
            selectedHour = btn.getAttribute('data-hour');
            updateActive();
            scrollIntoViewSmooth(btn, freshHoursCol);
            
            // Commit time selection
                if (selectedHour && selectedMinute) {
                const targetInput = document.getElementById(currentTimeTargetId);
                if (targetInput) {
                    targetInput.value = `${selectedHour}:${selectedMinute}`;
                    hideTimePicker();
                    updateDurationText();
                }
            }
        });

        freshMinutesCol.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-minute]');
                if (!btn) return;
                selectedMinute = btn.getAttribute('data-minute');
                updateActive();
            scrollIntoViewSmooth(btn, freshMinutesCol);
            
            // Commit time selection
            if (selectedHour && selectedMinute) {
                const targetInput = document.getElementById(currentTimeTargetId);
                if (targetInput) {
                    targetInput.value = `${selectedHour}:${selectedMinute}`;
                    hideTimePicker();
                    updateDurationText();
                }
            }
        });

        picker.classList.remove('hidden');

        // Update active states and scroll to current values
        updateActive();
        scrollIntoViewSmooth(freshHoursCol.querySelector('button.active'), freshHoursCol);
        scrollIntoViewSmooth(freshMinutesCol.querySelector('button.active'), freshMinutesCol);

        // Click outside to close
        const outsideHandler = (ev) => {
            if (!picker.contains(ev.target) && ev.target.id !== targetInputId) {
                hideTimePicker();
                document.removeEventListener('click', outsideHandler);
            }
        };
        setTimeout(() => document.addEventListener('click', outsideHandler), 0);
    }

    function hideTimePicker() {
        const picker = document.getElementById('customTimePicker');
        picker.classList.add('hidden');
    }

    function parseHHMM(val) {
        if (!val || !val.includes(':')) return null;
        const [h, m] = val.split(':').map(Number);
        if (Number.isNaN(h) || Number.isNaN(m)) return null;
        return h * 60 + m;
    }

    function updateDurationText() {
        const start = document.getElementById('bookingStartTime').value;
        const end = document.getElementById('bookingEndTime').value;
        const el = document.getElementById('durationText');
        const s = parseHHMM(start);
        const e = parseHHMM(end);
        if (s != null && e != null && e > s) {
            const mins = e - s;
            const hh = Math.floor(mins / 60);
            const mm = mins % 60;
            const parts = [];
            if (hh > 0) parts.push(`${hh} giờ`);
            if (mm > 0) parts.push(`${mm} phút`);
            el.textContent = `Tổng thời gian: ${parts.join(' ')}.`;
            el.classList.remove('text-red-600');
        } else if (s != null && e != null) {
            el.textContent = 'Thời gian kết thúc phải sau thời gian bắt đầu.';
            el.classList.add('text-red-600');
        } else {
            el.textContent = '';
            el.classList.remove('text-red-600');
        }
    }
	function openLightbox(imageSrc, imageAlt) {
		const lightbox = document.getElementById('lightbox');
		const lightboxImage = document.getElementById('lightboxImage');
		const lightboxTitle = document.getElementById('lightboxTitle');
		
		lightboxImage.src = imageSrc;
		lightboxImage.alt = imageAlt;
		lightboxTitle.textContent = imageAlt;
		
		lightbox.classList.remove('hidden');
		lightbox.classList.add('show');
		document.body.style.overflow = 'hidden';
	}
	
	function closeLightbox() {
		const lightbox = document.getElementById('lightbox');
		lightbox.classList.remove('show');
		lightbox.classList.add('hide');
		
		setTimeout(() => {
			lightbox.classList.add('hidden');
			lightbox.classList.remove('hide');
			document.body.style.overflow = 'auto';
		}, 300);
	}
	
	// Close lightbox when clicking outside the image
	document.getElementById('lightbox').addEventListener('click', function(e) {
		if (e.target === this) {
			closeLightbox();
		}
	});
	
	// Close lightbox with Escape key
	document.addEventListener('keydown', function(e) {
		if (e.key === 'Escape') {
			closeLightbox();
		}
	});

	// Toggle inputs for "Khác"
	(function() {
		const datePurposeSelect = document.getElementById('datePurposeSelect');
		const spaceSelect = document.getElementById('spaceSelect');
		const spaceOtherWrapper = document.getElementById('spaceOtherWrapper');
		const budgetSelect = document.getElementById('budgetSelect');
		const form = document.getElementById('contactForm');
		const submitBtn = document.getElementById('submitContactBtn');
		const eventDate = document.getElementById('eventDate');
		const startInput = document.getElementById('bookingStartTime');
		const endInput = document.getElementById('bookingEndTime');

		if (spaceSelect) {
			spaceSelect.addEventListener('change', function() {
				spaceOtherWrapper.classList.toggle('hidden', this.value !== 'other');
			});
		}

		// Add input mask for date field
		if (eventDate) {
			eventDate.addEventListener('input', function(e) {
				let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
				
				// Add slashes automatically
				if (value.length >= 2) {
					value = value.substring(0, 2) + '/' + value.substring(2);
				}
				if (value.length >= 5) {
					value = value.substring(0, 5) + '/' + value.substring(5, 9);
				}
				
				e.target.value = value;
			});
		}

		// Update duration when times change programmatically
		[startInput, endInput].forEach(el => {
			if (!el) return;
			el.addEventListener('change', updateDurationText);
			el.addEventListener('input', updateDurationText);
		});

		// Helper functions for validation
		function showError(element, message) {
			element.classList.add('border-red-500');
			const errorDiv = element.parentNode.querySelector('.error-message');
			if (errorDiv) {
				errorDiv.textContent = message;
				errorDiv.classList.remove('hidden');
			}
		}

		function clearError(element) {
			element.classList.remove('border-red-500');
			const errorDiv = element.parentNode.querySelector('.error-message');
			if (errorDiv) {
				errorDiv.classList.add('hidden');
			}
		}

		function clearAllErrors() {
			form.querySelectorAll('.border-red-500').forEach(el => clearError(el));
		}

		function validateForm() {
			let isValid = true;
			clearAllErrors();

			// Required fields validation
			const fullNameInput = form.querySelector('input[name="fullName"]');
			const emailInput = form.querySelector('input[name="email"]');
			const phoneInput = form.querySelector('input[name="phone"]');
			const datePurposeSelect = form.querySelector('select[name="datePurpose"]');
			const budgetSelect = form.querySelector('select[name="budget"]');
			const messageInput = form.querySelector('textarea[name="message"]');

			const fullName = fullNameInput.value.trim();
			const email = emailInput.value.trim();
			const phone = phoneInput.value.trim();
			const datePurpose = datePurposeSelect.value;
			const budget = budgetSelect.value;
			const message = messageInput.value.trim();

			// Validate full name
			if (!fullName) {
				showError(fullNameInput, 'Vui lòng nhập họ tên');
				isValid = false;
			}

			// Validate email
			const emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
			if (!email) {
				showError(emailInput, 'Vui lòng nhập địa chỉ email');
				isValid = false;
			} else if (!emailRegex.test(email)) {
				showError(emailInput, 'Địa chỉ email không hợp lệ');
				isValid = false;
			}

			// Validate phone
			const phoneRegex = /^0[0-9]{9}$/;
			if (!phone) {
				showError(phoneInput, 'Vui lòng nhập số điện thoại');
				isValid = false;
			} else if (!phoneRegex.test(phone)) {
				showError(phoneInput, 'Số điện thoại phải có 10 số và bắt đầu bằng 0');
				isValid = false;
			}

			// Validate date purpose
			if (!datePurpose) {
				showError(datePurposeSelect, 'Vui lòng chọn mục đích buổi hẹn hò');
				isValid = false;
			}

			// Validate budget
			if (!budget) {
				showError(budgetSelect, 'Vui lòng chọn ngân sách');
				isValid = false;
			}

			// Validate message
			if (!message) {
				showError(messageInput, 'Vui lòng nhập điều bạn muốn MonAmour lưu ý');
				isValid = false;
			}

			// Date validation for dd/mm/yyyy format
			const dateVal = eventDate ? eventDate.value.trim() : '';
				if (dateVal) {
				const dateRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
				const match = dateVal.match(dateRegex);
				
				if (!match) {
					showError(eventDate, 'Định dạng ngày không hợp lệ (dd/mm/yyyy)');
					isValid = false;
				} else {
					const day = parseInt(match[1], 10);
					const month = parseInt(match[2], 10);
					const year = parseInt(match[3], 10);
					
					// Check if date is valid
					const inputDate = new Date(year, month - 1, day);
					if (inputDate.getDate() !== day || inputDate.getMonth() !== month - 1 || inputDate.getFullYear() !== year) {
						showError(eventDate, 'Ngày không hợp lệ');
						isValid = false;
					} else {
						// Check if date is not in the past
					const today = new Date();
						const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
						if (inputDate < todayStart) {
							showError(eventDate, 'Ngày tổ chức không được ở quá khứ');
							isValid = false;
						}
					}
				}
			}

				// Time validation
			const startVal = startInput ? startInput.value : '';
			const endVal = endInput ? endInput.value : '';
				const parse = (v) => {
					if (!v || v.indexOf(':') < 0) return null;
					const [h, m] = v.split(':').map(Number);
					if (Number.isNaN(h) || Number.isNaN(m)) return null;
					return h * 60 + m;
				};
				const s = parse(startVal);
				const en = parse(endVal);
			
			if (startVal && endVal) {
				if (s == null || en == null) {
					if (startInput) showError(startInput, 'Thời gian không hợp lệ');
					if (endInput) showError(endInput, 'Thời gian không hợp lệ');
					isValid = false;
				} else if (en <= s) {
					showError(endInput, 'Thời gian kết thúc phải sau thời gian bắt đầu');
					isValid = false;
				}
			}

			return isValid;
		}

		// Add real-time validation
		if (form) {
			// Real-time validation for input fields
			form.querySelectorAll('input[required], select[required], textarea[required], input[name="eventDate"]').forEach(field => {
				field.addEventListener('blur', function() {
					if (this.name === 'fullName' || this.name === 'email' || this.name === 'phone' || 
						this.name === 'datePurpose' || this.name === 'budget' || this.name === 'eventDate' || 
						this.name === 'message') {
						validateSingleField(this);
					}
				});
				
				field.addEventListener('input', function() {
					// Clear error on input change
					if (this.classList.contains('border-red-500')) {
						clearError(this);
					}
				});
			});
		}

		function validateSingleField(field) {
			const value = field.value.trim();
			
			switch (field.name) {
				case 'fullName':
					if (!value) {
						showError(field, 'Vui lòng nhập họ tên');
						return false;
					}
					break;
				case 'email':
					const emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
					if (!value) {
						showError(field, 'Vui lòng nhập địa chỉ email');
						return false;
					} else if (!emailRegex.test(value)) {
						showError(field, 'Địa chỉ email không hợp lệ');
						return false;
					}
					break;
				case 'phone':
					const phoneRegex = /^0[0-9]{9}$/;
					if (!value) {
						showError(field, 'Vui lòng nhập số điện thoại');
						return false;
					} else if (!phoneRegex.test(value)) {
						showError(field, 'Số điện thoại phải có 10 số và bắt đầu bằng 0');
						return false;
					}
					break;
				case 'datePurpose':
					if (!value) {
						showError(field, 'Vui lòng chọn mục đích buổi hẹn hò');
						return false;
					}
					break;
				case 'budget':
					if (!value) {
						showError(field, 'Vui lòng chọn ngân sách');
						return false;
					}
					break;
				case 'message':
					if (!value) {
						showError(field, 'Vui lòng nhập điều bạn muốn MonAmour lưu ý');
						return false;
					}
					break;
				case 'eventDate':
					if (value) {
						const dateRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
						const match = value.match(dateRegex);
						
						if (!match) {
							showError(field, 'Định dạng ngày không hợp lệ (dd/mm/yyyy)');
							return false;
						} else {
							const day = parseInt(match[1], 10);
							const month = parseInt(match[2], 10);
							const year = parseInt(match[3], 10);
							
							// Check if date is valid
							const inputDate = new Date(year, month - 1, day);
							if (inputDate.getDate() !== day || inputDate.getMonth() !== month - 1 || inputDate.getFullYear() !== year) {
								showError(field, 'Ngày không hợp lệ');
								return false;
							}
							
							// Check if date is not in the past
							const today = new Date();
							const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
							if (inputDate < todayStart) {
								showError(field, 'Ngày tổ chức không được ở quá khứ');
								return false;
							}
						}
					}
					break;
			}
			
			clearError(field);
			return true;
		}

		if (form) {
			form.addEventListener('submit', async function(e) {
				e.preventDefault();
				
				if (!validateForm()) {
					// Scroll to first error
					const firstError = form.querySelector('.border-red-500');
					if (firstError) {
						firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
						firstError.focus();
					}
					return;
				}

				submitBtn.disabled = true;
				submitBtn.textContent = 'Đang gửi...';

				const data = new FormData(form);
				// Ensure other fields are included
				if (spaceSelect && spaceSelect.value === 'other') {
					data.set('spacePreference', document.getElementById('spaceOther').value.trim());
				}
				
				// Convert date format from dd/mm/yyyy to yyyy-mm-dd for server processing if needed
				const eventDateValue = eventDate ? eventDate.value.trim() : '';
				if (eventDateValue) {
					const match = eventDateValue.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
					if (match) {
						const [, day, month, year] = match;
						data.set('eventDate', `${year}-${month}-${day}`);
					}
				}

				try {
					const res = await fetch(form.action, { method: 'POST', body: data, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
					if (!res.ok) {
						const msg = await res.text();
						alert(msg || 'Gửi yêu cầu thất bại, vui lòng thử lại.');
					} else {
						alert('Đã gửi yêu cầu tư vấn thành công! Vui lòng kiểm tra email.');
						form.reset();
					}
				} catch (err) {
					alert('Có lỗi xảy ra. Vui lòng thử lại sau.');
				} finally {
					submitBtn.disabled = false;
					submitBtn.textContent = 'Gửi yêu cầu';
				}
			});
		}
	})();
</script>
