@model MonAmour.Models.Concept
@{
	ViewData["Title"] = Model.Name + " - Mon Amour";
	var relatedConcepts = ViewBag.RelatedConcepts as List<MonAmour.Models.Concept>;
	var primaryImage = Model.ConceptImgs?.FirstOrDefault(img => img.IsPrimary == true)?.ImgUrl ?? Model.ConceptImgs?.FirstOrDefault()?.ImgUrl ?? "https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=800&h=600&fit=crop";
	var coverImages = Model.ConceptImgs?.Where(img => img.DisplayOrder == 2 || img.DisplayOrder == 3).OrderBy(img => img.DisplayOrder).ToList() ?? new List<MonAmour.Models.ConceptImg>();
	var detailImages = Model.ConceptImgs?.Where(img => img.DisplayOrder >= 4 && img.DisplayOrder <= 6).OrderBy(img => img.DisplayOrder).ToList() ?? new List<MonAmour.Models.ConceptImg>();
	var categories = ViewBag.Categories as List<MonAmour.Models.ConceptCategory>;
	var cities = ViewBag.Cities as List<string>;
}

<div class="min-h-screen bg-beige">

	<!-- Cover Images (Display Order 2,3) -->
	<section class="py-8">
		<div class="container mx-auto px-4">
			<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
				@if (coverImages.Count > 0)
				{
					<div class="relative cursor-pointer" onclick="openLightbox('@coverImages[0].ImgUrl', '@Model.Name')">
						<img src="@coverImages[0].ImgUrl" alt="@Model.Name" class="w-full h-96 object-cover rounded-2xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
						<div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-300 rounded-2xl flex items-center justify-center">
							<svg class="w-12 h-12 text-white opacity-0 hover:opacity-100 transition-opacity duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
							</svg>
						</div>
					</div>
				}
				@if (coverImages.Count > 1)
				{
					<div class="relative cursor-pointer" onclick="openLightbox('@coverImages[1].ImgUrl', '@Model.Name')">
						<img src="@coverImages[1].ImgUrl" alt="@Model.Name" class="w-full h-96 object-cover rounded-2xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
						<div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-300 rounded-2xl flex items-center justify-center">
							<svg class="w-12 h-12 text-white opacity-0 hover:opacity-100 transition-opacity duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
							</svg>
						</div>
					</div>
				}
			</div>
		</div>
	</section>

	<!-- Primary Image Section -->
	<section class="py-12">
		<div class="container mx-auto px-4 text-center">
			<h2 class="font-prata text-4xl md:text-5xl text-wine-red mb-6">@Model.Name</h2>
			<div class="w-full max-w-4xl mx-auto">
				<div class="relative cursor-pointer" onclick="openLightbox('@primaryImage', '@Model.Name')">
					<img src="@primaryImage" alt="@Model.Name" class="w-full h-64 md:h-80 object-cover rounded-2xl shadow-lg mb-6 hover:shadow-2xl transition-shadow duration-300">
					<div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-300 rounded-2xl flex items-center justify-center">
						<svg class="w-12 h-12 text-white opacity-0 hover:opacity-100 transition-opacity duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
						</svg>
					</div>
				</div>
				@if (!string.IsNullOrEmpty(Model.Description))
				{
					<p class="font-noto-serif text-lg text-gray-700 max-w-3xl mx-auto">@Model.Description</p>
				}
			</div>
		</div>
	</section>

	<!-- Detail Images Section (Display Order 4,5,6) -->
	@if (detailImages.Any())
	{
		<section class="py-12 bg-white/50">
			<div class="container mx-auto px-4">
				<!-- ·∫¢nh 4 v√† 5 theo thi·∫øt k·∫ø -->
				@if (detailImages.Count >= 2)
				{
					<!-- ·∫¢nh 4 v·ªõi m√¥ t·∫£ b√™n ph·∫£i -->
					<div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center mb-12">
						<div class="relative cursor-pointer" onclick="openLightbox('@detailImages[0].ImgUrl', '@detailImages[0].AltText')">
							<img src="@detailImages[0].ImgUrl" alt="@detailImages[0].AltText" class="w-full h-80 object-cover rounded-2xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
							<div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-300 rounded-2xl flex items-center justify-center">
								<svg class="w-12 h-12 text-white opacity-0 hover:opacity-100 transition-opacity duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
								</svg>
							</div>
						</div>
						<div>
							<h3 class="font-prata text-3xl text-wine-red mb-4">C√°c ƒëi·ªÉm n·ªïi b·∫≠t c·ªßa concept</h3>
							@if (!string.IsNullOrEmpty(detailImages[0].AltText))
							{
								<p class="font-noto-serif text-lg text-gray-700">@detailImages[0].AltText</p>
							}
						</div>
					</div>
					
					<!-- ·∫¢nh 5 v·ªõi m√¥ t·∫£ b√™n tr√°i -->
					<div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center mb-12">
						<div class="order-2 md:order-1">
							<h3 class="font-prata text-3xl text-wine-red mb-4">C√°c ƒëi·ªÉm n·ªïi b·∫≠t c·ªßa concept</h3>
							@if (!string.IsNullOrEmpty(detailImages[1].AltText))
							{
								<p class="font-noto-serif text-lg text-gray-700">@detailImages[1].AltText</p>
							}
						</div>
						<div class="order-1 md:order-2 relative cursor-pointer" onclick="openLightbox('@detailImages[1].ImgUrl', '@detailImages[1].AltText')">
							<img src="@detailImages[1].ImgUrl" alt="@detailImages[1].AltText" class="w-full h-80 object-cover rounded-2xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
							<div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-300 rounded-2xl flex items-center justify-center">
								<svg class="w-12 h-12 text-white opacity-0 hover:opacity-100 transition-opacity duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
								</svg>
							</div>
						</div>
					</div>
				}
				
				<!-- ·∫¢nh 6 x·∫øp to√†n b·ªô chi·ªÅu r·ªông nh∆∞ ·∫£nh primary -->
				@if (detailImages.Count >= 3)
				{
					<div class="text-center">
						<h3 class="font-prata text-3xl text-wine-red mb-6">Chi ti·∫øt v·ªÅ concept</h3>
						<div class="relative cursor-pointer inline-block" onclick="openLightbox('@detailImages[2].ImgUrl', '@detailImages[2].AltText')">
							<img src="@detailImages[2].ImgUrl" alt="@detailImages[2].AltText" class="w-full h-64 md:h-80 object-cover rounded-2xl shadow-lg mb-4 hover:shadow-2xl transition-shadow duration-300">
							<div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-300 rounded-2xl flex items-center justify-center">
								<svg class="w-12 h-12 text-white opacity-0 hover:opacity-100 transition-opacity duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
								</svg>
							</div>
						</div>
						@if (!string.IsNullOrEmpty(detailImages[2].AltText))
						{
							<p class="font-noto-serif text-gray-700 text-sm">@detailImages[2].AltText</p>
						}
					</div>
				}
			</div>
		</section>
	}

	<!-- Primary Image Information Section -->
	<section class="py-12">
		<div class="container mx-auto px-4 text-center">
			@{
				var primaryImageInfo = Model.ConceptImgs?.FirstOrDefault(img => img.IsPrimary == true);
			}
			@if (primaryImageInfo != null)
			{
				<div class="space-y-4">
					<h4 class="font-semibold text-wine-red text-xl text-center">@(primaryImageInfo.ImgName ?? "H√¨nh ·∫£nh ch√≠nh concept")</h4>
					<p class="text-gray-700 text-lg text-justify">@(primaryImageInfo.AltText ?? "·∫¢nh ch√≠nh c·ªßa concept " + Model.Name)</p>
				</div>
			}
			else
			{
				<div class="space-y-4">
					<h4 class="font-semibold text-wine-red text-xl text-center">H√¨nh ·∫£nh ch√≠nh concept</h4>
					<p class="text-gray-700 text-lg text-justify">·∫¢nh ch√≠nh c·ªßa concept @Model.Name</p>
				</div>
			}
		</div>
	</section>

	<!-- Chatbot Consultation Section -->
	<section id="chatbot-section" class="py-12 bg-white/50">
		@Html.AntiForgeryToken()
		<div class="container mx-auto px-4">
			<h3 class="font-prata text-3xl text-wine-red text-center mb-8">T∆∞ v·∫•n v·ªõi MonMon AI</h3>
			<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">
				<!-- Embedded Chatbot -->
				<div class="chatbot-embedded" data-concept-id="@Model.ConceptId" data-concept-name="@Model.Name" data-concept-price="@(Model.Price ?? 0)" data-concept-image="@primaryImage">
					<!-- Chatbot Header -->
					<div class="chat-header" style="background: #7f1d1d; padding: 16px; display: flex; align-items: center; justify-content: space-between;">
						<div class="header-info" style="display: flex; align-items: center; gap: 12px;">
							<!-- Logo v·ªõi icon tr√≤n v√† text -->
							<div style="display: flex; align-items: center; gap: 12px; background: rgba(251, 241, 230, 0.1); padding: 8px 16px; border-radius: 24px; border: 1px solid rgba(251, 241, 230, 0.2);">
								<div style="width: 40px; height: 40px; background: #fbf1e6; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
									<svg class="chatbot-logo" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 1024 1024" style="fill: #7f1d1d;">
										<path d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9zM351.7 448.2c0-29.5 23.9-53.5 53.5-53.5s53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5-53.5-23.9-53.5-53.5zm157.9 267.1c-67.8 0-123.8-47.5-132.3-109h264.6c-8.6 61.5-64.5 109-132.3 109zm110-213.7c-29.5 0-53.5-23.9-53.5-53.5s23.9-53.5 53.5-53.5 53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5zM867.2 644.5V453.1h26.5c19.4 0 35.1 15.7 35.1 35.1v121.1c0 19.4-15.7 35.1-35.1 35.1h-26.5zM95.2 609.4V488.2c0-19.4 15.7-35.1 35.1-35.1h26.5v191.3h-26.5c-19.4 0-35.1-15.7-35.1-35.1zM561.5 149.6c0 23.4-15.6 43.3-36.9 49.7v44.9h-30v-44.9c-21.4-6.5-36.9-26.3-36.9-49.7 0-28.6 23.3-51.9 51.9-51.9s51.9 23.3 51.9 51.9z" />
									</svg>
								</div>
								<h2 class="logo-text" style="color: #fbf1e6; font-family: 'Prata', serif; font-size: 1.25rem; margin: 0; font-weight: 600; letter-spacing: 0.5px;">MonMon AI</h2>
							</div>
						</div>
					</div>
					<!-- Chatbot Body -->
					<div class="chat-body-embedded" style="height: 500px; overflow-y: auto; padding: 20px; background: #f9f9f9;">
						<!-- Messages will be added by JavaScript -->
					</div>
					<!-- Chatbot Footer -->
					<div class="chat-footer-embedded" style="padding: 16px; background: white; border-top: 1px solid #e5e5e5;">
						<form action="#" class="chat-form-embedded" style="display: flex; gap: 8px; align-items: flex-end;">
							<textarea placeholder="Nh·∫≠p tin nh·∫Øn..." class="message-input-embedded" required style="flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 12px 16px; resize: none; min-height: 44px; max-height: 120px; font-family: inherit; font-size: 14px;"></textarea>
							<button type="submit" id="send-message-embedded" style="background: #7f1d1d; color: white; border: none; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s;">
								<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<line x1="22" y1="2" x2="11" y2="13"></line>
									<polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
								</svg>
							</button>
						</form>
					</div>
				</div>
			</div>
		</div>
	</section>

	<!-- Related Concepts -->
	@if (relatedConcepts != null && relatedConcepts.Any())
	{
		<section class="py-12 bg-white/50">
			<div class="container mx-auto px-4">
				<h3 class="font-prata text-3xl text-wine-red text-center mb-8">G√≥i d·ªãch v·ª• li√™n quan</h3>
				<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
					@foreach (var related in relatedConcepts)
					{
						var relatedImg = related.ConceptImgs?.FirstOrDefault(img => img.IsPrimary == true)?.ImgUrl ?? related.ConceptImgs?.FirstOrDefault()?.ImgUrl ?? "https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=400&h=300&fit=crop";
						<a href="@Url.Action("ConceptDetail", "Concept", new { id = related.ConceptId })" class="group">
							<div class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 overflow-hidden">
								<div class="relative overflow-hidden cursor-pointer" onclick="openLightbox('@relatedImg', '@related.Name')">
									<img src="@relatedImg" alt="@related.Name" class="w-full h-48 object-cover group-hover:scale-110 transition-transform duration-300">
									<div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
										<svg class="w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
										</svg>
									</div>
								</div>
								<div class="p-6">
									<h4 class="font-prata text-xl font-bold text-wine-red mb-2">@related.Name</h4>
									<p class="font-noto-serif text-gray-600 mb-4 line-clamp-2">@(related.Description?.Length > 100 ? related.Description.Substring(0, 100) + "..." : related.Description)</p>
									<div class="flex items-center justify-between">
										<span class="font-prata text-2xl font-bold text-wine-red">@String.Format("{0:N0}‚Ç´", related.Price)</span>
										<span class="text-sm text-gray-600">@related.Category?.Name</span>
									</div>
								</div>
							</div>
						</a>
					}
				</div>
			</div>
		</section>
	}
</div>

<!-- Lightbox Modal -->
<div id="lightbox" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center p-4">
	<div class="relative max-w-7xl max-h-full">
		<!-- Close Button -->
		<button onclick="closeLightbox()" class="absolute top-4 right-4 z-10 bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-full p-2 transition-all duration-200">
			<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
			</svg>
		</button>
		
		<!-- Image -->
		<img id="lightboxImage" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg">
		
		<!-- Image Info -->
		<div id="lightboxInfo" class="absolute bottom-4 left-4 right-4 bg-black bg-opacity-50 text-white p-4 rounded-lg">
			<h3 id="lightboxTitle" class="font-prata text-xl mb-2"></h3>
		</div>
	</div>
</div>

<style>
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
	
	/* Lightbox animations */
	#lightbox {
		backdrop-filter: blur(5px);
	}
	
	#lightbox.show {
		animation: fadeIn 0.3s ease-out;
	}
	
	#lightbox.hide {
		animation: fadeOut 0.3s ease-out;
	}
	
	@@keyframes fadeIn {
		from { opacity: 0; }
		to { opacity: 1; }
	}
	
	@@keyframes fadeOut {
		from { opacity: 1; }
		to { opacity: 0; }
	}

	.timepicker button { transition: background-color .15s ease, color .15s ease; }
	.timepicker button:hover { background-color: rgba(127, 29, 29, 0.08); }
	.timepicker button.active { background-color: rgba(127, 29, 29, 0.12); color: #7f1d1d; font-weight: 600; }
	
	/* Form validation styles */
	.form-field {
		transition: border-color 0.2s ease;
	}
	
	.form-field.valid {
		border-color: #10b981;
	}
	
	.form-field.invalid {
		border-color: #ef4444;
	}
	
	.error-message {
		animation: slideDown 0.3s ease-out;
	}
	
	@@keyframes slideDown {
		from { 
			opacity: 0; 
			transform: translateY(-10px); 
		}
		to { 
			opacity: 1; 
			transform: translateY(0); 
		}
	}
	
	/* Success feedback */
	.success-message {
		background-color: #dcfce7;
		border: 1px solid #10b981;
		color: #059669;
		padding: 12px 16px;
		border-radius: 8px;
		margin-bottom: 16px;
		animation: slideDown 0.3s ease-out;
	}
</style>

<script>
    let currentTimeTargetId = null;

    function showTimePicker(targetInputId) {
        currentTimeTargetId = targetInputId;
        const picker = document.getElementById('customTimePicker');
        const hoursCol = document.getElementById('hoursColumn');
        const minutesCol = document.getElementById('minutesColumn');
        const input = document.getElementById(targetInputId);

        // Populate hours and minutes if not initialized
        if (!hoursCol.dataset.initialized) {
            // Populate hours 08 - 22
            let hoursHtml = '';
            for (let h = 8; h <= 22; h++) {
                const hh = h.toString().padStart(2, '0');
                hoursHtml += `<button type="button" data-hour="${hh}" class="block w-full text-left px-4 py-2">${hh}</button>`;
            }
            hoursCol.innerHTML = hoursHtml;

            // Populate minutes 00, 15, 30, 45
            minutesCol.innerHTML = ['00','15','30','45']
                .map(m => `<button type=\"button\" data-minute=\"${m}\" class=\"block w-full text-left px-4 py-2\">${m}</button>`)
                .join('');

            // Mark as initialized
            hoursCol.dataset.initialized = 'true';
        }

        // Remove any existing event listeners
        hoursCol.replaceWith(hoursCol.cloneNode(true));
        minutesCol.replaceWith(minutesCol.cloneNode(true));
        
        // Re-get references after cloning
        const freshHoursCol = document.getElementById('hoursColumn');
        const freshMinutesCol = document.getElementById('minutesColumn');

        // Get current input's values
            let selectedHour = input.value && input.value.includes(':') ? input.value.split(':')[0] : null;
            let selectedMinute = input.value && input.value.includes(':') ? input.value.split(':')[1] : null;

            const updateActive = () => {
            freshHoursCol.querySelectorAll('button').forEach(b => {
                b.classList.toggle('active', b.getAttribute('data-hour') === selectedHour);
            });
            freshMinutesCol.querySelectorAll('button').forEach(b => {
                b.classList.toggle('active', b.getAttribute('data-minute') === selectedMinute);
            });
            };

            const scrollIntoViewSmooth = (btn, container) => {
                if (!btn) return;
                const top = btn.offsetTop - container.clientHeight / 2 + btn.clientHeight / 2;
                container.scrollTo({ top, behavior: 'smooth' });
            };

        // Add event listeners for the current session
        freshHoursCol.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-hour]');
            if (!btn) return;
            selectedHour = btn.getAttribute('data-hour');
            updateActive();
            scrollIntoViewSmooth(btn, freshHoursCol);
            
            // Commit time selection
                if (selectedHour && selectedMinute) {
                const targetInput = document.getElementById(currentTimeTargetId);
                if (targetInput) {
                    targetInput.value = `${selectedHour}:${selectedMinute}`;
                    hideTimePicker();
                    updateDurationText();
                }
            }
        });

        freshMinutesCol.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-minute]');
                if (!btn) return;
                selectedMinute = btn.getAttribute('data-minute');
                updateActive();
            scrollIntoViewSmooth(btn, freshMinutesCol);
            
            // Commit time selection
            if (selectedHour && selectedMinute) {
                const targetInput = document.getElementById(currentTimeTargetId);
                if (targetInput) {
                    targetInput.value = `${selectedHour}:${selectedMinute}`;
                    hideTimePicker();
                    updateDurationText();
                }
            }
        });

        picker.classList.remove('hidden');

        // Update active states and scroll to current values
        updateActive();
        scrollIntoViewSmooth(freshHoursCol.querySelector('button.active'), freshHoursCol);
        scrollIntoViewSmooth(freshMinutesCol.querySelector('button.active'), freshMinutesCol);

        // Click outside to close
        const outsideHandler = (ev) => {
            if (!picker.contains(ev.target) && ev.target.id !== targetInputId) {
                hideTimePicker();
                document.removeEventListener('click', outsideHandler);
            }
        };
        setTimeout(() => document.addEventListener('click', outsideHandler), 0);
    }

    function hideTimePicker() {
        const picker = document.getElementById('customTimePicker');
        picker.classList.add('hidden');
    }

    function parseHHMM(val) {
        if (!val || !val.includes(':')) return null;
        const [h, m] = val.split(':').map(Number);
        if (Number.isNaN(h) || Number.isNaN(m)) return null;
        return h * 60 + m;
    }

    function updateDurationText() {
        const start = document.getElementById('bookingStartTime').value;
        const end = document.getElementById('bookingEndTime').value;
        const el = document.getElementById('durationText');
        const s = parseHHMM(start);
        const e = parseHHMM(end);
        if (s != null && e != null && e > s) {
            const mins = e - s;
            const hh = Math.floor(mins / 60);
            const mm = mins % 60;
            const parts = [];
            if (hh > 0) parts.push(`${hh} gi·ªù`);
            if (mm > 0) parts.push(`${mm} ph√∫t`);
            el.textContent = `T·ªïng th·ªùi gian: ${parts.join(' ')}.`;
            el.classList.remove('text-red-600');
        } else if (s != null && e != null) {
            el.textContent = 'Th·ªùi gian k·∫øt th√∫c ph·∫£i sau th·ªùi gian b·∫Øt ƒë·∫ßu.';
            el.classList.add('text-red-600');
        } else {
            el.textContent = '';
            el.classList.remove('text-red-600');
        }
    }
	function openLightbox(imageSrc, imageAlt) {
		const lightbox = document.getElementById('lightbox');
		const lightboxImage = document.getElementById('lightboxImage');
		const lightboxTitle = document.getElementById('lightboxTitle');
		
		lightboxImage.src = imageSrc;
		lightboxImage.alt = imageAlt;
		lightboxTitle.textContent = imageAlt;
		
		lightbox.classList.remove('hidden');
		lightbox.classList.add('show');
		document.body.style.overflow = 'hidden';
	}
	
	function closeLightbox() {
		const lightbox = document.getElementById('lightbox');
		lightbox.classList.remove('show');
		lightbox.classList.add('hide');
		
		setTimeout(() => {
			lightbox.classList.add('hidden');
			lightbox.classList.remove('hide');
			document.body.style.overflow = 'auto';
		}, 300);
	}
	
	// Close lightbox when clicking outside the image
	document.getElementById('lightbox').addEventListener('click', function(e) {
		if (e.target === this) {
			closeLightbox();
		}
	});
	
	// Close lightbox with Escape key
	document.addEventListener('keydown', function(e) {
		if (e.key === 'Escape') {
			closeLightbox();
		}
	});

	// Toggle inputs for "Kh√°c"
	(function() {
		const datePurposeSelect = document.getElementById('datePurposeSelect');
		const spaceSelect = document.getElementById('spaceSelect');
		const spaceOtherWrapper = document.getElementById('spaceOtherWrapper');
		const budgetSelect = document.getElementById('budgetSelect');
		const form = document.getElementById('contactForm');
		const submitBtn = document.getElementById('submitContactBtn');
		const eventDate = document.getElementById('eventDate');
		const startInput = document.getElementById('bookingStartTime');
		const endInput = document.getElementById('bookingEndTime');

		if (spaceSelect) {
			spaceSelect.addEventListener('change', function() {
				spaceOtherWrapper.classList.toggle('hidden', this.value !== 'other');
			});
		}

		// Add input mask for date field
		if (eventDate) {
			eventDate.addEventListener('input', function(e) {
				let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
				
				// Add slashes automatically
				if (value.length >= 2) {
					value = value.substring(0, 2) + '/' + value.substring(2);
				}
				if (value.length >= 5) {
					value = value.substring(0, 5) + '/' + value.substring(5, 9);
				}
				
				e.target.value = value;
			});
		}

		// Update duration when times change programmatically
		[startInput, endInput].forEach(el => {
			if (!el) return;
			el.addEventListener('change', updateDurationText);
			el.addEventListener('input', updateDurationText);
		});

		// Helper functions for validation
		function showError(element, message) {
			element.classList.add('border-red-500');
			const errorDiv = element.parentNode.querySelector('.error-message');
			if (errorDiv) {
				errorDiv.textContent = message;
				errorDiv.classList.remove('hidden');
			}
		}

		function clearError(element) {
			element.classList.remove('border-red-500');
			const errorDiv = element.parentNode.querySelector('.error-message');
			if (errorDiv) {
				errorDiv.classList.add('hidden');
			}
		}

		function clearAllErrors() {
			form.querySelectorAll('.border-red-500').forEach(el => clearError(el));
		}

		function validateForm() {
			let isValid = true;
			clearAllErrors();

			// Required fields validation
			const fullNameInput = form.querySelector('input[name="fullName"]');
			const emailInput = form.querySelector('input[name="email"]');
			const phoneInput = form.querySelector('input[name="phone"]');
			const datePurposeSelect = form.querySelector('select[name="datePurpose"]');
			const budgetSelect = form.querySelector('select[name="budget"]');
			const messageInput = form.querySelector('textarea[name="message"]');

			const fullName = fullNameInput.value.trim();
			const email = emailInput.value.trim();
			const phone = phoneInput.value.trim();
			const datePurpose = datePurposeSelect.value;
			const budget = budgetSelect.value;
			const message = messageInput.value.trim();

			// Validate full name
			if (!fullName) {
				showError(fullNameInput, 'Vui l√≤ng nh·∫≠p h·ªç t√™n');
				isValid = false;
			}

			// Validate email
			const emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
			if (!email) {
				showError(emailInput, 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ email');
				isValid = false;
			} else if (!emailRegex.test(email)) {
				showError(emailInput, 'ƒê·ªãa ch·ªâ email kh√¥ng h·ª£p l·ªá');
				isValid = false;
			}

			// Validate phone
			const phoneRegex = /^0[0-9]{9}$/;
			if (!phone) {
				showError(phoneInput, 'Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i');
				isValid = false;
			} else if (!phoneRegex.test(phone)) {
				showError(phoneInput, 'S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10 s·ªë v√† b·∫Øt ƒë·∫ßu b·∫±ng 0');
				isValid = false;
			}

			// Validate date purpose
			if (!datePurpose) {
				showError(datePurposeSelect, 'Vui l√≤ng ch·ªçn m·ª•c ƒë√≠ch bu·ªïi h·∫πn h√≤');
				isValid = false;
			}

			// Validate budget
			if (!budget) {
				showError(budgetSelect, 'Vui l√≤ng ch·ªçn ng√¢n s√°ch');
				isValid = false;
			}

			// Validate message
			if (!message) {
				showError(messageInput, 'Vui l√≤ng nh·∫≠p ƒëi·ªÅu b·∫°n mu·ªën MonAmour l∆∞u √Ω');
				isValid = false;
			}

			// Date validation for dd/mm/yyyy format
			const dateVal = eventDate ? eventDate.value.trim() : '';
				if (dateVal) {
				const dateRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
				const match = dateVal.match(dateRegex);
				
				if (!match) {
					showError(eventDate, 'ƒê·ªãnh d·∫°ng ng√†y kh√¥ng h·ª£p l·ªá (dd/mm/yyyy)');
					isValid = false;
				} else {
					const day = parseInt(match[1], 10);
					const month = parseInt(match[2], 10);
					const year = parseInt(match[3], 10);
					
					// Check if date is valid
					const inputDate = new Date(year, month - 1, day);
					if (inputDate.getDate() !== day || inputDate.getMonth() !== month - 1 || inputDate.getFullYear() !== year) {
						showError(eventDate, 'Ng√†y kh√¥ng h·ª£p l·ªá');
						isValid = false;
					} else {
						// Check if date is not in the past
					const today = new Date();
						const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
						if (inputDate < todayStart) {
							showError(eventDate, 'Ng√†y t·ªï ch·ª©c kh√¥ng ƒë∆∞·ª£c ·ªü qu√° kh·ª©');
							isValid = false;
						}
					}
				}
			}

				// Time validation
			const startVal = startInput ? startInput.value : '';
			const endVal = endInput ? endInput.value : '';
				const parse = (v) => {
					if (!v || v.indexOf(':') < 0) return null;
					const [h, m] = v.split(':').map(Number);
					if (Number.isNaN(h) || Number.isNaN(m)) return null;
					return h * 60 + m;
				};
				const s = parse(startVal);
				const en = parse(endVal);
			
			if (startVal && endVal) {
				if (s == null || en == null) {
					if (startInput) showError(startInput, 'Th·ªùi gian kh√¥ng h·ª£p l·ªá');
					if (endInput) showError(endInput, 'Th·ªùi gian kh√¥ng h·ª£p l·ªá');
					isValid = false;
				} else if (en <= s) {
					showError(endInput, 'Th·ªùi gian k·∫øt th√∫c ph·∫£i sau th·ªùi gian b·∫Øt ƒë·∫ßu');
					isValid = false;
				}
			}

			return isValid;
		}

		// Add real-time validation
		if (form) {
			// Real-time validation for input fields
			form.querySelectorAll('input[required], select[required], textarea[required], input[name="eventDate"]').forEach(field => {
				field.addEventListener('blur', function() {
					if (this.name === 'fullName' || this.name === 'email' || this.name === 'phone' || 
						this.name === 'datePurpose' || this.name === 'budget' || this.name === 'eventDate' || 
						this.name === 'message') {
						validateSingleField(this);
					}
				});
				
				field.addEventListener('input', function() {
					// Clear error on input change
					if (this.classList.contains('border-red-500')) {
						clearError(this);
					}
				});
			});
		}

		function validateSingleField(field) {
			const value = field.value.trim();
			
			switch (field.name) {
				case 'fullName':
					if (!value) {
						showError(field, 'Vui l√≤ng nh·∫≠p h·ªç t√™n');
						return false;
					}
					break;
				case 'email':
					const emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
					if (!value) {
						showError(field, 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ email');
						return false;
					} else if (!emailRegex.test(value)) {
						showError(field, 'ƒê·ªãa ch·ªâ email kh√¥ng h·ª£p l·ªá');
						return false;
					}
					break;
				case 'phone':
					const phoneRegex = /^0[0-9]{9}$/;
					if (!value) {
						showError(field, 'Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i');
						return false;
					} else if (!phoneRegex.test(value)) {
						showError(field, 'S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10 s·ªë v√† b·∫Øt ƒë·∫ßu b·∫±ng 0');
						return false;
					}
					break;
				case 'datePurpose':
					if (!value) {
						showError(field, 'Vui l√≤ng ch·ªçn m·ª•c ƒë√≠ch bu·ªïi h·∫πn h√≤');
						return false;
					}
					break;
				case 'budget':
					if (!value) {
						showError(field, 'Vui l√≤ng ch·ªçn ng√¢n s√°ch');
						return false;
					}
					break;
				case 'message':
					if (!value) {
						showError(field, 'Vui l√≤ng nh·∫≠p ƒëi·ªÅu b·∫°n mu·ªën MonAmour l∆∞u √Ω');
						return false;
					}
					break;
				case 'eventDate':
					if (value) {
						const dateRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
						const match = value.match(dateRegex);
						
						if (!match) {
							showError(field, 'ƒê·ªãnh d·∫°ng ng√†y kh√¥ng h·ª£p l·ªá (dd/mm/yyyy)');
							return false;
						} else {
							const day = parseInt(match[1], 10);
							const month = parseInt(match[2], 10);
							const year = parseInt(match[3], 10);
							
							// Check if date is valid
							const inputDate = new Date(year, month - 1, day);
							if (inputDate.getDate() !== day || inputDate.getMonth() !== month - 1 || inputDate.getFullYear() !== year) {
								showError(field, 'Ng√†y kh√¥ng h·ª£p l·ªá');
								return false;
							}
							
							// Check if date is not in the past
							const today = new Date();
							const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
							if (inputDate < todayStart) {
								showError(field, 'Ng√†y t·ªï ch·ª©c kh√¥ng ƒë∆∞·ª£c ·ªü qu√° kh·ª©');
								return false;
							}
						}
					}
					break;
			}
			
			clearError(field);
			return true;
		}

		if (form) {
			form.addEventListener('submit', async function(e) {
				e.preventDefault();
				
				if (!validateForm()) {
					// Scroll to first error
					const firstError = form.querySelector('.border-red-500');
					if (firstError) {
						firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
						firstError.focus();
					}
					return;
				}

				submitBtn.disabled = true;
				submitBtn.textContent = 'ƒêang g·ª≠i...';

				const data = new FormData(form);
				// Ensure other fields are included
				if (spaceSelect && spaceSelect.value === 'other') {
					data.set('spacePreference', document.getElementById('spaceOther').value.trim());
				}
				
				// Convert date format from dd/mm/yyyy to yyyy-mm-dd for server processing if needed
				const eventDateValue = eventDate ? eventDate.value.trim() : '';
				if (eventDateValue) {
					const match = eventDateValue.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
					if (match) {
						const [, day, month, year] = match;
						data.set('eventDate', `${year}-${month}-${day}`);
					}
				}

				try {
					const res = await fetch(form.action, { method: 'POST', body: data, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
					if (!res.ok) {
						const msg = await res.text();
						alert(msg || 'G·ª≠i y√™u c·∫ßu th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i.');
					} else {
						alert('ƒê√£ g·ª≠i y√™u c·∫ßu t∆∞ v·∫•n th√†nh c√¥ng! Vui l√≤ng ki·ªÉm tra email.');
						form.reset();
					}
				} catch (err) {
					alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.');
				} finally {
					submitBtn.disabled = false;
					submitBtn.textContent = 'G·ª≠i y√™u c·∫ßu';
				}
			});
		}
	})();
</script>

<script>
	// Embedded Chatbot for Concept Detail Page
	(function() {
		const chatbotContainer = document.querySelector('.chatbot-embedded');
		if (!chatbotContainer) return;

		const chatBody = chatbotContainer.querySelector('.chat-body-embedded');
		const messageInput = chatbotContainer.querySelector('.message-input-embedded');
		const sendButton = chatbotContainer.querySelector('#send-message-embedded');
		const chatForm = chatbotContainer.querySelector('.chat-form-embedded');

		const conceptId = parseInt(chatbotContainer.dataset.conceptId);
		const conceptName = chatbotContainer.dataset.conceptName;
		const conceptPrice = parseFloat(chatbotContainer.dataset.conceptPrice);
		const conceptImage = chatbotContainer.dataset.conceptImage;

		// API setup - Same as main chatbot
		const API_KEY = "AIzaSyD9QOuOGBhAsCw2DFA8pF9PW2m05i8c4wo";
		const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

		let chatHistory = [{
			role: "model",
			parts: [{
				text: `Xin ch√†o! üëã T√¥i l√† MonMon AI, tr·ª£ l√Ω c·ªßa Mon Amour. 

T√¥i s·∫Ω t·∫°o concept kh√¥ng gian h·∫πn h√≤ l√£ng m·∫°n cho b·∫°n d·ª±a tr√™n concept "${conceptName}" v·ªõi gi√° ${conceptPrice.toLocaleString('vi-VN')}‚Ç´.

H√£y ƒë·ªÉ t√¥i t·∫°o h√¨nh ·∫£nh concept cho b·∫°n... üé®`
			}],
		}];

		let selectedConcept = false;
		let generatedConceptImageUrl = null;
		let formData = {};
		let currentImageElement = null; // Track current image element to remove when creating new one
		let userBookingInfo = null; // Store user booking information for chatbot context
		
		// Training data from JSON
		let trainingData = null;
		let trainingSystemPrompt = "";
		let companyInfo = null;
		
		// Load training data from JSON
		async function loadTrainingData() {
			try {
				const response = await fetch('/data/chatbot_training_data.json');
				const data = await response.json();
				trainingData = data.training_data || [];
				trainingSystemPrompt = data.system_prompt || "";
				companyInfo = data.company_info || null;
				console.log('Training data loaded successfully:', data);
			} catch (error) {
				console.error('Error loading training data:', error);
				trainingData = [];
				trainingSystemPrompt = "B·∫°n l√† MonMon AI, tr·ª£ l√Ω chuy√™n nghi·ªáp c·ªßa Mon Amour - d·ªãch v·ª• h·∫πn h√≤ cao c·∫•p. H√£y tr·∫£ l·ªùi m·ªôt c√°ch th√¢n thi·ªán v√† h·ªØu √≠ch.";
			}
		}
		
		// Find best answer from training data based on user message
		function findBestAnswer(userMessage) {
			if (!trainingData || trainingData.length === 0) return null;
			
			const msgLower = userMessage.toLowerCase().trim();
			let bestMatch = null;
			let maxScore = 0;
			
			// Score based on keyword matches and question similarity
			for (const item of trainingData) {
				let score = 0;
				
				// Check keywords match
				if (item.keywords && Array.isArray(item.keywords)) {
					for (const keyword of item.keywords) {
						if (msgLower.includes(keyword.toLowerCase())) {
							score += 2; // Keyword match gives higher score
						}
					}
				}
				
				// Check question similarity (simple word matching)
				const questionLower = item.question.toLowerCase();
				const questionWords = questionLower.split(/\s+/);
				const userWords = msgLower.split(/\s+/);
				
				for (const userWord of userWords) {
					if (userWord.length > 2 && questionLower.includes(userWord)) {
						score += 1; // Word match gives lower score
					}
				}
				
				// Check exact phrase match
				if (questionLower.includes(msgLower) || msgLower.includes(questionLower.substring(0, 20))) {
					score += 5; // Phrase match gives highest score
				}
				
				if (score > maxScore) {
					maxScore = score;
					bestMatch = item;
				}
			}
			
			// Only return if score is above threshold
			return maxScore >= 2 ? bestMatch : null;
		}
		
		// OpenAI DALL-E 3 API setup
				const OPENAI_API_KEY = "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";
		const DALL_E_API_URL = "https://api.openai.com/v1/images/generations";

		// Format bot response with icons and line breaks (only for AI text responses)
		function formatBotResponse(text) {
			if (!text) return text;
			
			// Replace markdown lists with formatted lists
			text = text.replace(/\*\s+/g, '‚Ä¢ ');
			text = text.replace(/^\d+\.\s+/gm, '‚Ä¢ ');
			
			// Add line breaks before bullet points for better readability
			text = text.replace(/(‚Ä¢\s+[^\n]+)/g, '\n$1');
			
			// Format common patterns with icons
			text = text.replace(/Gi√°:|Gi√° concept:/gi, 'üí∞ Gi√°:');
			text = text.replace(/Ng√†y h·∫πn h√≤:|Ng√†y:/gi, 'üìÖ Ng√†y h·∫πn h√≤:');
			text = text.replace(/Th·ªùi gian:|Kho·∫£ng th·ªùi gian:/gi, '‚è∞ Th·ªùi gian:');
			text = text.replace(/Email:|email:/gi, 'üìß Email:');
			text = text.replace(/S·ªë ƒëi·ªán tho·∫°i:|SƒêT:|Phone:/gi, 'üìû SƒêT:');
			text = text.replace(/Thanh to√°n:|Payment:/gi, 'üí≥ Thanh to√°n:');
			text = text.replace(/Booking:|ƒê·∫∑t concept:/gi, 'üìã Booking:');
			text = text.replace(/Concept:|Concept ƒë√£ ch·ªçn:/gi, 'üé® Concept:');
			text = text.replace(/M·ª•c ƒë√≠ch:|M·ª•c ƒë√≠ch bu·ªïi h·∫πn h√≤:/gi, 'üíù M·ª•c ƒë√≠ch:');
			text = text.replace(/Ng√¢n s√°ch:|Budget:/gi, 'üíµ Ng√¢n s√°ch:');
			text = text.replace(/Kh√¥ng gian:|Kh√¥ng gian mong mu·ªën:/gi, 'üè† Kh√¥ng gian:');
			text = text.replace(/Th√¥ng tin:|Th√¥ng tin booking:/gi, '‚ÑπÔ∏è Th√¥ng tin:');
			
			// Add icons to common phrases
			text = text.replace(/T∆∞ v·∫•n/gi, 'üí¨ T∆∞ v·∫•n');
			text = text.replace(/H·ªó tr·ª£/gi, 'ü§ù H·ªó tr·ª£');
			text = text.replace(/L·ª£i √≠ch/gi, '‚ú® L·ª£i √≠ch');
			text = text.replace(/K·∫øt n·ªëi/gi, 'üîó K·∫øt n·ªëi');
			text = text.replace(/H·ªì s∆°/gi, 'üìÑ H·ªì s∆°');
			text = text.replace(/Ch·ª•p ·∫£nh/gi, 'üì∏ Ch·ª•p ·∫£nh');
			
			// Add spacing between paragraphs
			text = text.replace(/\n\n+/g, '\n\n');
			
			// Clean up extra spaces
			text = text.trim();
			
			return text;
		}

		// Create message element
		function createMessageElement(content, isUser = false, isHtmlContent = false) {
			const div = document.createElement('div');
			div.style.cssText = `display: flex; gap: 10px; margin-bottom: 16px; ${isUser ? 'flex-direction: row-reverse;' : ''}`;
			
			// Format bot response with icons and line breaks (only for plain text AI responses, not HTML content like forms/QR)
			let formattedContent = content;
			if (!isUser && !isHtmlContent && !content.includes('<div') && !content.includes('<form') && !content.includes('<img')) {
				formattedContent = formatBotResponse(content);
				// Convert newlines to <br> for proper line breaks
				formattedContent = formattedContent.replace(/\n/g, '<br>');
			}
			
			if (!isUser) {
				div.innerHTML = `
					<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 1024 1024" style="fill: #7f1d1d; flex-shrink: 0;">
						<path d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9z"/>
					</svg>
					<div style="background: white; padding: 12px 16px; border-radius: 18px; max-width: 75%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); ${!isHtmlContent ? 'line-height: 1.6; word-wrap: break-word;' : ''}">
						<div class="message-text" ${!isHtmlContent ? 'style="white-space: pre-wrap;"' : ''}>${formattedContent}</div>
					</div>
				`;
			} else {
				div.innerHTML = `
					<div style="background: #7f1d1d; color: white; padding: 12px 16px; border-radius: 18px; max-width: 75%; line-height: 1.6; word-wrap: break-word;">
						<div class="message-text" style="white-space: pre-wrap;">${content}</div>
					</div>
				`;
			}
			
			return div;
		}

		// Check if user wants to generate image
		function isImageGenerationRequest(message) {
			const imageKeywords = [
				't·∫°o ·∫£nh', 't·∫°o h√¨nh', 'v·∫Ω ·∫£nh', 'v·∫Ω h√¨nh', 't·∫°o h√¨nh ·∫£nh', 'sinh ·∫£nh',
				'generate image', 'create image', 't·∫°o cho t√¥i ·∫£nh', 't·∫°o concept',
				'cho t√¥i xem', 'visualize', 'h√¨nh dung', 'kh√¥ng gian h·∫πn h√≤',
				'concept h·∫πn h√≤', 'phong c√°ch h·∫πn h√≤', 't·∫°o l·∫°i', 't·∫°o m·ªõi'
			];
			const msgLower = message.toLowerCase();
			return imageKeywords.some(keyword => msgLower.includes(keyword.toLowerCase()));
		}

		// Generate concept image
		async function generateConceptImage(customPrompt = null) {
			// Remove previous image element if exists
			if (currentImageElement) {
				currentImageElement.remove();
				currentImageElement = null;
			}
			
			const thinkingDiv = createMessageElement('<div style="display: flex; gap: 4px;"><div style="width: 8px; height: 8px; background: #999; border-radius: 50%; animation: pulse 1s infinite;"></div><div style="width: 8px; height: 8px; background: #999; border-radius: 50%; animation: pulse 1s infinite 0.2s;"></div><div style="width: 8px; height: 8px; background: #999; border-radius: 50%; animation: pulse 1s infinite 0.4s;"></div></div>', false);
			chatBody.appendChild(thinkingDiv);
			chatBody.scrollTop = chatBody.scrollHeight;

			try {
				// Use DALL-E 3 to generate image
				if (OPENAI_API_KEY && OPENAI_API_KEY.trim() !== "") {
					// Use custom prompt if provided, otherwise use default
					let dallePrompt;
					if (customPrompt) {
						dallePrompt = `Professional romantic dating space setup, ${customPrompt}, elegant romantic atmosphere, soft warm lighting, beautiful decorations with flowers and candles, high quality, photorealistic, interior design, cozy intimate setting, Mon Amour style`;
					} else {
						dallePrompt = `Professional romantic dating space setup inspired by "${conceptName}", elegant romantic atmosphere, soft warm lighting, beautiful decorations with flowers and candles, high quality, photorealistic, interior design, cozy intimate setting, Mon Amour style`;
					}
					
					const requestOptions = {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
							"Authorization": `Bearer ${OPENAI_API_KEY}`
						},
						body: JSON.stringify({
							model: "dall-e-3",
							prompt: dallePrompt,
							n: 1,
							size: "1024x1024",
							quality: "standard"
						})
					};

					const response = await fetch(DALL_E_API_URL, requestOptions);
					const data = await response.json();

					if (!response.ok) {
						throw new Error(data.error?.message || "C√≥ l·ªói x·∫£y ra khi t·∫°o ·∫£nh");
					}

					generatedConceptImageUrl = data.data[0].url;
					
					thinkingDiv.remove();
					
					// Generate unique ID for button
					const uniqueId = 'book-concept-btn-' + Date.now();
					
					const imageHtml = `
						<div style="background: white; padding: 20px; border-radius: 12px; margin: 16px 0; border: 2px solid #7f1d1d;">
							<h4 style="color: #7f1d1d; margin-top: 0; margin-bottom: 16px; font-family: 'Prata', serif;">üé® Concept kh√¥ng gian h·∫πn h√≤ c·ªßa b·∫°n</h4>
							<img src="${generatedConceptImageUrl}" alt="Concept h·∫πn h√≤" style="width: 100%; max-width: 100%; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
							<p style="color: #666; font-size: 14px; margin-bottom: 16px;">ƒê√¢y l√† concept kh√¥ng gian h·∫πn h√≤ l√£ng m·∫°n ƒë∆∞·ª£c t·∫°o ri√™ng cho b·∫°n! üíù</p>
							<p style="color: #666; font-size: 14px; margin-bottom: 16px;"><strong>Gi√°:</strong> ${conceptPrice.toLocaleString('vi-VN')}‚Ç´</p>
							<button id="${uniqueId}" style="background: #7f1d1d; color: white; padding: 12px 24px; border: none; border-radius: 24px; font-weight: 600; cursor: pointer; width: 100%; font-size: 16px; margin-top: 8px;">
								üíù T√¥i mu·ªën ƒë·∫∑t concept n√†y
							</button>
						</div>
					`;
					
					const imageDiv = createMessageElement(imageHtml, false, true); // true = isHtmlContent, don't format
					chatBody.appendChild(imageDiv);
					currentImageElement = imageDiv; // Store reference to current image element
					chatBody.scrollTop = chatBody.scrollHeight;
					
					// Add event listener to button
					const bookBtn = document.getElementById(uniqueId);
					if (bookBtn) {
						bookBtn.addEventListener('click', () => {
							if (!selectedConcept) {
								showBookingForm();
							}
						});
					}
				} else {
					throw new Error("OpenAI API key ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh");
				}
			} catch (error) {
				console.error("Image Generation Error:", error);
				thinkingDiv.remove();
				const errorMsg = createMessageElement(`Xin l·ªói, c√≥ l·ªói x·∫£y ra khi t·∫°o h√¨nh ·∫£nh concept. ${error.message}`, false);
				chatBody.appendChild(errorMsg);
				chatBody.scrollTop = chatBody.scrollHeight;
			}
		}

		// Add welcome message
		function addWelcomeMessage() {
			const welcomeMsg = chatHistory[0].parts[0].text;
			const msgDiv = createMessageElement(welcomeMsg, false);
			chatBody.appendChild(msgDiv);
			
			// Auto-generate concept image
			setTimeout(() => generateConceptImage(), 1000);
		}

		// Check if user wants to fill contact form (explicit request only)
		function isBookingFormRequest(message) {
			const formKeywords = [
				'ƒëi·ªÅn th√¥ng tin', 'ƒëi·ªÅn form', 'nh·∫≠p th√¥ng tin', 'ƒëi·ªÅn th√¥ng tin li√™n h·ªá',
				't√¥i mu·ªën ƒë·∫∑t', 'mu·ªën ƒë·∫∑t concept', 'ƒë·∫∑t concept', 'ƒë·∫∑t booking',
				'x√°c nh·∫≠n ƒë·∫∑t', 'ƒë·∫∑t ngay', 'ƒë·∫∑t ngay concept',
				'fill form', 'fill information', 'book now', 'book concept'
			];
			const msgLower = message.toLowerCase();
			return formKeywords.some(keyword => msgLower.includes(keyword));
		}

		// Show booking form
		function showBookingForm() {
			if (selectedConcept) return; // Already shown
			selectedConcept = true;

			const formHtml = `
				<div style="background: white; padding: 20px; border-radius: 12px; margin: 16px 0; border: 2px solid #7f1d1d;">
					<h4 style="color: #7f1d1d; margin-top: 0; margin-bottom: 16px; font-family: 'Prata', serif;">üìã ƒêi·ªÅn th√¥ng tin ƒë·∫∑t concept</h4>
					<form id="chatbot-booking-form" style="display: grid; gap: 12px;">
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
							<div>
								<label style="display: block; font-size: 12px; color: #7f1d1d; margin-bottom: 4px; font-weight: 600;">H·ªç t√™n *</label>
								<input type="text" name="fullName" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
							</div>
							<div>
								<label style="display: block; font-size: 12px; color: #7f1d1d; margin-bottom: 4px; font-weight: 600;">Email *</label>
								<input type="email" name="email" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
							</div>
							<div>
								<label style="display: block; font-size: 12px; color: #7f1d1d; margin-bottom: 4px; font-weight: 600;">S·ªë ƒëi·ªán tho·∫°i *</label>
								<input type="tel" name="phone" required pattern="^0[0-9]{9}$" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" placeholder="0xxxxxxxxx">
							</div>
							<div>
								<label style="display: block; font-size: 12px; color: #7f1d1d; margin-bottom: 4px; font-weight: 600;">N∆°i s·ªëng hi·ªán t·∫°i</label>
								<input type="text" name="currentLocation" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
							</div>
							<div>
								<label style="display: block; font-size: 12px; color: #7f1d1d; margin-bottom: 4px; font-weight: 600;">M·ª•c ƒë√≠ch bu·ªïi h·∫πn h√≤ *</label>
								<select name="datePurpose" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
									<option value="">Ch·ªçn m·ª•c ƒë√≠ch</option>
									<option value="First date">First date</option>
									<option value="Normal date">Normal date</option>
									<option value="Anniversary/Birthday">K·ª∑ ni·ªám ng√†y ƒë·∫∑c bi·ªát</option>
									<option value="Proposal">C·∫ßu h√¥n/Proposal</option>
									<option value="other">Kh√°c</option>
								</select>
							</div>
							<div>
								<label style="display: block; font-size: 12px; color: #7f1d1d; margin-bottom: 4px; font-weight: 600;">Ng√¢n s√°ch mong mu·ªën *</label>
								<select name="budget" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
									<option value="">Ch·ªçn ng√¢n s√°ch</option>
									<option value="Standard">D∆∞·ªõi 1.000.000ƒë</option>
									<option value="Signature">1.000.000ƒë ‚Äì 2.000.000ƒë</option>
									<option value="Premium">2.000.000ƒë ‚Äì 4.000.000ƒë</option>
									<option value="Haute Amour">Tr√™n 5.000.000ƒë</option>
								</select>
							</div>
							<div>
								<label style="display: block; font-size: 12px; color: #7f1d1d; margin-bottom: 4px; font-weight: 600;">Ng√†y h·∫πn h√≤</label>
								<input type="text" name="eventDate" placeholder="dd/mm/yyyy" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
							</div>
							<div>
								<label style="display: block; font-size: 12px; color: #7f1d1d; margin-bottom: 4px; font-weight: 600;">Kho·∫£ng th·ªùi gian</label>
								<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
									<input type="text" name="eventStartTime" placeholder="T·ª´ (hh:mm)" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
									<input type="text" name="eventEndTime" placeholder="ƒê·∫øn (hh:mm)" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
								</div>
							</div>
							<div style="grid-column: 1 / -1;">
								<label style="display: block; font-size: 12px; color: #7f1d1d; margin-bottom: 4px; font-weight: 600;">Kh√¥ng gian mong mu·ªën</label>
								<select name="spacePreference" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
									<option value="">Ch·ªçn kh√¥ng gian</option>
									<option value="Private">T·∫°i nh√†/Homestay</option>
									<option value="Restaurant/Cafe">Nh√† h√†ng/Qu√°n Caf√©</option>
									<option value="Rooftop/Outdoor">Rooftop/Outdoor</option>
									<option value="Beach/Lake/Garden">B√£i bi·ªÉn/H·ªì/S√¢n v∆∞·ªùn</option>
									<option value="other">Kh√°c</option>
								</select>
							</div>
							<div style="grid-column: 1 / -1;">
								<label style="display: block; font-size: 12px; color: #7f1d1d; margin-bottom: 4px; font-weight: 600;">ƒêi·ªÅu b·∫°n mu·ªën MonAmour l∆∞u √Ω *</label>
								<textarea name="message" required rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
							</div>
							<div style="grid-column: 1 / -1;">
								<label style="display: block; font-size: 12px; color: #7f1d1d; margin-bottom: 4px; font-weight: 600;">B·∫°n bi·∫øt ƒë·∫øn MonAmour qua?</label>
								<select name="referral" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
									<option>Facebook</option>
									<option>Instagram</option>
									<option>TikTok</option>
									<option>T√¨m ki·∫øm Google</option>
									<option>Ng∆∞·ªùi quen gi·ªõi thi·ªáu</option>
									<option>Kh√°c</option>
								</select>
							</div>
						</div>
						<button type="submit" style="background: #7f1d1d; color: white; padding: 12px 24px; border: none; border-radius: 24px; font-weight: 600; cursor: pointer; margin-top: 8px;">
							X√°c nh·∫≠n ƒë·∫∑t concept
						</button>
					</form>
				</div>
			`;

			const formDiv = createMessageElement(formHtml, false, true); // true = isHtmlContent, don't format
			chatBody.appendChild(formDiv);
			chatBody.scrollTop = chatBody.scrollHeight;

			// Handle form submission
			const form = document.getElementById('chatbot-booking-form');
			if (form) {
				form.addEventListener('submit', async (e) => {
					e.preventDefault();
					const submitBtn = form.querySelector('button[type="submit"]');
					submitBtn.disabled = true;
					submitBtn.textContent = 'ƒêang x·ª≠ l√Ω...';

					const formDataObj = new FormData(form);
					formDataObj.append('conceptId', conceptId);
					
					// Add concept image URL from chatbot
					if (generatedConceptImageUrl) {
						formDataObj.append('conceptImageUrl', generatedConceptImageUrl);
					}
					
					// Get AntiForgeryToken from page
					const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
					if (token) {
						formDataObj.append('__RequestVerificationToken', token);
					}

					try {
						const response = await fetch('@Url.Action("SubmitChatbotContact", "Concept")', {
							method: 'POST',
							body: formDataObj,
							headers: {
								'X-Requested-With': 'XMLHttpRequest'
							}
						});

						const result = await response.json();

						if (result.success) {
							// Save user booking information to localStorage for chatbot context
							const bookingInfo = {
								fullName: formDataObj.get('fullName'),
								email: formDataObj.get('email'),
								phone: formDataObj.get('phone'),
								currentLocation: formDataObj.get('currentLocation'),
								datePurpose: formDataObj.get('datePurpose'),
								budget: formDataObj.get('budget'),
								eventDate: formDataObj.get('eventDate'),
								eventStartTime: formDataObj.get('eventStartTime'),
								eventEndTime: formDataObj.get('eventEndTime'),
								spacePreference: formDataObj.get('spacePreference'),
								message: formDataObj.get('message'),
								referral: formDataObj.get('referral'),
								conceptId: conceptId,
								conceptName: conceptName,
								conceptPrice: conceptPrice,
								conceptImageUrl: generatedConceptImageUrl || conceptImage,
								submittedAt: new Date().toISOString()
							};
							localStorage.setItem('monamour_booking_info', JSON.stringify(bookingInfo));
							
							// Show QR code - use same format as Cart/Index.cshtml
							let qrImageUrl = '';
							
							// Try to get qrDataURL from response (like Cart/Index.cshtml)
							if (result.response && result.response.data && result.response.data.qrDataURL) {
								qrImageUrl = result.response.data.qrDataURL;
							}
							// Fallback to qrCodeBase64
							else if (result.qrCodeBase64) {
								qrImageUrl = result.qrCodeBase64;
							}
							// Fallback to qrCodeUrl
							else if (result.qrCodeUrl) {
								qrImageUrl = result.qrCodeUrl;
							}
							
							let qrHtml = '';
							if (qrImageUrl && qrImageUrl.trim() !== '') {
								qrHtml = `
									<div style="background: white; padding: 20px; border-radius: 12px; margin: 16px 0; border: 2px solid #7f1d1d; text-align: center;">
										<h4 style="color: #7f1d1d; margin-top: 0; margin-bottom: 16px; font-family: 'Prata', serif;">‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu th√†nh c√¥ng!</h4>
										<p style="margin-bottom: 16px;">Vui l√≤ng qu√©t m√£ QR ƒë·ªÉ thanh to√°n:</p>
										<img src="${qrImageUrl}" alt="QR Code" style="max-width: 300px; margin: 0 auto; display: block; border-radius: 8px;">
										<p style="margin-top: 16px; font-size: 14px; color: #666;">Sau khi thanh to√°n, ch√∫ng m√¨nh s·∫Ω li√™n h·ªá v·ªõi b·∫°n qua email ƒë·ªÉ x√°c nh·∫≠n.</p>
									</div>
								`;
							} else {
								qrHtml = `
									<div style="background: white; padding: 20px; border-radius: 12px; margin: 16px 0; border: 2px solid #7f1d1d; text-align: center;">
										<h4 style="color: #7f1d1d; margin-top: 0; margin-bottom: 16px; font-family: 'Prata', serif;">‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu th√†nh c√¥ng!</h4>
										<p style="margin-bottom: 16px; color: #e74c3c;">Kh√¥ng th·ªÉ t·∫°o m√£ QR. Vui l√≤ng ki·ªÉm tra email ƒë·ªÉ xem m√£ QR ho·∫∑c li√™n h·ªá hotline: 0868019255</p>
										<p style="margin-top: 16px; font-size: 14px; color: #666;">Ch√∫ng m√¨nh s·∫Ω li√™n h·ªá v·ªõi b·∫°n qua email ƒë·ªÉ x√°c nh·∫≠n.</p>
									</div>
								`;
							}
							
							const qrDiv = createMessageElement(qrHtml, false, true); // true = isHtmlContent, don't format
							chatBody.appendChild(qrDiv);
							chatBody.scrollTop = chatBody.scrollHeight;

							// Remove form
							formDiv.remove();
							
							// Update chatbot context with booking info
							updateChatbotContext(bookingInfo);
						} else {
							alert(result.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
							submitBtn.disabled = false;
							submitBtn.textContent = 'X√°c nh·∫≠n ƒë·∫∑t concept';
						}
					} catch (error) {
						console.error('Error:', error);
						alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.');
						submitBtn.disabled = false;
						submitBtn.textContent = 'X√°c nh·∫≠n ƒë·∫∑t concept';
					}
				});
			}
		}

		// Load user booking info from localStorage
		function loadUserBookingInfo() {
			try {
				const savedInfo = localStorage.getItem('monamour_booking_info');
				if (savedInfo) {
					userBookingInfo = JSON.parse(savedInfo);
					// Check if booking is for current concept
					if (userBookingInfo.conceptId === conceptId) {
						return userBookingInfo;
					}
				}
			} catch (error) {
				console.error('Error loading booking info:', error);
			}
			return null;
		}

		// Update chatbot context with booking info
		function updateChatbotContext(bookingInfo) {
			userBookingInfo = bookingInfo;
			// Show a message that chatbot now knows about the booking
			const contextMsg = createMessageElement(
				`‚úÖ T√¥i ƒë√£ ghi nh·∫≠n th√¥ng tin ƒë·∫∑t concept c·ªßa b·∫°n! B·∫°n c√≥ th·ªÉ h·ªèi t√¥i v·ªÅ b·∫•t c·ª© ƒëi·ªÅu g√¨ li√™n quan ƒë·∫øn booking c·ªßa m√¨nh.`,
				false
			);
			chatBody.appendChild(contextMsg);
			chatBody.scrollTop = chatBody.scrollHeight;
		}

		// Build context string for system prompt
		function buildUserContext() {
			if (!userBookingInfo) return '';
			
			let context = `\n\nTH√îNG TIN BOOKING C·ª¶A KH√ÅCH H√ÄNG:\n`;
			context += `- H·ªç t√™n: ${userBookingInfo.fullName}\n`;
			context += `- Email: ${userBookingInfo.email}\n`;
			context += `- S·ªë ƒëi·ªán tho·∫°i: ${userBookingInfo.phone}\n`;
			if (userBookingInfo.currentLocation) context += `- N∆°i s·ªëng: ${userBookingInfo.currentLocation}\n`;
			if (userBookingInfo.datePurpose) context += `- M·ª•c ƒë√≠ch: ${userBookingInfo.datePurpose}\n`;
			if (userBookingInfo.budget) context += `- Ng√¢n s√°ch: ${userBookingInfo.budget}\n`;
			if (userBookingInfo.eventDate) context += `- Ng√†y h·∫πn h√≤: ${userBookingInfo.eventDate}\n`;
			if (userBookingInfo.eventStartTime || userBookingInfo.eventEndTime) {
				context += `- Th·ªùi gian: ${userBookingInfo.eventStartTime || ''} - ${userBookingInfo.eventEndTime || ''}\n`;
			}
			if (userBookingInfo.spacePreference) context += `- Kh√¥ng gian mong mu·ªën: ${userBookingInfo.spacePreference}\n`;
			if (userBookingInfo.message) context += `- Ghi ch√∫: ${userBookingInfo.message}\n`;
			context += `- Concept ƒë√£ ch·ªçn: ${userBookingInfo.conceptName || conceptName}\n`;
			context += `- Gi√°: ${(userBookingInfo.conceptPrice || conceptPrice).toLocaleString('vi-VN')}‚Ç´\n`;
			
			context += `\nL∆ØU √ù: Khi kh√°ch h√†ng h·ªèi v·ªÅ booking, th√¥ng tin ƒë·∫∑t concept, thanh to√°n, ho·∫∑c b·∫•t k·ª≥ c√¢u h·ªèi li√™n quan ƒë·∫øn ƒë∆°n ƒë·∫∑t c·ªßa h·ªç, h√£y s·ª≠ d·ª•ng th√¥ng tin tr√™n ƒë·ªÉ tr·∫£ l·ªùi ch√≠nh x√°c v√† h·ªØu √≠ch.`;
			
			return context;
		}

		// Generate bot response
		async function generateBotResponse(userMessage) {
			// Load booking info if not loaded
			if (!userBookingInfo) {
				loadUserBookingInfo();
			}
			
			// Find best answer from training data
			const trainingAnswer = findBestAnswer(userMessage);
			
			// Build base system prompt
			let systemPrompt = trainingSystemPrompt || `B·∫°n l√† MonMon AI, tr·ª£ l√Ω th√¢n thi·ªán c·ªßa Mon Amour - d·ªãch v·ª• h·∫πn h√≤ cao c·∫•p. `;
			
			systemPrompt += `\n\nQUAN TR·ªåNG - Y√™u c·∫ßu tr·∫£ l·ªùi:
- Tr·∫£ l·ªùi NG·∫ÆN G·ªåN, TR·ªåNG T√ÇM v√†o c√¢u h·ªèi (t·ªëi ƒëa 3-4 c√¢u)
- S·ª≠ d·ª•ng xu·ªëng d√≤ng ƒë·ªÉ t√°ch c√°c √Ω ch√≠nh, d·ªÖ ƒë·ªçc h∆°n
- Th√™m emoji ph√π h·ª£p cho c√°c th√¥ng tin quan tr·ªçng (üí∞ cho gi√°, üìÖ cho ng√†y, üìû cho SƒêT, etc.)
- T·∫≠p trung v√†o c√¢u tr·∫£ l·ªùi tr·ª±c ti·∫øp, kh√¥ng d√†i d√≤ng
- N·∫øu c·∫ßn li·ªát k√™, d√πng d·∫•u g·∫°ch ƒë·∫ßu d√≤ng (‚Ä¢) ho·∫∑c s·ªë th·ª© t·ª±
- Th√¢n thi·ªán nh∆∞ng chuy√™n nghi·ªáp

B·∫°n ƒëang t∆∞ v·∫•n v·ªÅ concept "${conceptName}" v·ªõi gi√° ${conceptPrice.toLocaleString('vi-VN')}‚Ç´.`;
			
			// Add company info if available
			if (companyInfo) {
				systemPrompt += `\n\nTH√îNG TIN C√îNG TY:
- T√™n: ${companyInfo.name}
- Hotline: ${companyInfo.contact?.hotline || '0868019255'}
- Email: ${companyInfo.contact?.email || 'booking.monamour@gmail.com'}
- Website: ${companyInfo.contact?.website || 'monamour.vn'}`;
				
				// Add packages info
				if (companyInfo.packages && companyInfo.packages.length > 0) {
					systemPrompt += `\n\nC√ÅC G√ìI D·ªäCH V·ª§:`;
					for (const pkg of companyInfo.packages) {
						systemPrompt += `\n- ${pkg.name}: ${pkg.price}`;
					}
				}
			}
			
			// Add training data context if found
			if (trainingAnswer) {
				systemPrompt += `\n\nTH√îNG TIN THAM KH·∫¢O T·ª™ TRAINING DATA:
C√¢u h·ªèi t∆∞∆°ng t·ª±: "${trainingAnswer.question}"
C√¢u tr·∫£ l·ªùi tham kh·∫£o: "${trainingAnswer.answer}"
H√£y s·ª≠ d·ª•ng th√¥ng tin n√†y ƒë·ªÉ tr·∫£ l·ªùi ch√≠nh x√°c v√† chi ti·∫øt h∆°n.`;
			}
			
			// Add user booking context if available
			if (userBookingInfo && userBookingInfo.conceptId === conceptId) {
				systemPrompt += buildUserContext();
				systemPrompt += `\n\nKh√°ch h√†ng ƒë√£ ƒë·∫∑t concept n√†y. B·∫°n c√≥ th·ªÉ tr·∫£ l·ªùi c√°c c√¢u h·ªèi v·ªÅ booking c·ªßa h·ªç, th√¥ng tin ƒë√£ ƒë·∫∑t, thanh to√°n, ho·∫∑c c√°c v·∫•n ƒë·ªÅ kh√°c li√™n quan.`;
			} else {
				systemPrompt += ` N·∫øu kh√°ch h√†ng mu·ªën ƒë·∫∑t concept, h√£y g·ª£i √Ω h·ªç n√≥i "t√¥i mu·ªën ƒë·∫∑t" ho·∫∑c "ƒë·∫∑t concept".`;
			}

			chatHistory.push({
				role: "user",
				parts: [{ text: userMessage }]
			});

				const requestOptions = {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({
					contents: [{
						role: "user",
						parts: [{ text: `${systemPrompt}\n\nC√¢u h·ªèi c·ªßa kh√°ch h√†ng: ${userMessage}\n\nH√£y tr·∫£ l·ªùi NG·∫ÆN G·ªåN, TR·ªåNG T√ÇM v√†o c√¢u h·ªèi tr√™n. S·ª≠ d·ª•ng xu·ªëng d√≤ng ƒë·ªÉ t√°ch c√°c √Ω ch√≠nh.` }]
					}]
				})
			};

			try {
				const response = await fetch(API_URL, requestOptions);
				const data = await response.json();
				
				if (!response.ok) throw new Error(data.error?.message || "C√≥ l·ªói x·∫£y ra");

				let apiResponseText = data.candidates[0].content.parts[0].text.trim();
				
				// Remove markdown formatting
				apiResponseText = apiResponseText.replace(/\*\*(.*?)\*\*/g, "$1");
				apiResponseText = apiResponseText.replace(/\*(.*?)\*/g, "$1");
				
				chatHistory.push({
					role: "model",
					parts: [{ text: apiResponseText }]
				});

				return apiResponseText;
			} catch (error) {
				console.error('Chatbot Error:', error);
				return 'Xin l·ªói, c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau ho·∫∑c li√™n h·ªá hotline: 0868019255';
			}
		}

		// Handle message send
		async function handleSendMessage(e) {
			e.preventDefault();
			const userMessage = messageInput.value.trim();
			if (!userMessage) return;

			// Add user message
			const userMsgDiv = createMessageElement(userMessage, true);
			chatBody.appendChild(userMsgDiv);
			chatBody.scrollTop = chatBody.scrollHeight;

			messageInput.value = '';
			messageInput.style.height = 'auto';

			// Check if user wants to generate image
			if (isImageGenerationRequest(userMessage)) {
				// Extract the prompt from user message (remove keywords)
				const imageKeywords = ['t·∫°o ·∫£nh', 't·∫°o h√¨nh', 'v·∫Ω ·∫£nh', 'v·∫Ω h√¨nh', 't·∫°o h√¨nh ·∫£nh', 'sinh ·∫£nh', 'generate image', 'create image', 't·∫°o cho t√¥i ·∫£nh', 't·∫°o concept', 'cho t√¥i xem', 'visualize', 'h√¨nh dung', 't·∫°o l·∫°i', 't·∫°o m·ªõi'];
				let customPrompt = userMessage;
				for (const keyword of imageKeywords) {
					customPrompt = customPrompt.replace(new RegExp(keyword, 'gi'), '').trim();
				}
				// If no custom prompt, use the full message
				if (!customPrompt || customPrompt.length < 3) {
					customPrompt = userMessage;
				}
				
				// Generate new image with custom prompt
				await generateConceptImage(customPrompt);
				return;
			}

			// Check if user explicitly requests to fill contact form
			if (isBookingFormRequest(userMessage) && !selectedConcept) {
				showBookingForm();
				return;
			}

			// Show thinking indicator
			const thinkingDiv = createMessageElement('<div style="display: flex; gap: 4px;"><div style="width: 8px; height: 8px; background: #999; border-radius: 50%; animation: pulse 1s infinite;"></div><div style="width: 8px; height: 8px; background: #999; border-radius: 50%; animation: pulse 1s infinite 0.2s;"></div><div style="width: 8px; height: 8px; background: #999; border-radius: 50%; animation: pulse 1s infinite 0.4s;"></div></div>', false);
			chatBody.appendChild(thinkingDiv);
			chatBody.scrollTop = chatBody.scrollHeight;

			// Generate response
			const botResponse = await generateBotResponse(userMessage);
			
			// Remove thinking indicator
			thinkingDiv.remove();

			// Add bot response
			const botMsgDiv = createMessageElement(botResponse, false);
			chatBody.appendChild(botMsgDiv);
			chatBody.scrollTop = chatBody.scrollHeight;
		}

		// Event listeners
		chatForm.addEventListener('submit', handleSendMessage);
		
		messageInput.addEventListener('keydown', (e) => {
			if (e.key === 'Enter' && !e.shiftKey) {
				e.preventDefault();
				handleSendMessage(e);
			}
		});

		messageInput.addEventListener('input', () => {
			messageInput.style.height = 'auto';
			messageInput.style.height = messageInput.scrollHeight + 'px';
		});

		// Initialize
		// Load training data and user booking info on page load
		(async () => {
			await loadTrainingData();
			loadUserBookingInfo();
			addWelcomeMessage();
		})();

		// Add CSS for pulse animation
		const style = document.createElement('style');
		style.textContent = `
			@@keyframes pulse {
				0%, 100% { opacity: 0.4; }
				50% { opacity: 1; }
			}
		`;
		document.head.appendChild(style);
	})();
</script>
